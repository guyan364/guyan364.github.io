<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="麻将 首先做一个转化 设 \(p_i\) 表示抽 \(i\) 张牌恰好胡的概率">
<meta property="og:type" content="article">
<meta property="og:title" content="[ZJOI2019] 简要题解">
<meta property="og:url" content="http://yoursite.com/2020/03/28/Solutions/[ZJOI2019]%20%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/index.html">
<meta property="og:site_name" content="Guyan&#39;s blog">
<meta property="og:description" content="麻将 首先做一个转化 设 \(p_i\) 表示抽 \(i\) 张牌恰好胡的概率">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/tree.jpg">
<meta property="article:published_time" content="2020-03-28T02:01:00.000Z">
<meta property="article:modified_time" content="2020-04-01T12:42:28.522Z">
<meta property="article:author" content="Guyan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/tree.jpg">

<link rel="canonical" href="http://yoursite.com/2020/03/28/Solutions/[ZJOI2019]%20%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>[ZJOI2019] 简要题解 | Guyan's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Guyan's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/28/Solutions/[ZJOI2019]%20%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guyan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guyan's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [ZJOI2019] 简要题解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-28 10:01:00" itemprop="dateCreated datePublished" datetime="2020-03-28T10:01:00+08:00">2020-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-01 20:42:28" itemprop="dateModified" datetime="2020-04-01T20:42:28+08:00">2020-04-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="麻将"><a href="https://loj.ac/problem/3042" target="_blank" rel="noopener">麻将</a></h3>
<p>首先做一个转化</p>
<p>设 <span class="math inline">\(p_i\)</span> 表示抽 <span class="math inline">\(i\)</span> 张牌恰好胡的概率</p>
<a id="more"></a>
<p><span class="math display">\[
E(x) = \sum_{i} p_i \cdot i
\]</span></p>
<p>设 <span class="math inline">\(q_i\)</span> 表示抽 <span class="math inline">\(i\)</span> 张牌还不能胡的概率</p>
<p>于是有</p>
<p><span class="math display">\[
\begin{aligned}
q_i &amp;= 1 - \sum_{j\leq i} p_j \\
\sum_{j\leq i}p_j &amp;= 1 - q_i \\ 
p_i = ( 1 - q_i ) -&amp; ( 1 - q_{ i - 1 } ) = q_{i-1} - q_i \\
E(x) = \sum_{i}(&amp;q_{i-1} - q_i)i =\sum_{i} q_i
\end{aligned}
\]</span></p>
<p>于是设 <span class="math inline">\(f[i][j][s]\)</span> , 表示考虑到第 <span class="math inline">\(i\)</span> 种牌 , 总共抽到 <span class="math inline">\(j\)</span> 张牌 , 当前牌的状态为 <span class="math inline">\(s\)</span> 的方案数</p>
<p>对于 <span class="math inline">\(s\)</span> , 只关心是否为胡牌的状态</p>
<p>这里就要用到 DP 套 DP 了</p>
<p>这类题往往是外层一个计数 DP , 里层套一个判定 DP</p>
<p>对于第一个条件 , 可以用 DP 解决</p>
<p>设 <span class="math inline">\(g[i][j][k](j\leq 2 , k \leq 2)\)</span> , 表示考虑到第 <span class="math inline">\(i\)</span> 种牌 , 有 <span class="math inline">\((i - 1,i,i+1)\)</span> 的面子 <span class="math inline">\(j\)</span> 组 , <span class="math inline">\((i,i+1,i+2)\)</span> 的面子 <span class="math inline">\(k\)</span> 组时 , 最多有几个已经凑成的面子 , 发现 <span class="math inline">\(g\)</span> 的第一维与 <span class="math inline">\(f\)</span> 的第一维一样 , 于是就可以将 <span class="math inline">\(g[j][k]\)</span> 及其结果作为状态压入外层 <span class="math inline">\(f\)</span> 的 DP</p>
<p>对于第二个条件 , 直接多记录一个对子个数即可</p>
<p><strong>打表发现 (?</strong> , 有用的 <span class="math inline">\(s\)</span> 只有不到 <span class="math inline">\(4000\)</span> 个 , 于是就可以 DP 了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e2</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">4e2</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> S = <span class="number">4e3</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">998244353</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">chkmx</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">if</span>( a &lt; b ) a = b; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod;</span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod;</span><br><span class="line">    k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">State</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> f[<span class="number">3</span>][<span class="number">3</span>];</span><br><span class="line">  State() &#123; <span class="built_in">memset</span>( f , <span class="number">-1</span> , <span class="keyword">sizeof</span> f ); &#125;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; ( <span class="keyword">const</span> State &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">3</span> ; ++i )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; <span class="number">3</span> ; ++j )</span><br><span class="line">        <span class="keyword">if</span>( f[i][j] ^ rhs.f[i][j] ) </span><br><span class="line">          <span class="keyword">return</span> f[i][j] &lt; rhs.f[i][j];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span> != ( <span class="keyword">const</span> State &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">3</span> ; ++i )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; <span class="number">3</span> ; ++j )</span><br><span class="line">        <span class="keyword">if</span>( f[i][j] ^ rhs.f[i][j] ) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  State <span class="keyword">operator</span> + ( <span class="keyword">const</span> State &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    State res;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">3</span> ; ++i )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; <span class="number">3</span> ; ++j )</span><br><span class="line">        res.f[i][j] = max( f[i][j] , rhs.f[i][j] );</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">  State <span class="keyword">operator</span> + ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    State res;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">3</span> ; ++i )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; <span class="number">3</span> &amp;&amp; i + j &lt;= rhs ; ++j )</span><br><span class="line">        <span class="keyword">if</span>( ~f[i][j] )</span><br><span class="line">          <span class="keyword">for</span>( <span class="keyword">int</span> k = <span class="number">0</span> ; k &lt; <span class="number">3</span> &amp;&amp; i + j + k &lt;= rhs ; ++k )</span><br><span class="line">            chkmx( res.f[j][k] , min( f[i][j] + i + ( rhs - i - j - k ) / <span class="number">3</span> , <span class="number">4</span> ) );</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Status</span> &#123;</span></span><br><span class="line">  State a , b;</span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  Status() &#123;&#125;</span><br><span class="line">  Status( State _a , State _b , <span class="keyword">int</span> _num ):a( _a ) , b( _b ) , num( _num ) &#123;&#125;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; ( <span class="keyword">const</span> Status &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( a != rhs.a ) <span class="keyword">return</span> a &lt; rhs.a;</span><br><span class="line">    <span class="keyword">if</span>( b != rhs.b ) <span class="keyword">return</span> b &lt; rhs.b;</span><br><span class="line">    <span class="keyword">return</span> num &lt; rhs.num;</span><br><span class="line">  &#125;</span><br><span class="line">  Status <span class="keyword">operator</span> + ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( rhs &gt;= <span class="number">2</span> ) <span class="keyword">return</span> Status( a + rhs , ( a + ( rhs - <span class="number">2</span> ) ) + ( b + rhs ) , min( num + <span class="number">1</span> , <span class="number">7</span> ) );</span><br><span class="line">    <span class="keyword">return</span> Status( a + rhs , b + rhs , num );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">chk</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>( num &gt; <span class="number">6</span> ) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">3</span> ; ++i )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; <span class="number">3</span> ; ++j )</span><br><span class="line">        <span class="keyword">if</span>( b.f[i][j] &gt; <span class="number">3</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; u , s[S] , v;</span><br><span class="line"></span><br><span class="line"><span class="built_in">map</span>&lt;Status,<span class="keyword">int</span>&gt; mp;</span><br><span class="line"><span class="keyword">bool</span> mark[S]; <span class="keyword">int</span> sidx , trs[S][<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_status</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  u.a.f[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  mp[u] = <span class="number">1</span>;</span><br><span class="line">  s[sidx = <span class="number">1</span>] = u;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= sidx ; ++i ) &#123;</span><br><span class="line">    u = s[i];</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt;= <span class="number">4</span> ; ++j ) &#123;</span><br><span class="line">      v = u + j;</span><br><span class="line">      <span class="keyword">if</span>( !mp.count( v ) ) &#123;</span><br><span class="line">        mp[v] = ++sidx;</span><br><span class="line">        s[sidx] = v;</span><br><span class="line">      &#125;</span><br><span class="line">      trs[i][j] = mp[v];</span><br><span class="line">    &#125;</span><br><span class="line">    mark[i] = u.chk();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> C[<span class="number">5</span>][<span class="number">5</span>] , f[N][M][S] , bac[N] , n;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  init_status();</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;n);</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , x , t ; i &lt; <span class="number">14</span> ; ++i )</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;x,&amp;t) , ++bac[x - <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= <span class="number">4</span> ; ++i ) &#123;</span><br><span class="line">    C[i][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= i ; ++j )</span><br><span class="line">      C[i][j] = C[i - <span class="number">1</span>][j] + C[i - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  f[<span class="number">0</span>][<span class="number">0</span>][<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; ++i ) </span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> , lj = i * <span class="number">4</span> ; j &lt;= lj ; ++j )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> s = <span class="number">1</span> ; s &lt;= sidx ; ++s )</span><br><span class="line">        <span class="keyword">if</span>( f[i][j][s] )</span><br><span class="line">          <span class="keyword">for</span>( <span class="keyword">int</span> k = bac[i] ; k &lt;= <span class="number">4</span> ; ++k ) </span><br><span class="line">            inc( f[i + <span class="number">1</span>][j + k][trs[s][k]] , <span class="number">1L</span>L * f[i][j][s] * C[<span class="number">4</span>-bac[i]][k-bac[i]] % mod );</span><br><span class="line">  <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">13</span> , li = n * <span class="number">4</span> , A , B ; i &lt;= li ; ++i ) &#123;</span><br><span class="line">    A = B = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= sidx ; ++j ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( !mark[j] ) inc( A , f[n][i][j] );</span><br><span class="line">      inc( B , f[n][i][j] );</span><br><span class="line">    &#125;</span><br><span class="line">    inc( ans , <span class="number">1L</span>L * A * fpow( B , mod - <span class="number">2</span> ) % mod );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; ans;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线段树"><a href="https://loj.ac/problem/3043" target="_blank" rel="noopener">线段树</a></h3>
<p>每次有 <span class="math inline">\(\frac{1}{2}\)</span> 的概率执行操作 , 可以求出期望的权值</p>
<p>由于期望的可加性 , 可以分别求出每个节点期望值求和</p>
<p>于是只用维护一颗线段树 , 不过需要一点分析</p>
<p>以 <span class="math inline">\([1,5]\)</span> 的线段树为例</p>
<p>假设现在进行 <span class="math inline">\([3,4]\)</span> 的操作 , 有四类不同的点</p>
<p><img src="/images/tree.jpg" /></p>
<p>其中红点是经过的点 , 有 Pushdown 操作 , 黄点是最终到达的目标节点</p>
<p>蓝点是有可能被 Pushdown 操作影响的点 , 其他为灰点</p>
<p>现在设 <span class="math inline">\(f[i]\)</span> 表示节点的期望值</p>
<p>对于红点 , 有 <span class="math inline">\(f[i] = f[i] / 2\)</span> , 因为有 <span class="math inline">\(\frac{1}{2}\)</span> 的概率 Pushdown</p>
<p>对于黄点 , 有 <span class="math inline">\(f[i] = ( f[i] + 1 ) / 2\)</span></p>
<p>然而对于蓝点就有点棘手了</p>
<p>蓝点的值与其到根的节点上有没有节点有值相关</p>
<p>于是设 <span class="math inline">\(df[i]\)</span> 表示从 <span class="math inline">\(i\)</span> 到根的路径上至少有一个节点值为一的概率</p>
<p>于是对于蓝点有 <span class="math inline">\(f[i] = ( f[i] + df[i] ) / 2\)</span></p>
<p>然后考虑每次操作对于 <span class="math inline">\(df[i]\)</span> 的影响</p>
<p>对于红点 <span class="math inline">\(df[i] = df[i]/2\)</span></p>
<p>蓝点没有变化 , 于是其子树的点也没有变化</p>
<p>对于黄点及其子树有 <span class="math inline">\(df[i] = ( df[i] + 1 ) / 2\)</span></p>
<p>不过子树那么多点 , 不能逐一修改 , 于是需要用上线段树的懒标记</p>
<p>注意到一次修改是 <span class="math inline">\(x = ( x + 1 ) / 2\)</span></p>
<p>两次修改就是 <span class="math inline">\(x = ( ( x + 1 ) / 2 + 1 ) / 2\)</span></p>
<p>推推式子 , <span class="math inline">\(n\)</span> 次修改就是 <span class="math display">\[
x = \frac{x}{2^n} + \sum_{i=1}^n \frac{1}{2^i} = \frac{x+\sum_{i=0}^{n-1}2^i}{2^n} =\frac{x + 2^n - 1}{2^n}
\]</span> 于是一个 <span class="math inline">\(lazytag\)</span> 就可以了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">998244353</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> inv2 = ( mod + <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">return</span> a + b &gt;= mod ? a + b - mod : a + b; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">return</span> a - b &lt; <span class="number">0</span> ? a - b + mod : a - b; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">if</span>( ( a += b ) &gt;= mod ) a -= mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">if</span>( ( a -= b ) &lt; <span class="number">0</span> ) a += mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod;</span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> Pow2[N] , inv[N] , tag[N &lt;&lt; <span class="number">2</span>] , S1[N] , tp1 , S2[N] , tp2 , S3[N] , tp3 , f[N &lt;&lt; <span class="number">2</span>] , df[N &lt;&lt; <span class="number">2</span>] , ans;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , m , now;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dn</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( !tag[u] ) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">int</span> ls = u &lt;&lt; <span class="number">1</span> , rs = u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , k = tag[u];</span><br><span class="line">  df[ls] = <span class="number">1L</span>L * mns( pls( df[ls] , Pow2[k] ) , <span class="number">1</span> ) * fpow( Pow2[k] , mod - <span class="number">2</span> ) % mod;</span><br><span class="line">  df[rs] = <span class="number">1L</span>L * mns( pls( df[rs] , Pow2[k] ) , <span class="number">1</span> ) * fpow( Pow2[k] , mod - <span class="number">2</span> ) % mod;</span><br><span class="line">  tag[ls] += tag[u] , tag[rs] += tag[u];</span><br><span class="line">  tag[u] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mdf</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> L , <span class="keyword">int</span> R )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( l &gt; R || r &lt; L ) &#123;</span><br><span class="line">    S2[++tp2] = u;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>( l &gt;= L &amp;&amp; r &lt;= R ) &#123;</span><br><span class="line">    S3[++tp3] = u;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  S1[++tp1] = u; dn( u );</span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>; </span><br><span class="line">  mdf( l , mid , u &lt;&lt; <span class="number">1</span> , L , R );</span><br><span class="line">  mdf( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , L , R );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MDF</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r )</span> </span>&#123;</span><br><span class="line">  tp1 = tp2 = tp3 = <span class="number">0</span>;</span><br><span class="line">  mdf( <span class="number">1</span> , n , <span class="number">1</span> , l , r );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u ; i &lt;= tp1 ; ++i ) &#123;</span><br><span class="line">    u = S1[i];</span><br><span class="line">    dec( ans , f[u] );</span><br><span class="line">    f[u] = <span class="number">1L</span>L * inv2 * f[u] % mod;</span><br><span class="line">    inc( ans , f[u] );</span><br><span class="line">    df[S1[i]] = <span class="number">1L</span>L * df[S1[i]] * inv2 % mod;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u ; i &lt;= tp2 ; ++i ) &#123;</span><br><span class="line">    u = S2[i];</span><br><span class="line">    dec( ans , f[u] );</span><br><span class="line">    f[u] = <span class="number">1L</span>L * inv2 * pls( f[u] , df[u] ) % mod;</span><br><span class="line">    inc( ans , f[u] );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u ; i &lt;= tp3 ; ++i ) &#123;</span><br><span class="line">    u = S3[i];</span><br><span class="line">    dec( ans , f[u] );</span><br><span class="line">    f[u] = <span class="number">1L</span>L * ( f[u] + <span class="number">1</span> ) * inv2 % mod;</span><br><span class="line">    inc( ans , f[u] ) , ++tag[u];</span><br><span class="line">    df[S3[i]] = <span class="number">1L</span>L * pls( df[S3[i]] , <span class="number">1</span> ) * inv2 % mod;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;n,&amp;m);</span><br><span class="line">  Pow2[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , t = n + m ; i &lt;= t ; ++i ) Pow2[i] = pls( Pow2[i - <span class="number">1</span>] , Pow2[i - <span class="number">1</span>] );</span><br><span class="line">  <span class="keyword">int</span> opt , l , r;</span><br><span class="line">  <span class="keyword">while</span>( m-- ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;opt);</span><br><span class="line">    <span class="keyword">if</span>( opt == <span class="number">2</span> ) <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>,<span class="number">1L</span>L*Pow2[now]*ans%mod);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;l,&amp;r);</span><br><span class="line">      MDF( l , r );</span><br><span class="line">      ++now;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="minimax-搜索"><a href="https://loj.ac/problem/3044" target="_blank" rel="noopener">Minimax 搜索</a></h3>
<p>动态 DP</p>
<p>想要求出花费恰好为 <span class="math inline">\(k\)</span> 的方案数 , 可以求出花费小于等于 <span class="math inline">\(k\)</span> 的方案数 , 最后差分一下</p>
<p>先求出什么都不改变时 , 根的权值 <span class="math inline">\(W\)</span></p>
<p>想让根的权值改变 , 肯定是改成 <span class="math inline">\(W-1\)</span> 或 <span class="math inline">\(W+1\)</span> 最合算 , 花费最小</p>
<p>那么就让所有选中的点变成 <span class="math inline">\(W-1\)</span> 或 <span class="math inline">\(W+1\)</span> 就可以了</p>
<p>不过这两个改变方向不能同时计算</p>
<p>于是算出将所有权值小于等于 <span class="math inline">\(W + k -1\)</span> 的叶子变成 <span class="math inline">\(W-1\)</span> , 选出的集合不能改变根权值的概率 <span class="math inline">\(p\)</span></p>
<p>将所有权值大于等于 <span class="math inline">\(W+k-1\)</span> 的叶子变成 <span class="math inline">\(W+1\)</span> , 选出的集合不能改变根权值的概率 <span class="math inline">\(q\)</span></p>
<p>于是方案数就是总数乘上 <span class="math inline">\(( 1 - p \cdot q)\)</span></p>
<p><span class="math inline">\(W-1\)</span> 与 <span class="math inline">\(W+1\)</span> 类似 , 下面以 <span class="math inline">\(W-1\)</span> 为例</p>
<p>设 <span class="math inline">\(f_i\)</span> 表示点 <span class="math inline">\(i\)</span> 的权值小于 <span class="math inline">\(W\)</span> 的概率</p>
<p>于是对于编号小于 <span class="math inline">\(W\)</span> 的叶子节点 <span class="math inline">\(f_i = 1\)</span></p>
<p>对于编号小于 <span class="math inline">\(W+k-1\)</span> 的叶子节点 <span class="math inline">\(f_i = \frac{1}{2}\)</span> , 因为有选与不选两种方案</p>
<p>考虑转移 <span class="math display">\[
\begin{cases}
f_i = \prod_{j\in son_i}f_j , dep[i] \bmod 2 = 1 \\
f_i = \left( 1 - \prod_{j \in son_i}( 1 - f_j ) \right)  ,dep[i] \bmod 2 = 0
\end{cases}
\]</span> 做个转化 <span class="math display">\[
g_i = \begin{cases} 
f_i , dep[i] \bmod 2 = 0 \\
1 - f_i , dep[i] \bmod 2 = 1
\end{cases}
\]</span> 于是有转移 <span class="math display">\[
g_i = \prod_{j\in son_i} ( 1 - g_j )
\]</span> 此时就与奇数偶数层没有关系了</p>
<p>然后对于 <span class="math inline">\(W+1\)</span></p>
<p>设 <span class="math inline">\(f_i\)</span> 表示点 <span class="math inline">\(i\)</span> 的权值小于等于 <span class="math inline">\(W\)</span> 的概率</p>
<p>编号小于等于 <span class="math inline">\(W\)</span> 的叶子节点 <span class="math inline">\(f_i = 1\)</span> ,</p>
<p>编号大于等于 <span class="math inline">\(W-k+1\)</span> 的叶子节点 <span class="math inline">\(f_i = \frac{1}{2}\)</span></p>
<p>枚举 <span class="math inline">\(k\)</span> , 每次只需改变一个节点的权值 , 就可以动态 DP 了</p>
<p>不过要注意 , 在保存轻儿子的 DP 值时 , 有乘 <span class="math inline">\(0\)</span> , 除以 <span class="math inline">\(0\)</span> 的操作</p>
<p>需要另外保存乘 <span class="math inline">\(0\)</span> 的个数 , 封装一个新的整数类</p>
<p>注意以下代码实现时 , 去除了权值为 <span class="math inline">\(W\)</span> 的叶子节点的影响 , 所以集合大小是叶子结点数减一</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">998244353</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> inv2 = ( mod + <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod;</span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125; <span class="keyword">int</span> _w;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">inv</span><span class="params">( <span class="keyword">const</span> <span class="keyword">int</span> &amp; x )</span> </span>&#123; <span class="keyword">return</span> fpow( x , mod - <span class="number">2</span> ); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> head[N] , eidx;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[N &lt;&lt; <span class="number">1</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[v] , u &#125;; head[v] = eidx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Int</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> x , y;</span><br><span class="line">  Int() &#123; x = y = <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> = ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !rhs ) x = y = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> x = rhs , y = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">operator</span> <span class="title">int</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> y ? <span class="number">0</span> : x; &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> *= ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !rhs ) ++y;</span><br><span class="line">    <span class="keyword">else</span> x = <span class="number">1L</span>L * x * rhs % mod;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> /= ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !rhs ) --y;</span><br><span class="line">    <span class="keyword">else</span> x = <span class="number">1L</span>L * x * inv( rhs ) % mod;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; f[N] , g[N];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> x , y;</span><br><span class="line">  node()&#123;&#125;</span><br><span class="line">  node( <span class="keyword">int</span> _x , <span class="keyword">int</span> _y ):x( _x ) , y( _y ) &#123;&#125;</span><br><span class="line">  node <span class="keyword">operator</span> * ( <span class="keyword">const</span> node &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node( <span class="number">1L</span>L * x * rhs.x % mod , ( <span class="number">1L</span>L * x * rhs.y + y ) % mod );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> y; &#125;</span><br><span class="line">&#125; val[N][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> son[N][<span class="number">2</span>] , p[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  val[u][<span class="number">0</span>] = node( mns( <span class="number">0</span> , f[u] ) , f[u] );</span><br><span class="line">  val[u][<span class="number">1</span>] = node( mns( <span class="number">0</span> , g[u] ) , g[u] );</span><br><span class="line">  <span class="keyword">if</span>( son[u][<span class="number">0</span>] ) &#123;</span><br><span class="line">    val[u][<span class="number">0</span>] = val[son[u][<span class="number">0</span>]][<span class="number">0</span>] * val[u][<span class="number">0</span>];</span><br><span class="line">    val[u][<span class="number">1</span>] = val[son[u][<span class="number">0</span>]][<span class="number">1</span>] * val[u][<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>( son[u][<span class="number">1</span>] ) &#123;</span><br><span class="line">    val[u][<span class="number">0</span>] = val[u][<span class="number">0</span>] * val[son[u][<span class="number">1</span>]][<span class="number">0</span>];</span><br><span class="line">    val[u][<span class="number">1</span>] = val[u][<span class="number">1</span>] * val[son[u][<span class="number">1</span>]][<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">which</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123; <span class="keyword">return</span> p[x] ? x == son[p[x]][<span class="number">1</span>] : <span class="number">0</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">noroot</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123; <span class="keyword">return</span> p[x] ? x == son[p[x]][<span class="number">0</span>] || x == son[p[x]][<span class="number">1</span>] : <span class="number">0</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> f , w; f = p[u] , w = which( u );</span><br><span class="line">  p[u] = p[f]; <span class="keyword">if</span>( noroot( f ) ) son[p[f]][which( f )] = u; </span><br><span class="line">  <span class="keyword">if</span>( ( son[f][w] = son[u][w ^ <span class="number">1</span>] ) ) p[son[u][w ^ <span class="number">1</span>]] = f;</span><br><span class="line">  son[p[f] = u][w ^ <span class="number">1</span>] = f; up( f );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> f;</span><br><span class="line">  <span class="keyword">while</span>( noroot( u ) ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( noroot( f = p[u] ) ) rotate( which( f ) ^ which( u ) ? u : f );</span><br><span class="line">    rotate( u );</span><br><span class="line">  &#125; up( u );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123; </span><br><span class="line">  f[u] *= mns( <span class="number">1</span> , val[v][<span class="number">0</span>] );</span><br><span class="line">  g[u] *= mns( <span class="number">1</span> , val[v][<span class="number">1</span>] );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  f[u] /= mns( <span class="number">1</span> , val[v][<span class="number">0</span>] );</span><br><span class="line">  g[u] /= mns( <span class="number">1</span> , val[v][<span class="number">1</span>] );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">access</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> t = <span class="number">0</span> ; x ; t = x , x = p[x] ) &#123;</span><br><span class="line">    splay( x );</span><br><span class="line">    <span class="keyword">if</span>( son[x][<span class="number">1</span>] ) add( x , son[x][<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">if</span>( t ) del( x , t );</span><br><span class="line">    son[x][<span class="number">1</span>] = t;</span><br><span class="line">    up( x );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> dep[N] , w[N] , lf[N] , W , nlf;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> flag = <span class="number">1</span>;</span><br><span class="line">  w[u] = ( dep[u] &amp; <span class="number">1</span> ) ? -INF : INF;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != p[u] ) &#123;</span><br><span class="line">      p[v] = u; flag = <span class="number">0</span>;</span><br><span class="line">      dep[v] = dep[u] + <span class="number">1</span>;</span><br><span class="line">      dfs( v );</span><br><span class="line">      <span class="keyword">if</span>( dep[u] &amp; <span class="number">1</span> ) </span><br><span class="line">        w[u] = max( w[u] , w[v] );</span><br><span class="line">      <span class="keyword">else</span> w[u] = min( w[u] , w[v] );</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span>( flag ) w[u] = u , lf[u] = <span class="number">1</span> , ++nlf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">redfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( lf[u] ) &#123;</span><br><span class="line">    f[u] = u &lt; W;</span><br><span class="line">    g[u] = <span class="number">1</span> - ( u &gt; W );</span><br><span class="line">    <span class="keyword">if</span>( ~dep[u] &amp; <span class="number">1</span> )</span><br><span class="line">      f[u] = mns( <span class="number">1</span> , f[u] ) , g[u] = mns( <span class="number">1</span> , g[u] );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> f[u] = <span class="number">1</span> , g[u] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != p[u] ) &#123;</span><br><span class="line">      redfs( v );</span><br><span class="line">      f[u] *= ( <span class="number">1</span> - f[v] );</span><br><span class="line">      g[u] *= ( <span class="number">1</span> - g[v] );</span><br><span class="line">    &#125;</span><br><span class="line">  up( u );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , L , R , ans[N] , S;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  dep[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>,&amp;n,&amp;L,&amp;R);</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u , v ; i &lt; n ; ++i ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;u,&amp;v);</span><br><span class="line">    addedge( u , v );</span><br><span class="line">  &#125;</span><br><span class="line">  dfs( <span class="number">1</span> ); W = w[<span class="number">1</span>];</span><br><span class="line">  redfs( <span class="number">1</span> );</span><br><span class="line">  S = fpow( <span class="number">2</span> , nlf - <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , x ; i &lt; n ; ++i ) &#123;</span><br><span class="line">    x = W + i - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>( x &gt; W &amp;&amp; x &lt;= n &amp;&amp; lf[x] ) &#123;</span><br><span class="line">      access( x );</span><br><span class="line">      splay( x );</span><br><span class="line">      f[x] = inv2;</span><br><span class="line">      <span class="keyword">if</span>( ~dep[x] &amp; <span class="number">1</span> )</span><br><span class="line">        f[x] = mns( <span class="number">1</span> , f[x] );</span><br><span class="line">      up( x );</span><br><span class="line">    &#125;</span><br><span class="line">    x = W - i + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>( x &lt; W &amp;&amp; x &gt; <span class="number">0</span> &amp;&amp; lf[x] ) &#123;</span><br><span class="line">      access( x );</span><br><span class="line">      splay( x );</span><br><span class="line">      g[x] = inv2;</span><br><span class="line">      <span class="keyword">if</span>( ~dep[x] &amp; <span class="number">1</span> )</span><br><span class="line">        g[x] = mns( <span class="number">1</span> , g[x] );</span><br><span class="line">      up( x );</span><br><span class="line">    &#125;</span><br><span class="line">    access( <span class="number">1</span> );</span><br><span class="line">    splay( <span class="number">1</span> );</span><br><span class="line">    ans[i] = <span class="number">1L</span>L * S * mns( <span class="number">2</span> , <span class="number">1L</span>L * mns( <span class="number">1</span> , val[<span class="number">1</span>][<span class="number">0</span>] ) * val[<span class="number">1</span>][<span class="number">1</span>] % mod ) % mod;</span><br><span class="line">  &#125; ans[n] = mns( pls( S , S ) , <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = L ; i &lt;= R ; ++i )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d "</span>,mns( ans[i] ,ans[i - <span class="number">1</span>] ) );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="开关"><a href="https://loj.ac/problem/3045" target="_blank" rel="noopener">开关</a></h3>
<p>概率生成函数</p>
<p>概率生成函数第 <span class="math inline">\(i\)</span> 项 , 表示 <span class="math inline">\(x\)</span> 取 <span class="math inline">\(i\)</span> 时的概率</p>
<p>设概率生成函数为 <span class="math inline">\(P(x)\)</span> , 于是有 <span class="math inline">\(E(x) = P&#39;(1)\)</span></p>
<p>对于这道题</p>
<p>第 <span class="math inline">\(k\)</span> 个开关操作 <span class="math inline">\(i\)</span> 次到达末状态的指数生成函数是 <span class="math display">\[
F_k(x)= \frac{e^{p_kx} + (-1)^{s_k}e^{-p_kx}}{2} \\
F(x) = \prod_{k=1}^n F_k(x)
\]</span> 第 <span class="math inline">\(k\)</span> 个开关操作 <span class="math inline">\(i\)</span> 次回到原状态的指数生成函数是 <span class="math display">\[
G_k(x) = \frac{e^{p_kx} + e^{-p_kx}}{2} \\
G(x) = \prod_{k=1}^n G_k(x)
\]</span> 设 <span class="math inline">\(F(x)\)</span> 转为 OGF 后是 <span class="math inline">\(f(x)\)</span> , <span class="math inline">\(G(x)\)</span> 转为 OGF 后是 <span class="math inline">\(g(x)\)</span> <span class="math display">\[
Ans = (\frac{f(1)}{g(1)})&#39; = \frac{f&#39;(1)g(1) - g&#39;(1)f(1)}{g^2(1)}
\]</span> 接下来的问题是 EOF 转 OGF</p>
<p>考虑 <span class="math inline">\(a_ie^{ix}\)</span> <span class="math display">\[
a_ie^{ix} = a_i \sum_j i^j \frac{x^j}{j!} \\
a_i\sum_{j} i^j = a_i \frac{1}{1-i}
\]</span> 发现 <span class="math inline">\(P=\sum p \leq 2000\)</span> , 可以直接记录 <span class="math inline">\(e^{\frac{i}{P}}\)</span> 的系数</p>
<p>不过有个问题 , <span class="math inline">\(\frac{1}{1-x}\)</span> 在 <span class="math inline">\(1\)</span> 处没有定义 , 可以上下同时乘上 <span class="math inline">\(\prod_{i=-p}^i \left(1 - \frac{i}{p}x\right)\)</span></p>
<p>接下来就是推式子时间 <span class="math display">\[
\begin{aligned}
f( 1 ) = \sum_{i=-P}^Pa_i \prod_{j\neq i}(1-\frac{j}{p}) &amp;= a_P \prod_{j\neq P}(1-\frac{j}{P}) \\
f&#39;(1) = \sum_{i=-P}^Pa_i \sum_{j \neq i}-\frac{j}{P}\prod_{k\neq i , k\neq j}(1-&amp;\frac{k}{P}) =\sum_{i=P \vee j =P} -\frac{a_ij}{P}\prod_{k\neq i , k \neq j}( 1 - \frac{k}{P})
\end{aligned}
\]</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">5e4</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">998244353</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> inv2 = ( mod + <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod;</span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125; <span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , p , s[N] , fPool[N &lt;&lt; <span class="number">1</span>] , gPool[N &lt;&lt; <span class="number">1</span>] , *f = fPool + N , *g = gPool + N , hPool[N &lt;&lt; <span class="number">1</span>] , *h = hPool + N;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;n);</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,s+i);</span><br><span class="line">  f[<span class="number">0</span>] = g[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , x ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;x);</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = -p ; j &lt;= p ; ++j ) inc( h[j + x] , <span class="number">1L</span>L * inv2 * f[j] % mod );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = -p ; j &lt;= p ; ++j ) inc( h[j - x] , <span class="number">1L</span>L * ( s[i] ? mod - inv2 : inv2 ) * f[j] % mod );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = -p - x ; j &lt;= p + x ; ++j ) &#123; f[j] = h[j]; h[j] = <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = -p ; j &lt;= p ; ++j ) inc( h[j + x] , <span class="number">1L</span>L * inv2 * g[j] % mod );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = -p ; j &lt;= p ; ++j ) inc( h[j - x] , <span class="number">1L</span>L * inv2 * g[j] % mod );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = -p - x ; j &lt;= p + x ; ++j ) &#123; g[j] = h[j]; h[j] = <span class="number">0</span>; &#125;</span><br><span class="line">    p += x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = -p , invp = fpow( p , mod - <span class="number">2</span> ) ; i &lt; p ; ++i ) </span><br><span class="line">    inc( ans , <span class="number">1L</span>L * mns( g[i] , f[i] ) * fpow( mns( <span class="number">1</span> , <span class="number">1L</span>L * ( i + mod ) * invp % mod ) , mod - <span class="number">2</span> ) % mod );</span><br><span class="line">  cout &lt;&lt; 1LL * ans * fpow( 2 , n ) % mod;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="语言"><a href="https://loj.ac/problem/3046" target="_blank" rel="noopener">语言</a></h3>
<p>线段树合并</p>
<p>对于每一次从 <span class="math inline">\(u\)</span> 到 <span class="math inline">\(v\)</span> 的操作</p>
<p>可以视作将 <span class="math inline">\(u\)</span> , <span class="math inline">\(v\)</span> 加入途径点的集合中</p>
<p>于是最后 , 每个点都有一个集合 , 这个点能到达的区域就是其集合内点的生成树</p>
<p>类似于建虚树的过程</p>
<p>可以使用 <span class="math inline">\(dfn\)</span> 序加线段树维护</p>
<p>每个区间记录一下 <span class="math inline">\(dfn\)</span> 最大与最小的值就可以合并了</p>
<p>用差分思想线段树合并就可以了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">include &lt;bits/stdc++.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> head[N] , dfn[N] , top[N] , dep[N] , rmp[N] , dfc , fa[N] , eidx , siz[N] , hs[N];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[N &lt;&lt; <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  siz[u] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != fa[u] ) &#123;</span><br><span class="line">      fa[v] = u , dep[v] = dep[u] + <span class="number">1</span>;</span><br><span class="line">      dfs( v ); siz[u] += siz[v];</span><br><span class="line">      <span class="keyword">if</span>( siz[hs[u]] &lt; siz[v] ) hs[u] = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> ftop )</span> </span>&#123;</span><br><span class="line">  rmp[dfn[u] = ++dfc] = u , top[u] = ftop;</span><br><span class="line">  <span class="keyword">if</span>( hs[u] ) dfs( hs[u] , ftop );</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != fa[u] &amp;&amp; v != hs[u] )</span><br><span class="line">      dfs( v , v );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>( top[u] != top[v] ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( dep[top[u]] &lt; dep[top[v]] ) swap( u , v );</span><br><span class="line">    u = fa[top[u]];</span><br><span class="line">  &#125; <span class="keyword">return</span> dep[u] &lt; dep[v] ? u : v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mx[N &lt;&lt; <span class="number">5</span>] , mn[N &lt;&lt; <span class="number">5</span>] , son[N &lt;&lt; <span class="number">5</span>][<span class="number">2</span>] , val[N &lt;&lt; <span class="number">5</span>] , rt[N] , tag[N &lt;&lt; <span class="number">5</span>] , nidx;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> ans;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( !son[u][<span class="number">0</span>] || !son[u][<span class="number">1</span>] ) &#123;</span><br><span class="line">    <span class="keyword">int</span> v = son[u][<span class="number">0</span>] + son[u][<span class="number">1</span>];</span><br><span class="line">    val[u] = val[v];</span><br><span class="line">    mx[u] = mx[v];</span><br><span class="line">    mn[u] = mn[v];</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> ls = son[u][<span class="number">0</span>] , rs = son[u][<span class="number">1</span>];</span><br><span class="line">  val[u] = val[ls] + val[rs];</span><br><span class="line">  <span class="keyword">if</span>( mx[ls] != -INF &amp;&amp; mn[rs] != INF ) </span><br><span class="line">    val[u] -= dep[LCA( rmp[mx[ls]] , rmp[mn[rs]] )];</span><br><span class="line">  mx[u] = max( mx[ls] , mx[rs] );</span><br><span class="line">  mn[u] = min( mn[ls] , mn[rs] );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mdf</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> &amp; u , <span class="keyword">int</span> pos , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( !u ) u = ++nidx;</span><br><span class="line">  <span class="keyword">if</span>( l == r ) &#123; </span><br><span class="line">    tag[u] += k;</span><br><span class="line">    <span class="keyword">if</span>( tag[u] &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">      mx[u] = mn[u] = l;</span><br><span class="line">      val[u] = dep[rmp[l]];</span><br><span class="line">    &#125; <span class="keyword">else</span> mx[u] = -INF , mn[u] = INF , val[u] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>( mid &gt;= pos ) mdf( l , mid , son[u][<span class="number">0</span>] , pos , k );</span><br><span class="line">  <span class="keyword">else</span> mdf( mid + <span class="number">1</span> , r , son[u][<span class="number">1</span>] , pos , k );</span><br><span class="line">  up( u );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">merge</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( !u || !v ) <span class="keyword">return</span> u + v;</span><br><span class="line">  <span class="keyword">if</span>( l == r ) &#123;</span><br><span class="line">    tag[u] += tag[v];</span><br><span class="line">    <span class="keyword">if</span>( tag[u] &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">      mx[u] = mn[u] = l;</span><br><span class="line">      val[u] = dep[rmp[l]];</span><br><span class="line">    &#125; <span class="keyword">else</span> mx[u] = -INF , mn[u] = INF , val[u] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> u;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  son[u][<span class="number">0</span>] = merge( l , mid , son[u][<span class="number">0</span>] , son[v][<span class="number">0</span>] );</span><br><span class="line">  son[u][<span class="number">1</span>] = merge( mid + <span class="number">1</span> , r , son[u][<span class="number">1</span>] , son[v][<span class="number">1</span>] );</span><br><span class="line">  up( u );</span><br><span class="line">  <span class="keyword">return</span> u;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , m;</span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; ent[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != fa[u] ) &#123;</span><br><span class="line">      solve( v );</span><br><span class="line">      rt[u] = merge( <span class="number">1</span> , n , rt[u] , rt[v] );</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">int</span> &amp; v : ent[u] )</span><br><span class="line">    <span class="keyword">if</span>( v &lt; <span class="number">0</span> ) mdf( <span class="number">1</span> , n , rt[u] , dfn[-v] , <span class="number">-1</span> );</span><br><span class="line">    <span class="keyword">else</span> mdf( <span class="number">1</span> , n , rt[u] , dfn[v] , <span class="number">1</span> );</span><br><span class="line">  ans += val[rt[u]];</span><br><span class="line">  <span class="keyword">if</span>( mn[rt[u]] != INF &amp;&amp; mx[rt[u]] != -INF )</span><br><span class="line">    ans -= dep[LCA( rmp[mn[rt[u]]] , rmp[mx[rt[u]]] )];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;n,&amp;m);</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u , v ; i &lt; n ; ++i ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;u,&amp;v);</span><br><span class="line">    edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx;</span><br><span class="line">    edge[++eidx] = (Edge) &#123; head[v] , u &#125;; head[v] = eidx;</span><br><span class="line">  &#125;</span><br><span class="line">  dfs( <span class="number">1</span> );</span><br><span class="line">  dfs( <span class="number">1</span> , <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">int</span> u , v , lca;</span><br><span class="line">  <span class="keyword">while</span>( m-- ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;u,&amp;v);</span><br><span class="line">    lca = LCA( u , v );</span><br><span class="line">    ent[u].push_back( v );</span><br><span class="line">    ent[u].push_back( u );</span><br><span class="line">    ent[v].push_back( u );</span><br><span class="line">    ent[v].push_back( v );</span><br><span class="line">    ent[lca].push_back( -v );</span><br><span class="line">    ent[lca].push_back( -u );</span><br><span class="line">    ent[fa[lca]].push_back( -v );</span><br><span class="line">    ent[fa[lca]].push_back( -u );</span><br><span class="line">  &#125;</span><br><span class="line">  solve( <span class="number">1</span> );</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; ( ans &gt;&gt; <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="浙江省选"><a href="https://loj.ac/problem/3047" target="_blank" rel="noopener">浙江省选</a></h3>
<p>半平面交</p>
<p>能拿第一的就是第一次半平面交最上面的线段</p>
<p>删去能拿第一的直线后 , 再做半平面交 , 不过得出的线段不一定可以拿第二</p>
<p>需要在其线段区间内 , 有一个点只被得第一的直线覆盖一次 , 这才能拿第二</p>
<p>可以二分出每个直线的覆盖区域 , 差分后扫一遍检查</p>
<p>以上过程做 <span class="math inline">\(m\)</span> 次就可以了</p>
<p>由于只能取整点 , 比较时有些细节要注意</p>
<p>double 会爆 , long long 分数也会爆 , 要写带分数类 , 只有比较和赋值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>( <span class="title">T</span> &amp; <span class="title">x</span> ) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> lol;</span><br><span class="line"><span class="keyword">typedef</span> pair&lt;lol,<span class="keyword">int</span>&gt; pii;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Num</span> &#123;</span></span><br><span class="line">  lol a , b , c;</span><br><span class="line">  Num() &#123; a = b = <span class="number">0</span> , c = <span class="number">1</span>; &#125;</span><br><span class="line">  Num( lol x , lol y ) &#123; <span class="keyword">if</span>( y &lt; <span class="number">0</span> ) x = -x , y = -y; a = x / y , b = x % y , c = y; <span class="keyword">if</span>( b &lt; <span class="number">0</span> ) b += y , --a; &#125;</span><br><span class="line">  <span class="function">lol <span class="title">floor</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> a; &#125;</span><br><span class="line">  <span class="function">lol <span class="title">ceil</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> a + ( b &gt; <span class="number">0</span> ); &#125;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; ( <span class="keyword">const</span> Num &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> a ^ rhs.a ? a &lt; rhs.a : b * rhs.c &lt; rhs.b * c; &#125;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= ( <span class="keyword">const</span> Num &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> a ^ rhs.a ? a &lt; rhs.a : b * rhs.c &lt;= rhs.b * c; &#125;</span><br><span class="line">&#125; p[N];</span><br><span class="line"></span><br><span class="line">lol a[N] , b[N]; pii d[N &lt;&lt; <span class="number">1</span>];</span><br><span class="line"><span class="keyword">int</span> n , m , ans[N] , cur[N] , S[N] , tp , tot;</span><br><span class="line"></span><br><span class="line"><span class="function">Num <span class="title">cross</span><span class="params">( <span class="keyword">int</span> x , <span class="keyword">int</span> y )</span> </span>&#123; <span class="keyword">return</span> Num( b[y] - b[x] , a[x] - a[y] ); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  p[<span class="number">0</span>] = p[<span class="number">1</span>] = Num( <span class="number">0</span> , <span class="number">1</span> ) , tp = tot = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) <span class="keyword">if</span>( !~ans[cur[i]] &amp;&amp; a[cur[i]] &gt; a[S[tp]] ) &#123;</span><br><span class="line">    <span class="keyword">while</span>( tp &amp;&amp; cross( cur[i] , S[tp] ).<span class="built_in">floor</span>() &lt; p[tp].<span class="built_in">ceil</span>() ) --tp;</span><br><span class="line">    S[++tp] = cur[i];</span><br><span class="line">    <span class="keyword">if</span>( tp &gt; <span class="number">1</span> ) p[tp] = cross( S[tp] , S[tp - <span class="number">1</span>] );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , l , r , mid = <span class="number">0</span> , res ; i &lt;= n ; ++i )</span><br><span class="line">    <span class="keyword">if</span>( ~ans[i] ) &#123;</span><br><span class="line">      l = <span class="number">1</span> , r = tp - <span class="number">1</span> , res = tp;</span><br><span class="line">      <span class="keyword">while</span>( l &lt;= r ) &#123;</span><br><span class="line">        mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>( a[S[mid]] &gt;= a[i] || cross( S[mid] , i ) &lt;= p[mid + <span class="number">1</span>] )</span><br><span class="line">          res = mid , r = mid - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      d[++tot] = pii( a[S[res]] &gt;= a[i] ? <span class="number">0L</span>L : cross( S[res] , i ).<span class="built_in">floor</span>() + <span class="number">1</span> , <span class="number">1</span> );</span><br><span class="line">      l = <span class="number">2</span> , r = tp , res = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span>( l &lt;= r ) &#123;</span><br><span class="line">        mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>( a[S[mid]] &lt;= a[i] || p[mid] &lt;= cross( S[mid] , i ) )</span><br><span class="line">          res = mid , l = mid + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> r = mid - <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>( a[S[res]] &gt; a[i] ) </span><br><span class="line">        d[++tot] = pii( cross( S[res] , i ).<span class="built_in">ceil</span>() , <span class="number">-1</span> );</span><br><span class="line">    &#125;</span><br><span class="line">  sort( d + <span class="number">1</span> , d + <span class="number">1</span> + tot ) , p[tp + <span class="number">1</span>] = Num( <span class="number">1L</span>L &lt;&lt; <span class="number">60</span> , <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , ptr = <span class="number">1</span> , now = <span class="number">0</span> , nptr ; i &lt;= tp ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">while</span>( ptr &lt;= tot &amp;&amp; d[ptr].first &lt;= p[i].<span class="built_in">ceil</span>() ) now += d[ptr++].second;</span><br><span class="line">    <span class="keyword">if</span>( now &lt; k ) ans[S[i]] = k;</span><br><span class="line">    <span class="keyword">while</span>( ptr &lt;= tot &amp;&amp; d[ptr].first &lt;= p[i + <span class="number">1</span>].<span class="built_in">floor</span>() ) &#123;</span><br><span class="line">      nptr = ptr;</span><br><span class="line">      <span class="keyword">while</span>( nptr &lt;= tot &amp;&amp; d[nptr].first == d[ptr].first ) </span><br><span class="line">        now += d[nptr++].second;</span><br><span class="line">      <span class="keyword">if</span>( now &lt; k ) ans[S[i]] = k;</span><br><span class="line">      ptr = nptr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">( <span class="keyword">int</span> _a , <span class="keyword">int</span> _b )</span> </span>&#123; <span class="keyword">return</span> a[_a] == a[_b] ? b[_a] &gt; b[_b] : a[_a] &lt; a[_b]; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  read( n ) , read( m );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) </span><br><span class="line">    read( a[i] ) , read( b[i] ) , cur[i] = i , ans[i] = <span class="number">-1</span>;</span><br><span class="line">  sort( cur + <span class="number">1</span> , cur + <span class="number">1</span> + n , cmp );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= m ; ++i ) solve( i );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) <span class="built_in">printf</span>(<span class="string">"%d "</span>,ans[i]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/28/Solutions/%E4%BB%98%E5%85%AC%E4%B8%BB%E7%9A%84%E8%83%8C%E5%8C%85/" rel="prev" title="付公主的背包">
      <i class="fa fa-chevron-left"></i> 付公主的背包
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/29/Tutorial/%E4%B8%AD%E5%9B%BD%E5%89%A9%E4%BD%99%E5%AE%9A%E7%90%86/" rel="next" title="中国剩余定理">
      中国剩余定理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#麻将"><span class="nav-number">1.</span> <span class="nav-text">麻将</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线段树"><span class="nav-number">2.</span> <span class="nav-text">线段树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#minimax-搜索"><span class="nav-number">3.</span> <span class="nav-text">Minimax 搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开关"><span class="nav-number">4.</span> <span class="nav-text">开关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#语言"><span class="nav-number">5.</span> <span class="nav-text">语言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浙江省选"><span class="nav-number">6.</span> <span class="nav-text">浙江省选</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Guyan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guyan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
