<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="给出简要思路和代码">
<meta property="og:type" content="article">
<meta property="og:title" content="[SDOI2018] 简要题解">
<meta property="og:url" content="http://yoursite.com/2020/05/10/Solutions/SDOI2018-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/index.html">
<meta property="og:site_name" content="Guyan&#39;s blog">
<meta property="og:description" content="给出简要思路和代码">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-10T04:00:29.000Z">
<meta property="article:modified_time" content="2020-05-16T08:02:48.660Z">
<meta property="article:author" content="Guyan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/05/10/Solutions/SDOI2018-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>[SDOI2018] 简要题解 | Guyan's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Guyan's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/10/Solutions/SDOI2018-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guyan">
      <meta itemprop="description" content="水平低啊">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guyan's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [SDOI2018] 简要题解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-10 12:00:29" itemprop="dateCreated datePublished" datetime="2020-05-10T12:00:29+08:00">2020-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-16 16:02:48" itemprop="dateModified" datetime="2020-05-16T16:02:48+08:00">2020-05-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>给出简要思路和代码</p>
<a id="more"></a>
<h5 id="sdoi2018-物理实验"><a href="https://loj.ac/problem/2561" target="_blank" rel="noopener">[SDOI2018] 物理实验</a></h5>
<p>先将导轨化为 <span class="math inline">\(x\)</span> 轴 , 其他线段分为 <span class="math inline">\(y\)</span> 坐标大于 <span class="math inline">\(0\)</span> 和小于 <span class="math inline">\(0\)</span> 的两部分 , 分别求出每个关键点 , 表示覆盖答案计算方法的变化 , 最后激光发射器的某个端点一定是一个关键点 , 扫一遍计算答案即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>( <span class="title">T</span> &amp; <span class="title">x</span> ) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">2e4</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> eps = <span class="number">1e-9</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span> &#123;</span></span><br><span class="line">  <span class="keyword">double</span> x , y;</span><br><span class="line">  Point( <span class="keyword">double</span> x = <span class="number">0</span> , <span class="keyword">double</span> y = <span class="number">0</span> ):x( x ) , y( y ) &#123;&#125;</span><br><span class="line">  Point <span class="keyword">operator</span> + ( <span class="keyword">const</span> Point &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Point( x + rhs.x , y + rhs.y ); &#125;</span><br><span class="line">  Point <span class="keyword">operator</span> - ( <span class="keyword">const</span> Point &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Point( x - rhs.x , y - rhs.y ); &#125;</span><br><span class="line">  <span class="keyword">double</span> <span class="keyword">operator</span> * ( <span class="keyword">const</span> Point &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> x * rhs.x + y * rhs.y; &#125;</span><br><span class="line">  <span class="keyword">double</span> <span class="keyword">operator</span> ^ ( <span class="keyword">const</span> Point &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> x * rhs.y - y * rhs.x; &#125;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; ( <span class="keyword">const</span> Point &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> x &lt; rhs.x || ( x == rhs.x &amp;&amp; y &lt; rhs.y ); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">turn</span><span class="params">( <span class="keyword">double</span> ang )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> tx , ty;</span><br><span class="line">    tx = <span class="built_in">cos</span>( ang ) * x - <span class="built_in">sin</span>( ang ) * y;</span><br><span class="line">    ty = <span class="built_in">sin</span>( ang ) * x + <span class="built_in">cos</span>( ang ) * y;</span><br><span class="line">    x = tx , y = ty;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> X;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Seg</span> &#123;</span></span><br><span class="line">  Point u , v;</span><br><span class="line">  <span class="keyword">double</span> c , k;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">judge</span><span class="params">( <span class="keyword">const</span> Seg &amp; rhs )</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rhs.u.y &lt;= ( u.y + ( X - u.x ) * k );</span><br><span class="line">  &#125;</span><br><span class="line">&#125; dat[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , L , m;</span><br><span class="line"><span class="keyword">double</span> pos[N] , up[N] , dn[N] , ans;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Splay &#123;</span><br><span class="line">  <span class="keyword">int</span> rt , son[N][<span class="number">2</span>] , p[N];</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">which</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123; <span class="keyword">return</span> p[x] ? x == son[p[x]][<span class="number">1</span>] : <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v , <span class="keyword">int</span> w )</span> </span>&#123; <span class="keyword">if</span>( u ) p[u] = v; <span class="keyword">if</span>( v ) son[v][w] = u; <span class="keyword">else</span> rt = u; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> f , w; w = which( u ) , f = p[u];</span><br><span class="line">    connect( u , p[f] , which( f ) );</span><br><span class="line">    connect( son[u][w ^ <span class="number">1</span>] , f , w );</span><br><span class="line">    connect( f , u , w ^ <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> f; v = p[v]; <span class="keyword">while</span>( ( f = p[u] ) != v ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( p[f] != v ) rotate( which( u ) ^ which( f ) ? u : f );</span><br><span class="line">      rotate( u );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ins</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( !rt ) <span class="keyword">return</span> rt = u , <span class="keyword">void</span>();</span><br><span class="line">    <span class="keyword">int</span> x = rt , w;</span><br><span class="line">    <span class="keyword">while</span>( x ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( dat[x].judge( dat[u] ) ) w = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">else</span> w = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>( !son[x][w] ) &#123;</span><br><span class="line">        p[son[x][w] = u] = x;</span><br><span class="line">        splay( u , rt );</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; x = son[x][w];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">qry</span><span class="params">( <span class="keyword">int</span> type )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( !rt ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> x; x = rt;</span><br><span class="line">    <span class="keyword">while</span>( son[x][type] ) x = son[x][type];</span><br><span class="line">    splay( x , rt );</span><br><span class="line">    <span class="keyword">return</span> dat[x].c;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    splay( u , rt );</span><br><span class="line">    <span class="keyword">if</span>( !son[rt][<span class="number">0</span>] &amp;&amp; !son[rt][<span class="number">1</span>] ) <span class="keyword">return</span> rt = <span class="number">0</span> , <span class="keyword">void</span>();</span><br><span class="line">    <span class="keyword">if</span>( !son[rt][<span class="number">0</span>] || !son[rt][<span class="number">1</span>] ) <span class="keyword">return</span> p[rt = son[u][<span class="number">0</span>] + son[u][<span class="number">1</span>]] = <span class="number">0</span> , <span class="keyword">void</span>();</span><br><span class="line">    <span class="keyword">int</span> x = son[rt][<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">while</span>( son[x][<span class="number">1</span>] ) x = son[x][<span class="number">1</span>];</span><br><span class="line">    splay( x , son[rt][<span class="number">0</span>] );</span><br><span class="line">    p[son[x][<span class="number">1</span>] = son[rt][<span class="number">1</span>]] = x;</span><br><span class="line">    p[rt = x] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; rt = <span class="number">0</span>; <span class="built_in">memset</span>( son , <span class="number">0</span> , <span class="keyword">sizeof</span> son ) , <span class="built_in">memset</span>( p , <span class="number">0</span> , <span class="keyword">sizeof</span> p ); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  read( n );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , x , y ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    read( x ) , read( y );</span><br><span class="line">    dat[i].u = Point( x , y );</span><br><span class="line">    read( x ) , read( y );</span><br><span class="line">    dat[i].v = Point( x , y );</span><br><span class="line">  &#125;</span><br><span class="line">  read( dat[<span class="number">0</span>].u.x ) , read( dat[<span class="number">0</span>].u.y );</span><br><span class="line">  read( dat[<span class="number">0</span>].v.x ) , read( dat[<span class="number">0</span>].v.y ); read( L );</span><br><span class="line">  dat[<span class="number">0</span>].v = dat[<span class="number">0</span>].v - dat[<span class="number">0</span>].u;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    dat[i].u = dat[i].u - dat[<span class="number">0</span>].u;</span><br><span class="line">    dat[i].v = dat[i].v - dat[<span class="number">0</span>].u;</span><br><span class="line">  &#125; dat[<span class="number">0</span>].u = Point( <span class="number">0</span> , <span class="number">0</span> ) , m = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">double</span> ang = -<span class="built_in">atan2</span>( dat[<span class="number">0</span>].v.y , dat[<span class="number">0</span>].v.x ) , tmp;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    dat[i].u.turn( ang );</span><br><span class="line">    dat[i].v.turn( ang );</span><br><span class="line">    <span class="keyword">if</span>( dat[i].u.x &gt; dat[i].v.x ) swap( dat[i].u , dat[i].v );</span><br><span class="line">    tmp = <span class="built_in">atan2</span>( dat[i].v.y - dat[i].u.y , dat[i].v.x - dat[i].u.x );</span><br><span class="line">    dat[i].c = <span class="number">1</span> / <span class="built_in">cos</span>( tmp );</span><br><span class="line">    dat[i].k = ( dat[i].v.y - dat[i].u.y ) / ( dat[i].v.x - dat[i].u.x );</span><br><span class="line">    pos[++m] = dat[i].u.x;</span><br><span class="line">    pos[++m] = dat[i].v.x;</span><br><span class="line">  &#125; dat[<span class="number">0</span>].v.turn( ang );</span><br><span class="line">  sort( pos + <span class="number">1</span> , pos + <span class="number">1</span> + m );</span><br><span class="line">  <span class="keyword">int</span> nm = <span class="number">0</span>; pos[nm = <span class="number">1</span>] = pos[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= m ; ++i )</span><br><span class="line">    <span class="keyword">if</span>( pos[i] &gt; pos[i - <span class="number">1</span>] + eps )</span><br><span class="line">      pos[++nm] = pos[i];</span><br><span class="line">  m = nm;</span><br><span class="line">  sort( dat + <span class="number">1</span> , dat + <span class="number">1</span> + n , []( <span class="keyword">const</span> Seg &amp; a , <span class="keyword">const</span> Seg &amp; b ) &#123; <span class="keyword">return</span> a.u.x &lt; b.u.x; &#125; );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Splay::init(); <span class="keyword">static</span> <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; ent[N];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= m ; ++i ) ent[i].clear();</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , id ; i &lt;= n ; ++i ) <span class="keyword">if</span>( dat[i].u.y &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">    id = lower_bound( pos + <span class="number">1</span> , pos + <span class="number">1</span> + m , dat[i].u.x ) - pos;</span><br><span class="line">    ent[id].push_back( i );</span><br><span class="line">    id = lower_bound( pos + <span class="number">1</span> , pos + <span class="number">1</span> + m , dat[i].v.x ) - pos;</span><br><span class="line">    ent[id].push_back( -i );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= m ; ++i ) &#123;</span><br><span class="line">    sort( ent[i].begin() , ent[i].end() ) , X = pos[i];</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">int</span> &amp; v : ent[i] )</span><br><span class="line">      <span class="keyword">if</span>( v &gt; <span class="number">0</span> ) Splay::ins( v );</span><br><span class="line">      <span class="keyword">else</span> Splay::del( -v );</span><br><span class="line">    up[i] = Splay::qry( <span class="number">0</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= m ; ++i ) ent[i].clear();</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , id ; i &lt;= n ; ++i ) <span class="keyword">if</span>( dat[i].u.y &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">    id = lower_bound( pos + <span class="number">1</span> , pos + <span class="number">1</span> + m , dat[i].u.x ) - pos;</span><br><span class="line">    ent[id].push_back( i );</span><br><span class="line">    id = lower_bound( pos + <span class="number">1</span> , pos + <span class="number">1</span> + m , dat[i].v.x ) - pos;</span><br><span class="line">    ent[id].push_back( -i );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= m ; ++i ) &#123;</span><br><span class="line">    sort( ent[i].begin() , ent[i].end() ) , X = pos[i];</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">int</span> &amp; v : ent[i] )</span><br><span class="line">      <span class="keyword">if</span>( v &gt; <span class="number">0</span> ) Splay::ins( v );</span><br><span class="line">      <span class="keyword">else</span> Splay::del( -v );</span><br><span class="line">    dn[i] = Splay::qry( <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  ans = <span class="number">0</span> , tmp = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , r = <span class="number">1</span> ; i &lt;= m ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">while</span>( r &lt; m &amp;&amp; pos[r + <span class="number">1</span>] &lt;= pos[i] + L ) tmp += ( pos[r + <span class="number">1</span>] - pos[r] ) * ( up[r] + dn[r] ) , ++r;</span><br><span class="line">    ans = max( ans , tmp + ( L - ( pos[r] - pos[i] ) ) * ( up[r] + dn[r] ) );</span><br><span class="line">    tmp -= ( pos[i + <span class="number">1</span>] - pos[i] ) * ( up[i] + dn[i] );</span><br><span class="line">  &#125; tmp = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = m , l = m ; i ; --i ) &#123;</span><br><span class="line">    <span class="keyword">while</span>( l &gt; <span class="number">1</span> &amp;&amp; pos[l - <span class="number">1</span>] &gt;= pos[i] - L ) tmp += ( pos[l] - pos[l - <span class="number">1</span>] ) * ( up[l - <span class="number">1</span>] + dn[l - <span class="number">1</span>] ) , --l;</span><br><span class="line">    ans = max( ans , tmp + ( L - ( pos[i] - pos[l] ) ) * ( up[l - <span class="number">1</span>] + dn[l - <span class="number">1</span>] ) );</span><br><span class="line">    tmp -= ( pos[i] - pos[i - <span class="number">1</span>] ) * ( up[i - <span class="number">1</span>] + dn[i - <span class="number">1</span>] );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%.10f\n"</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> T; read( T );</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2018-战略游戏"><a href="https://loj.ac/problem/2562" target="_blank" rel="noopener">[SDOI2018] 战略游戏</a></h5>
<p>先建出圆方树 , 对于只询问两个点的情况 , 就是两点间割点的数量 , 这就是两点间圆点的数量 , 推广到一个点集 <span class="math inline">\(S\)</span> 的情况 , 就是建出虚树 , 求出虚树权值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>( <span class="title">T</span> &amp; <span class="title">x</span> ) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">5e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> LG = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , nidx , m , q , dep[N] , fa[LG][N] , dfn[N] , dfc , val[N];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[N &lt;&lt; <span class="number">1</span>]; <span class="keyword">int</span> eidx;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Graph</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> head[N];</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="built_in">memset</span>( head , <span class="number">0</span> , <span class="keyword">sizeof</span> head ); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">    edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx;</span><br><span class="line">    edge[++eidx] = (Edge) &#123; head[v] , u &#125;; head[v] = eidx;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; A , B;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( dep[u] &lt; dep[v] ) swap( u , v );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> , k = dep[u] - dep[v] ; ( <span class="number">1</span> &lt;&lt; i ) &lt;= k ; ++i )</span><br><span class="line">    <span class="keyword">if</span>( ( k &gt;&gt; i ) &amp; <span class="number">1</span> ) u = fa[i][u];</span><br><span class="line">  <span class="keyword">if</span>( u == v ) <span class="keyword">return</span> u;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = LG - <span class="number">1</span> ; ~i ; --i )</span><br><span class="line">    <span class="keyword">if</span>( fa[i][u] != fa[i][v] )</span><br><span class="line">      u = fa[i][u] , v = fa[i][v];</span><br><span class="line">  <span class="keyword">return</span> fa[<span class="number">0</span>][u];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Tarjan &#123;</span><br><span class="line">  <span class="keyword">int</span> dfn[N] , dfc , low[N] , S[N] , tp;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    dfn[u] = low[u] = ++dfc , S[++tp] = u;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = A.head[u] , v , p ; i ; i = edge[i].nxt )</span><br><span class="line">      <span class="keyword">if</span>( !dfn[v = edge[i].to] ) &#123;</span><br><span class="line">        dfs( v );</span><br><span class="line">        low[u] = min( low[u] , low[v] );</span><br><span class="line">        <span class="keyword">if</span>( low[v] &gt;= dfn[u] ) &#123;</span><br><span class="line">          B.addedge( u , ++nidx );</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            p = S[tp--];</span><br><span class="line">            B.addedge( nidx , p );</span><br><span class="line">          &#125; <span class="keyword">while</span>( p != v );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> low[u] = min( low[u] , dfn[v] );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">work</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>( dfn , <span class="number">0</span> , <span class="keyword">sizeof</span> dfn ) , dfc = tp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i )</span><br><span class="line">      <span class="keyword">if</span>( !dfn[i] ) dfs( i );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  dfn[u] = ++dfc;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = B.head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != fa[<span class="number">0</span>][u] ) &#123;</span><br><span class="line">      fa[<span class="number">0</span>][v] = u , dep[v] = dep[u] + <span class="number">1</span>;</span><br><span class="line">      val[v] = val[u] + ( v &lt;= n );</span><br><span class="line">      dfs( v );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  eidx = <span class="number">0</span>;</span><br><span class="line">  A.init() , B.init();</span><br><span class="line">  read( n ) , read( m ); nidx = n;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u , v ; i &lt;= m ; ++i ) &#123;</span><br><span class="line">    read( u ) , read( v );</span><br><span class="line">    A.addedge( u , v );</span><br><span class="line">  &#125; dfc = <span class="number">0</span>;</span><br><span class="line">  Tarjan::work();</span><br><span class="line">  dfs( <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; LG ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> u = <span class="number">1</span> ; u &lt;= n ; ++u )</span><br><span class="line">      fa[i][u] = fa[i - <span class="number">1</span>][fa[i - <span class="number">1</span>][u]];</span><br><span class="line">  read( m );</span><br><span class="line">  <span class="keyword">int</span> res , lca , k;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> dat[N];</span><br><span class="line">  <span class="keyword">while</span>( m-- ) &#123;</span><br><span class="line">    read( k );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= k ; ++i ) read( dat[i] );</span><br><span class="line">    sort( dat + <span class="number">1</span> , dat + <span class="number">1</span> + k , []( <span class="keyword">const</span> <span class="keyword">int</span> &amp; a , <span class="keyword">const</span> <span class="keyword">int</span> &amp; b ) &#123; <span class="keyword">return</span> dfn[a] &lt; dfn[b]; &#125; );</span><br><span class="line">    res = val[dat[<span class="number">1</span>]];</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= k ; ++i ) &#123;</span><br><span class="line">      lca = LCA( dat[i - <span class="number">1</span>] , dat[i] );</span><br><span class="line">      res += val[dat[i]] - val[lca];</span><br><span class="line">    &#125;</span><br><span class="line">    lca = LCA( dat[<span class="number">1</span>] , dat[k] );</span><br><span class="line">    res -= val[fa[<span class="number">0</span>][lca]];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,res - k);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> T; read( T ) , val[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2018-反回文串"><a href="https://loj.ac/problem/2563" target="_blank" rel="noopener">[SDOI2018] 反回文串</a></h5>
<p>考虑对于一个回文串 , 每次左移一位会产生一个合法串 , 但是如果在左移过程中可能又成为一个回文串 , 此时会算重 , 那么考虑什么时候左移时会出现回文串 , 也就是原串有循环节 , 于是就可以设 <span class="math inline">\(f_d\)</span> 表示长为 <span class="math inline">\(n\)</span> 且循环节长度为 <span class="math inline">\(d\)</span> 的字符串数量 , 对于每个循环节长度为 <span class="math inline">\(d\)</span> 的回文串 , 如果 <span class="math inline">\(d\)</span> 为奇数 , 会贡献 <span class="math inline">\(d\)</span> 个合法串 , 如果为偶数 , 会贡献 <span class="math inline">\(\frac{d}{2}\)</span> 个合法串. 设 <span class="math inline">\(g_d\)</span> 表示循环节长度是 <span class="math inline">\(d\)</span> 的约数的字符串数量 , 于是有 <span class="math inline">\(g_d = k^{\lceil\frac{d}{2}\rceil}\)</span> , 以及 <span class="math inline">\(g_n = \sum_{d \mid n} f_d\)</span>.</p>
<p>令 <span class="math inline">\(h_d = \frac{d}{1 + [\text{d is even}]}\)</span> , 则有 <span class="math display">\[
\begin{aligned}
\text{Ans} &amp;= \sum_{d\mid n}f_dh_d \\
&amp;=\sum_{d\mid n} h_d\sum_{k\mid d}\mu(\frac{d}{k})g_k \\
&amp;=\sum_{k \mid n}g_k\sum_{d\mid \frac{n}{k}}\mu(d)h_{dk}
\end{aligned}
\]</span> 观察式子 <span class="math inline">\(\sum_{d \mid \frac{n}{k}} \mu(d)h_{dk}\)</span> , 分 <span class="math inline">\(k\)</span> 和 <span class="math inline">\(\frac{n}{k}\)</span> 的奇偶讨论 , 如果 <span class="math inline">\(k\)</span> 和 <span class="math inline">\(\frac{n}{k}\)</span> 都是偶数 , 那么 <span class="math inline">\(h_{dk} = \frac{dk}{2}\)</span> , 如果 <span class="math inline">\(k\)</span> 和 <span class="math inline">\(\frac{n}{k}\)</span> 都是奇数 , 那么 <span class="math inline">\(h_{dk} = dk\)</span> , 如果 <span class="math inline">\(k\)</span> 是偶数 , <span class="math inline">\(\frac{n}{k}\)</span> 是奇数 , <span class="math inline">\(h_{dk} = dk\)</span> , 如果 <span class="math inline">\(k\)</span> 是奇数 , <span class="math inline">\(\frac{n}{k}\)</span> 是偶数 , 此时对于 <span class="math inline">\(\frac{n}{k}\)</span> 的奇因数 <span class="math inline">\(d\)</span> , 有 <span class="math inline">\(\mu(d)h_{dk} = -\mu( 2d )h_{2dk}\)</span> , 于是发现两两对应 , 和为 <span class="math inline">\(0\)</span></p>
<p>对于 <span class="math inline">\(h_{dk} = dh_k\)</span> , 可以将原式化为 <span class="math inline">\(h_k \sum_{d \mid \frac{n}{k}} \mu(d) d\)</span> , 于是 <span class="math inline">\(\text{Ans} = \sum_{k \mid n}g_kh_k \sum_{d\mid \frac{n}{k}} \mu(d) d\)</span></p>
<p>和式 <span class="math inline">\(\sum_{d \mid \frac{n}{k}} \mu(d)d\)</span> ，就是 <span class="math inline">\(\prod_{i}(1-p_i)\)</span> , 其中 <span class="math inline">\(p_i\)</span> 是 <span class="math inline">\(\frac{n}{k}\)</span> 的质因数分解 , 考虑新加入一个质数 , 一种情况是直接不乘上 <span class="math inline">\(p\)</span> , 就是乘 <span class="math inline">\(1\)</span> , 另一种情况 , 就是加上 <span class="math inline">\(\mu(dp)dp\)</span> , 由于 <span class="math inline">\(\mu(d) = -\mu(dp)\)</span> , 就是乘 <span class="math inline">\(-1\)</span> , 再乘一个 <span class="math inline">\(p\)</span> , 就是 <span class="math inline">\(-p\)</span> 了 , 合起来就是 <span class="math inline">\((1-p)\)</span>. 得到这个之后重写式子得到 <span class="math display">\[
\begin{aligned}
\text{Ans} = \sum_{k \mid n}g_kh_k\prod_{p\mid \frac{n}{k}}(1-p)
\end{aligned}
\]</span> 对 <span class="math inline">\(n\)</span> 分解质因数后枚举因数 , <span class="math inline">\(\prod_{p \mid \frac{n}{k}}(1-p)\)</span> 可以在枚举的过程中计算</p>
<p>质因数分解要用 <span class="math inline">\(\text{Pollard-Rho}\)</span> , 做到 <span class="math inline">\(O(n^{\frac{1}{4}})\)</span> , <span class="math inline">\(n\)</span> 的因数不会太多 , 可以过</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> lol;</span><br><span class="line"></span><br><span class="line"><span class="function">lol <span class="title">pls</span><span class="params">( lol a , lol b , <span class="keyword">const</span> lol &amp; mod )</span> </span>&#123; <span class="keyword">return</span> a &gt;= mod - b ? a - mod + b : a + b; &#125;</span><br><span class="line"><span class="function">lol <span class="title">mns</span><span class="params">( lol a , lol b , <span class="keyword">const</span> lol &amp; mod )</span> </span>&#123; <span class="keyword">return</span> a &lt; b ? a - b + mod : a - b; &#125;</span><br><span class="line"><span class="function">lol <span class="title">mul</span><span class="params">( lol a , lol b , <span class="keyword">const</span> lol &amp; mod )</span> </span>&#123;</span><br><span class="line">  lol res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>( b ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( b &amp; <span class="number">1</span> ) res = pls( res , a , mod );</span><br><span class="line">    a = pls( a , a , mod ); b &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">lol <span class="title">fpow</span><span class="params">( lol b , lol k , <span class="keyword">const</span> lol &amp; mod )</span> </span>&#123;</span><br><span class="line">  lol res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = mul( res , b , mod );</span><br><span class="line">    b = mul( b , b , mod ); k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> MR &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> prime[<span class="number">7</span>] = &#123; <span class="number">2</span> , <span class="number">3</span> , <span class="number">131</span> , <span class="number">127</span> , <span class="number">19260817</span> , <span class="number">19491001</span> , <span class="keyword">int</span>(<span class="number">1e9</span> + <span class="number">9</span>) &#125;;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">MillerRobin</span><span class="params">( lol x )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> lol t , k;</span><br><span class="line">    <span class="keyword">if</span>( x &lt; <span class="number">2</span> ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">7</span> ; ++i ) <span class="keyword">if</span>( x == prime[i] ) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">7</span> ; ++i ) <span class="keyword">if</span>( x % prime[i] == <span class="number">0</span> ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">7</span> ; ++i ) &#123;</span><br><span class="line">      k = x - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">        t = fpow( prime[i] % x , k , x );</span><br><span class="line">        <span class="keyword">if</span>( t != <span class="number">1</span> &amp;&amp; t != x - <span class="number">1</span> ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>( (k&amp;<span class="number">1</span>) || t == x - <span class="number">1</span> ) <span class="keyword">break</span>;</span><br><span class="line">        k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> MR::MillerRobin;</span><br><span class="line"></span><br><span class="line">lol prime[<span class="number">35</span>];</span><br><span class="line"><span class="keyword">int</span> tot , cnt[<span class="number">35</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> PollardRho &#123;</span><br><span class="line">  <span class="function">lol <span class="title">f</span><span class="params">( lol x , lol c , <span class="keyword">const</span> lol mod )</span> </span>&#123; <span class="keyword">return</span> pls( mul( x , x , mod ) , c , mod ); &#125;</span><br><span class="line">  <span class="function">lol <span class="title">gcd</span><span class="params">( lol a , lol b )</span> </span>&#123; <span class="keyword">return</span> b ? gcd( b , a % b ) : a; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getprime</span><span class="params">( lol x )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( x &lt; <span class="number">2</span> ) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>( MillerRobin( x ) ) <span class="keyword">return</span> prime[++tot] = x , <span class="keyword">void</span>();</span><br><span class="line">    lol s = <span class="number">0</span> , t = <span class="number">0</span> , c = rand() % ( x - <span class="number">1</span> ) + <span class="number">1</span> , d;</span><br><span class="line">    s = f( <span class="number">0</span> , c , x ) , t = f( s , c , x );</span><br><span class="line">    <span class="keyword">while</span>( s != t ) &#123;</span><br><span class="line">      d = gcd( <span class="built_in">abs</span>( s - t ) , x );</span><br><span class="line">      <span class="keyword">if</span>( d &gt; <span class="number">1</span> ) &#123;</span><br><span class="line">        getprime( d );</span><br><span class="line">        <span class="keyword">while</span>( x % d == <span class="number">0</span> ) x /= d;</span><br><span class="line">        getprime( x );</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      s = f( s , c , x );</span><br><span class="line">      t = f( t , c , x );</span><br><span class="line">      t = f( t , c , x );</span><br><span class="line">    &#125;</span><br><span class="line">    getprime( x );</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> PollardRho::getprime;</span><br><span class="line"></span><br><span class="line">lol n , k , _n;</span><br><span class="line"><span class="keyword">int</span> P , ans;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - P; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; P ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; P ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - P; a += a &gt;&gt; <span class="number">31</span> &amp; P; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; P; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( lol b , lol k )</span> </span>&#123;</span><br><span class="line">  b %= P; <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % P;</span><br><span class="line">    b = b * b % P; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u , lol pd , <span class="keyword">int</span> s )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( u == tot + <span class="number">1</span> ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( (pd&amp;<span class="number">1</span>) &amp;&amp; (~(n/pd)&amp;<span class="number">1</span>) ) <span class="keyword">return</span>;</span><br><span class="line">    inc( ans , <span class="number">1L</span>L * fpow( k , ( pd + <span class="number">1</span> ) / <span class="number">2</span> ) * ( ( (pd&amp;<span class="number">1</span>) ? pd : pd / <span class="number">2</span> ) % P ) % P * s % P );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> c = cnt[u] , ts = <span class="number">1L</span>L * s * mns( <span class="number">1</span> , prime[u] % P ) % P; lol t = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( c-- ) dfs( u + <span class="number">1</span> , pd * t , ts ) , t *= prime[u];</span><br><span class="line">  dfs( u + <span class="number">1</span> , pd * t , s );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="built_in">cin</span> &gt;&gt; n &gt;&gt; k &gt;&gt; P , tot = ans = <span class="number">0</span>; _n = n;</span><br><span class="line">  <span class="keyword">if</span>( ~n &amp; <span class="number">1</span> ) &#123;</span><br><span class="line">    <span class="keyword">while</span>( ~n &amp; <span class="number">1</span> ) n &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    prime[++tot] = <span class="number">2</span>;</span><br><span class="line">  &#125; getprime( n );</span><br><span class="line">  n = _n;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= tot ; ++i ) &#123;</span><br><span class="line">    cnt[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( n % prime[i] == <span class="number">0</span> ) ++cnt[i] , n /= prime[i];</span><br><span class="line">  &#125; n = _n;</span><br><span class="line">  dfs( <span class="number">1</span> , <span class="number">1</span> , <span class="number">1</span> );</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; ans &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  srand( time( <span class="number">0</span> ) );</span><br><span class="line">  <span class="keyword">int</span> T; <span class="built_in">cin</span> &gt;&gt; T;</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2018-原题识别"><a href="https://loj.ac/problem/2564" target="_blank" rel="noopener">[SDOI2018] 原题识别</a></h5>
<p>网上主流有两种做法 , 这里都说一下 , 一种在线 , 一种离线</p>
<h6 id="离线做法">离线做法</h6>
<p>对于每个点 , 记录其入栈的时间和出栈的时间 , 可以得到 <span class="math inline">\(st_u,ed_u\)</span> , 那么对于一个点的子树就是 <span class="math inline">\([st_u,ed_u]\)</span> , 同时 , 对于入栈附加权值 <span class="math inline">\(1\)</span> , 对于出栈附加权值 <span class="math inline">\(-1\)</span> , 那么如果一个区间完全包含一个 <span class="math inline">\([st_u,ed_u]\)</span> , 那么 <span class="math inline">\(u\)</span> 子树的答案就不会算入 , 就可以得到路径上的答案.</p>
<p>考虑一个点 <span class="math inline">\(x\)</span> , 对经过其路径的贡献. 至少有一个点要在 <span class="math inline">\(x\)</span> 的子树内部 , 也就是 <span class="math inline">\([1,2n] \times [st_x,ed_x]\)</span> 和 <span class="math inline">\([st_x,ed_x] \times [1,2n]\)</span> 这两个矩形 , 不过这多算了两个端点都在 <span class="math inline">\(x\)</span> 子树内部的情况 , 也就是对于 <span class="math inline">\(x\)</span> 的任意一个儿子 <span class="math inline">\(y\)</span> , <span class="math inline">\([st_y,ed_y] \times [st_y,ed_y]\)</span> 不合法. 记 <span class="math inline">\([1,2n]\times [st_x,ed_x]\)</span> 和 <span class="math inline">\([st_x,ed_x]\times [1,2n]\)</span> 的矩阵的权值为 <span class="math inline">\(1\)</span> , 每个 <span class="math inline">\(y\)</span> 所代表矩阵 <span class="math inline">\([st_y,ed_y]\)</span> 的权值为 <span class="math inline">\(-2\)</span> , 加完之后发现只有权值非零的点所代表的路径有 <span class="math inline">\(x\)</span> 的贡献. 于是对于颜色相同的点 , 做以上操作 , 就可以得到对于一种颜色 , 哪些路径有这种颜色. 由于树和颜色都是随机的 , 矩形不会太多. 这样就可以转化乘矩形加操作.</p>
<p>考虑第一种询问 , 就是点查询 , 接着考虑第二种询问</p>
<p>对于 <span class="math inline">\(A,B\)</span> , 由于对于每个位置附加了权值 , 从根到 <span class="math inline">\(A\)</span> 的路径就是 <span class="math inline">\([1,st_A]\)</span> , <span class="math inline">\(B\)</span> 就是 <span class="math inline">\([1,st_B]\)</span> , 那么所代表的矩形就是 <span class="math inline">\([1,st_A] \times [1,st_B]\)</span> , 直接求和就行了. 对于矩形加 , 矩形求和 , 可以扫描线加树状数组解决.</p>
<p>上面提到矩形不会太多 , 具体证明及详细题解参见 <a href="https://www.cnblogs.com/clrs97/p/9064632.html" target="_blank" rel="noopener">claris 的题解报告</a></p>
<h6 id="在线做法">在线做法</h6>
<p>先考虑第一种询问</p>
<p>首先注意到由于树是随机的 , 对于一条路径 <span class="math inline">\((x,y)\)</span> , 两点到 <span class="math inline">\(\text{lca}\)</span> 的路径 <span class="math inline">\((\text{lca},x) , (\text{lca},y)\)</span> , 短的一条期望长度是 <span class="math inline">\(\log n\)</span> , 那么对于这一条就可以暴力. 由于颜色是随机的 , 所以每个颜色的期望出现次数是 <span class="math inline">\(O(1)\)</span> , 于是对于短链就可以暴力统计了 , 然后问题变为 <span class="math inline">\((\text{lca} , y)\)</span> 上有多少个不同颜色的点 , 这个建一颗主席树就行了, 主席树上保存上一次出现的位置 , 每次询问就是在 <span class="math inline">\([\text{lca},y]\)</span> 的主席树上找权值小于 <span class="math inline">\(\text{dep}_{\text{lca}}\)</span> 的个数.</p>
<p>对于第二种询问</p>
<p>先来考虑在序列上如何计算 , 这里设 <span class="math inline">\(A \leq B\)</span> , 也就是两个端点要在 <span class="math inline">\([1,A]\)</span> 和 <span class="math inline">\([1,B]\)</span> 上. 设 <span class="math inline">\(p_i\)</span> 表示位置为 <span class="math inline">\(i\)</span> 的颜色上次出现在 <span class="math inline">\(p_i\)</span></p>
<p>考虑点 <span class="math inline">\(i\)</span> 对于答案的贡献 , 如果 <span class="math inline">\(A &lt; i \leq B\)</span> , 那么贡献为 <span class="math inline">\([p_i \leq A]( A - p_i ) (B - i + 1)\)</span> , 如果 <span class="math inline">\(x \leq y , i\leq A\)</span> , 贡献为 <span class="math inline">\((i - p_i)(B - i + 1)\)</span> , 如果 <span class="math inline">\(y \leq x , i \leq A\)</span> , 贡献为 <span class="math inline">\((i - p_i)(A-i+1)\)</span> , 后两种多算了 <span class="math inline">\(x=y\)</span> 的情况 , 减一即可 , 然后就要维护上面的式子 , 先看第一种情况 <span class="math display">\[
\begin{aligned}
\sum_{i=A+1,[p_i\leq A]}^B(A-p_i)(B-i+1) = \sum_{i=A+1,[p_i\leq A]}^BA(B+1)-p_i(B+1)-Ai+p_ii
\end{aligned}
\]</span> 就要维护 , <span class="math inline">\(p_i\)</span> 的和 , <span class="math inline">\(i\)</span> 的和 , 满足条件的个数 , 以及 <span class="math inline">\(p_i,i\)</span> 的和. 对于第二种情况 <span class="math display">\[
\begin{aligned}
\sum_{i=1}^A(i-p_i)(B-i+1) = \sum_{i=1}^A B(i-p_i) - i(i-p_i) + (i-p_i)
\end{aligned}
\]</span> 第三中情况就是 <span class="math inline">\(A,B\)</span> 互换 , 这个对 <span class="math inline">\(p_i\)</span> 没有限制 , 直接前缀和即可</p>
<p>然后考虑树上的情况 , 对于 <span class="math inline">\(A,B\)</span> , 设 <span class="math inline">\((A,\text{lca})\)</span> 为较短的一段</p>
<p>分三种情况考虑 , 先是 <span class="math inline">\([1,\text{lca}),[1,B]\)</span> , 这就是序列上的情况</p>
<p>对于 <span class="math inline">\([1,\text{lca}),[\text{lca},A]\)</span> , 也是一条链 , 考虑计算 <span class="math inline">\([1,\text{lca}),[1,A]\)</span> 再减去多算的两点在 <span class="math inline">\([1,\text{lca}]\)</span> 的情况 , 这一部分是 <span class="math inline">\(\sum 2(i-p_i)(\text{lca}-i)-1\)</span> , 直接前缀和就可以了</p>
<p>对于 <span class="math inline">\([\text{lca},A],[\text{lca},B]\)</span> 的情况 , 分别考虑两个部分的贡献. 对于 <span class="math inline">\([\text{lca},B]\)</span> 中的点 <span class="math inline">\(i\)</span> , 其贡献为 <span class="math inline">\([p_i &lt; \text{lca}](B - i+ 1)(A-\text{lca}+1)\)</span> , 主席树维护. 对于 <span class="math inline">\([\text{lca},A]\)</span> 中的点 <span class="math inline">\(i\)</span> , 设其在 <span class="math inline">\([\text{lca},B]\)</span> 第一次出现的位置为 <span class="math inline">\(k\)</span> , 其贡献为 <span class="math inline">\([p_i &lt; \text{lca}](i-\text{lca}+1)(k-\text{lca})\)</span> , 暴力枚举 <span class="math inline">\([\text{lca},A]\)</span> 中的点即可 , 期望复杂度 <span class="math inline">\(O(\log n)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>; <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>( <span class="title">T</span> &amp; <span class="title">x</span> ) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> lol;</span><br><span class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; pii;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">2e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> LG = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; pos[N];</span><br><span class="line"><span class="keyword">int</span> head[N] , eidx , dep[N] , col[N] , las[N] , rt[N] , nidx , son[N &lt;&lt; <span class="number">5</span>][<span class="number">2</span>] , fa[N] , dfn[N] , dfc , Log[N &lt;&lt; <span class="number">1</span>] , n , p;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[N]; pii st[LG][N &lt;&lt; <span class="number">1</span>];</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123; edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx; &#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">  lol a , b , c , d;</span><br><span class="line">  node() &#123;&#125;</span><br><span class="line">  node( lol a , lol b , lol c , lol d ):a( a ) , b( b ) , c( c ) , d( d ) &#123;&#125;</span><br><span class="line">  node <span class="keyword">operator</span> + ( <span class="keyword">const</span> node &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> node( a + rhs.a , b + rhs.b , c + rhs.c , d + rhs.d ); &#125;</span><br><span class="line">  node <span class="keyword">operator</span> - ( <span class="keyword">const</span> node &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> node( a - rhs.a , b - rhs.b , c - rhs.c , d - rhs.d ); &#125;</span><br><span class="line">&#125; val[N &lt;&lt; <span class="number">5</span>];</span><br><span class="line"><span class="comment">// a = sum 1 , b = sum i , c = sum p_i , d = sum ip_i</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> SA, SB, SC;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">rng61</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SA ^= SA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    SA ^= SA &gt;&gt; <span class="number">5</span>;</span><br><span class="line">    SA ^= SA &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> t = SA;</span><br><span class="line">    SA = SB;</span><br><span class="line">    SB = SC;</span><br><span class="line">    SC ^= t ^ SA;</span><br><span class="line">    <span class="keyword">return</span> SC;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    read( n ) , read( p ) , read( SA ) , read( SB ) , read( SC );</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= p; i++)</span><br><span class="line">        addedge(i - <span class="number">1</span>, i);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = p + <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        addedge(rng61() % (i - <span class="number">1</span>) + <span class="number">1</span>, i);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        col[i] = rng61() % n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ins</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> &amp; u , <span class="keyword">int</span> v , <span class="keyword">int</span> pos , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  u = ++nidx; val[u].a = val[v].a + <span class="number">1</span>;</span><br><span class="line">  val[u].b = val[v].b + k; val[u].c = val[v].c + pos;</span><br><span class="line">  val[u].d = val[v].d + <span class="number">1L</span>L * k * pos;</span><br><span class="line">  <span class="keyword">if</span>( l == r ) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>( mid &gt;= pos ) ins( l , mid , son[u][<span class="number">0</span>] , son[v][<span class="number">0</span>] , pos , k ) , son[u][<span class="number">1</span>] = son[v][<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">else</span> ins( mid + <span class="number">1</span> , r , son[u][<span class="number">1</span>] , son[v][<span class="number">1</span>] , pos , k ) , son[u][<span class="number">0</span>] = son[v][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">node <span class="title">qry</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> v , <span class="keyword">int</span> L , <span class="keyword">int</span> R )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( L &gt; R ) <span class="keyword">return</span> node( <span class="number">0</span> , <span class="number">0</span> , <span class="number">0</span> , <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">if</span>( l &gt;= L &amp;&amp; r &lt;= R ) <span class="keyword">return</span> val[u] - val[v];</span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>( mid &gt;= R ) <span class="keyword">return</span> qry( l , mid , son[u][<span class="number">0</span>] , son[v][<span class="number">0</span>] , L , R );</span><br><span class="line">  <span class="keyword">if</span>( mid &lt; L ) <span class="keyword">return</span> qry( mid + <span class="number">1</span> , r , son[u][<span class="number">1</span>] , son[v][<span class="number">1</span>] , L , R );</span><br><span class="line">  <span class="keyword">return</span> qry( l , mid , son[u][<span class="number">0</span>] , son[v][<span class="number">0</span>] , L , R ) + qry( mid + <span class="number">1</span> , r , son[u][<span class="number">1</span>] , son[v][<span class="number">1</span>] , L , R );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lol S[N][<span class="number">2</span>];</span><br><span class="line"><span class="comment">// s0 = i - p_i , s1 = i(i-p_i)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> t = las[col[u]]; S[u][<span class="number">0</span>] = S[fa[u]][<span class="number">0</span>] + dep[u] - t; </span><br><span class="line">  S[u][<span class="number">1</span>] = S[fa[u]][<span class="number">1</span>] + <span class="number">1L</span>L * dep[u] * ( dep[u] - t );</span><br><span class="line">  ins( <span class="number">0</span> , n , rt[u] , rt[fa[u]] , las[col[u]] , dep[u] );</span><br><span class="line">  las[col[u]] = dep[u]; st[<span class="number">0</span>][dfn[u] = ++dfc] = pii( dep[u] , u );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt ) &#123;</span><br><span class="line">    dep[v = edge[i].to] = dep[u] + <span class="number">1</span>; fa[v] = u;</span><br><span class="line">    dfs( v ); st[<span class="number">0</span>][++dfc] = pii( dep[u] , u );</span><br><span class="line">  &#125;</span><br><span class="line">  las[col[u]] = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> k; l = dfn[l] , r = dfn[r];</span><br><span class="line">  <span class="keyword">if</span>( l &gt; r ) swap( l , r );</span><br><span class="line">  k = Log[r - l + <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">return</span> min( st[k][l] , st[k][r - ( <span class="number">1</span> &lt;&lt; k ) + <span class="number">1</span>] ).second;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">int</span> stk[N] , tp , vis[N] , <span class="keyword">vis_t</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">calc1</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> lca = LCA( u , v ) , res , flag;</span><br><span class="line">  <span class="keyword">if</span>( dep[u] &gt; dep[v] ) swap( u , v );</span><br><span class="line">  res = qry( <span class="number">0</span> , n , rt[v] , rt[fa[lca]] , <span class="number">0</span> , dep[lca] - <span class="number">1</span> ).a , ++<span class="keyword">vis_t</span>;</span><br><span class="line">  <span class="keyword">while</span>( u != lca ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( vis[col[u]] != <span class="keyword">vis_t</span> ) &#123;</span><br><span class="line">      flag = <span class="number">1</span>; <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">int</span> &amp; t : pos[col[u]] )</span><br><span class="line">        <span class="keyword">if</span>( LCA( t , v ) == t &amp;&amp; LCA( t , lca ) == lca ) </span><br><span class="line">          flag = <span class="number">0</span>;</span><br><span class="line">      res += flag;</span><br><span class="line">      vis[col[u]] = <span class="keyword">vis_t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    u = fa[u];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// chain [1,l] [l + 1,r]</span></span><br><span class="line"></span><br><span class="line">lol _calc( <span class="keyword">int</span> l , <span class="keyword">int</span> r ) &#123;</span><br><span class="line">  node tmp = qry( <span class="number">0</span> , n , rt[r] , rt[l] , <span class="number">0</span> , dep[l] ); </span><br><span class="line">  lol res = tmp.a * dep[l] * ( dep[r] + <span class="number">1</span> ) - tmp.c * ( dep[r] + <span class="number">1</span> ) - tmp.b * dep[l] + tmp.d;</span><br><span class="line">  res += ( dep[l] + dep[r] + <span class="number">2</span> ) * S[l][<span class="number">0</span>] - <span class="number">2</span> * S[l][<span class="number">1</span>] - dep[l]; </span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">lol <span class="title">calc2</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> lca = LCA( u , v ); lol res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>( dep[u] &gt; dep[v] ) swap( u , v );</span><br><span class="line">  res = _calc( fa[lca] , v );</span><br><span class="line">  res += _calc( fa[lca] , u );</span><br><span class="line">  res -= <span class="number">2</span> * ( S[fa[lca]][<span class="number">0</span>] * dep[lca] - S[fa[lca]][<span class="number">1</span>] ) - dep[fa[lca]];</span><br><span class="line">  node tmp = qry( <span class="number">0</span> , n , rt[v] , rt[fa[lca]] , <span class="number">0</span> , dep[fa[lca]] );</span><br><span class="line">  res += tmp.a * dep[v] * ( dep[u] - dep[lca] );</span><br><span class="line">  res -= tmp.b * ( dep[u] - dep[lca] );</span><br><span class="line">  res += tmp.a * ( dep[u] - dep[lca] + dep[v] );</span><br><span class="line">  res -= tmp.b; res += tmp.a;</span><br><span class="line">  tp = <span class="number">0</span> , ++<span class="keyword">vis_t</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> t = u ; t != fa[lca] ; t = fa[t] ) stk[++tp] = t;</span><br><span class="line">  <span class="keyword">while</span>( tp ) &#123;</span><br><span class="line">    <span class="keyword">int</span> now = stk[tp--] , mn = dep[v] + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>( vis[col[now]] == <span class="keyword">vis_t</span> ) <span class="keyword">continue</span>;</span><br><span class="line">    vis[col[now]] = <span class="keyword">vis_t</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">int</span> &amp; t : pos[col[now]] ) </span><br><span class="line">      <span class="keyword">if</span>( LCA( t , lca ) == lca &amp;&amp; LCA( t , v ) == t )</span><br><span class="line">        mn = min( mn , dep[t] );</span><br><span class="line">    res += <span class="number">1L</span>L * ( mn - dep[lca] ) * ( dep[u] - dep[now] + <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="built_in">memset</span>( head , <span class="number">0</span> , <span class="keyword">sizeof</span> head ) , eidx = <span class="number">0</span> , nidx = <span class="number">0</span> , dfc = <span class="number">0</span>; gen();</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) pos[i].clear();</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) pos[col[i]].push_back( i );</span><br><span class="line">  dep[<span class="number">1</span>] = <span class="number">1</span>; dfs( <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> k = <span class="number">1</span> ; ( <span class="number">1</span> &lt;&lt; k ) &lt;= dfc ; ++k )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = dfc - ( <span class="number">1</span> &lt;&lt; k ) + <span class="number">1</span> ; i &gt; <span class="number">0</span> ; --i )</span><br><span class="line">      st[k][i] = min( st[k - <span class="number">1</span>][i] , st[k - <span class="number">1</span>][i + ( <span class="number">1</span> &lt;&lt; ( k - <span class="number">1</span> ) )] );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= dfc ; ++i ) Log[i] = Log[i &gt;&gt; <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> m , opt , a , b;</span><br><span class="line">  read( m );</span><br><span class="line">  <span class="keyword">while</span>( m-- ) &#123;</span><br><span class="line">    read( opt ) , read( a ) , read( b );</span><br><span class="line">    <span class="keyword">if</span>( opt == <span class="number">1</span> ) <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,calc1( a , b ) );</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>,calc2( a , b ) );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> T; read( T );</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2018-旧试题"><a href="https://loj.ac/problem/2565" target="_blank" rel="noopener">[SDOI2018] 旧试题</a></h5>
<p>如果只有两个数 , 则有 $<em>{i=1}<sup>n<em>{j=1}^m d(ij)=</em>{i=1}</sup>n</em>{j=1}^m<em>{di} </em>{kj}[(d,k)=1] $ , 那么对于三个数的情况 , 有 <span class="math display">\[
\begin{aligned}
\sum_{i=1}^A\sum_{j=1}^B\sum_{k=1}^Cd(ijk)&amp;= \sum_{i=1}^A\sum_{j=1}^B\sum_{k=1}^C\sum_{a 
\mid i }\sum_{b \mid j} \sum_{c \mid k}[(a,b)=1][(a,c)=1][(b,c)=1] \\
&amp;=\sum_{i=1}^A\sum_{j=1}^B\sum_{k=1}^C\sum_{a 
\mid i }\sum_{b \mid j} \sum_{c \mid k}\sum_{o\mid (a,b)}\mu(o)\sum_{p\mid(a,c)}\mu(p)\sum_{q\mid(b,c)}\mu(q)\\
&amp;=\sum_{o=1}^{\min(A,B)}\sum_{p=1}^{\min(A,C)}\sum_{q=1}^{\min(B,C)}\mu(o)\mu(p)\mu(q)\left(\sum_{i=1}^{\lfloor \frac{A}{\text{lcm}(o,p)}\rfloor}d(i)\right)\left(\sum_{i=1}^{\lfloor \frac{B}{\text{lcm}(o,q)}\rfloor}d(i)\right)\left(\sum_{i=1}^{\lfloor \frac{C}{\text{lcm}(p,q)}\rfloor}d(i)\right)
\end{aligned}
\]</span> 设 <span class="math inline">\(f(n) = \sum_{i=1}^n d(i)\)</span> , 于是有 <span class="math display">\[
\text{Ans} = \sum_{o=1}^{\min(A,B)}\sum_{p=1}^{\min(A,C)}\sum_{q=1}^{\min(B,C)}\mu(o)\mu(p)\mu(q)f(\lfloor\frac{A}{\text{lcm}(o,p)}\rfloor)f(\lfloor \frac{B}{\text{lcm}(o,q)}\rfloor)f(\lfloor \frac{C}{\text{lcm}(p,q)}\rfloor)
\]</span></p>
<p>对于 <span class="math inline">\(\mu(o)\mu(q)\mu(q)\)</span> , 要有贡献则要都不为 <span class="math inline">\(0\)</span> , 于是可以枚举每个质数是否在 <span class="math inline">\(o,q,p\)</span> 中出现 , 总共 <span class="math inline">\(8\)</span> 种情况</p>
<p>还需要加入一些优化 , 从大往小枚举质数搜索深度更小 , 同时注意到 , 对于一个质数 , 如果在 <span class="math inline">\(o,p,q\)</span> 中至少两个出现 , <span class="math inline">\(\text{lcm}\)</span> 是一样的 , 也就是 <span class="math inline">\(A,B,C\)</span> 除去的数相同 , 那么只计算一次 , 并且对于当前一个质数 <span class="math inline">\(p\)</span> , 如果 <span class="math inline">\(A&lt;p,B&lt;p,C&lt;p\)</span> , 且 <span class="math inline">\(\max(A,B,C)\)</span> 较小 , 那么直接返回预处理的值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">45</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125; </span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod;</span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> prime[N] , prime_tot , d[N] , pk[N] , f[M][M][M] , sum[N];</span><br><span class="line"><span class="keyword">bool</span> vis[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A , B , C;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> A , <span class="keyword">int</span> B , <span class="keyword">int</span> C )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( !A || !B || !C ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>( !u ) <span class="keyword">return</span> <span class="number">1L</span>L * sum[A] * sum[B] % mod * sum[C] % mod;</span><br><span class="line">  <span class="keyword">int</span> mx = max( A , max( B , C ) ) , res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>( prime[u] &gt; mx &amp;&amp; mx &lt; M ) <span class="keyword">return</span> f[A][B][C];</span><br><span class="line">  inc( res , dfs( u - <span class="number">1</span> , A , B , C ) );</span><br><span class="line">  <span class="keyword">if</span>( prime[u] &lt;= A &amp;&amp; prime[u] &lt;= B ) dec( res , dfs( u - <span class="number">1</span> , A / prime[u] , B / prime[u] , C ) );</span><br><span class="line">  <span class="keyword">if</span>( prime[u] &lt;= A &amp;&amp; prime[u] &lt;= C ) dec( res , dfs( u - <span class="number">1</span> , A / prime[u] , B , C / prime[u] ) );</span><br><span class="line">  <span class="keyword">if</span>( prime[u] &lt;= B &amp;&amp; prime[u] &lt;= C ) dec( res , dfs( u - <span class="number">1</span> , A , B / prime[u] , C / prime[u] ) );</span><br><span class="line">  <span class="keyword">if</span>( prime[u] &lt;= A &amp;&amp; prime[u] &lt;= B &amp;&amp; prime[u] &lt;= C ) &#123;</span><br><span class="line">    mx = dfs( u - <span class="number">1</span> , A / prime[u] , B / prime[u] , C / prime[u] );</span><br><span class="line">    inc( res , pls( mx , mx ) );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="built_in">cin</span> &gt;&gt; A &gt;&gt; B &gt;&gt; C;</span><br><span class="line">  <span class="keyword">int</span> cur = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( prime[cur + <span class="number">1</span>] &lt;= max( max( A , B ) , C ) ) ++cur;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; dfs( cur , A , B , C ) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  d[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt; N ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !vis[i] ) prime[++prime_tot] = i , d[i] = <span class="number">2</span> , pk[i] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= prime_tot ; ++j ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( <span class="number">1L</span>L * prime[j] * i &gt;= N ) <span class="keyword">break</span>;</span><br><span class="line">      vis[i * prime[j]] = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>( i % prime[j] ) &#123;</span><br><span class="line">        pk[i * prime[j]] = <span class="number">1</span>;</span><br><span class="line">        d[i * prime[j]] = d[i] * <span class="number">2</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pk[i * prime[j]] = pk[i] + <span class="number">1</span>;</span><br><span class="line">        d[i * prime[j]] = d[i] / ( pk[i] + <span class="number">1</span> ) * ( pk[i] + <span class="number">2</span> );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; M ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt; M ; ++j )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> k = <span class="number">1</span> ; k &lt; M ; ++k ) &#123;</span><br><span class="line">        inc( f[i][j][k] , f[i - <span class="number">1</span>][j][k] );</span><br><span class="line">        inc( f[i][j][k] , f[i][j - <span class="number">1</span>][k] );</span><br><span class="line">        inc( f[i][j][k] , f[i][j][k - <span class="number">1</span>] );</span><br><span class="line">        dec( f[i][j][k] , f[i - <span class="number">1</span>][j - <span class="number">1</span>][k] );</span><br><span class="line">        dec( f[i][j][k] , f[i - <span class="number">1</span>][j][k - <span class="number">1</span>] );</span><br><span class="line">        dec( f[i][j][k] , f[i][j - <span class="number">1</span>][k - <span class="number">1</span>] );</span><br><span class="line">        inc( f[i][j][k] , f[i - <span class="number">1</span>][j - <span class="number">1</span>][k - <span class="number">1</span>] );</span><br><span class="line">        inc( f[i][j][k] , d[i * j * k] );</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; N ; ++i )</span><br><span class="line">    sum[i] = pls( sum[i - <span class="number">1</span>] , d[i] );</span><br><span class="line">  <span class="keyword">int</span> T; <span class="built_in">cin</span> &gt;&gt; T;</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2018-荣誉称号"><a href="https://loj.ac/problem/2566" target="_blank" rel="noopener">[SDOI2018] 荣誉称号</a></h5>
<p>先考虑序列上的问题 , 要求 <span class="math inline">\(\sum_{i=1}^{k+1} a_i \equiv 0 \pmod m ,\sum_{i=2}^{k+2}a_i\equiv 0 \pmod m\)</span> , 也就是 <span class="math inline">\(a_1 \equiv a_{k+2} \pmod m\)</span> , 于是对于所有 <span class="math inline">\(x\)</span> , <span class="math inline">\(a_x \equiv a_{x\bmod {k+1}} \pmod m\)</span> , 那么确定了前 <span class="math inline">\(k+1\)</span> 个点就确定了整个序列</p>
<p>接着考虑树上的操作 , 对于 <span class="math inline">\(x \geq 2^{k+1}\)</span> , 可以找出 <span class="math inline">\(p_x\)</span> 表示跳 <span class="math inline">\(k+1\)</span> 次到达的点 , 于是有 <span class="math inline">\(a_{x} \equiv a_{p_x} \pmod m\)</span> , 然后就只用考虑剩下这些不受上面点限制的点 , 由于是完全二叉树 , 点数只有 <span class="math inline">\(2^k\)</span> 个</p>
<p>考虑预处理 <span class="math inline">\(w_{x,y}\)</span> 表示点 <span class="math inline">\(x\)</span> 改为 <span class="math inline">\(y\)</span> 所需的最小花费 , 要将与之相关的点权都更改 , 然后直接设 <span class="math inline">\(f_{i,j}\)</span> 表示点 <span class="math inline">\(i\)</span> 到所有叶子节点的点权和为 <span class="math inline">\(j\)</span> 时的最小花费 , 直接 <span class="math inline">\(O(2^k m^2)\)</span> 就行了</p>
<p>计算 <span class="math inline">\(w_{x,k}\)</span> 发现对于每个点 <span class="math inline">\(y\)</span> , <span class="math inline">\(p_y = x\)</span> , 对 <span class="math inline">\(w_{x,k}\)</span> 的贡献是分段的一次函数 , 就可以直接差分最后求一遍前缀和即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> lol;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1</span> &lt;&lt; <span class="number">12</span> | <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">2e2</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> X = <span class="number">1e7</span> + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line">lol f[N][M] , w[N][M] , sum[N];</span><br><span class="line"><span class="keyword">int</span> a[X] , b[X] , n , k , m , d[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> SA, SB, SC; <span class="keyword">int</span> p, A, B;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">rng61</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SA ^= SA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    SA ^= SA &gt;&gt; <span class="number">5</span>;</span><br><span class="line">    SA ^= SA &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> t = SA;</span><br><span class="line">    SA = SB;</span><br><span class="line">    SB = SC;</span><br><span class="line">    SC ^= t ^ SA;</span><br><span class="line">    <span class="keyword">return</span> SC;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d%d%d%u%u%u%d%d"</span>, &amp;n, &amp;k, &amp;m, &amp;p, &amp;SA, &amp;SB, &amp;SC, &amp;A, &amp;B);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= p; i++) _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;a[i], &amp;b[i]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = p + <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">        a[i] = rng61() % A + <span class="number">1</span>;</span><br><span class="line">        b[i] = rng61() % B + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> lim , _k;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">work</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  a[u] %= m;</span><br><span class="line">  <span class="keyword">while</span>( ( u &gt;&gt; _k ) &gt; lim ) _k += k;</span><br><span class="line">  <span class="keyword">int</span> x = ( u &gt;&gt; _k );</span><br><span class="line">  sum[x] += b[u];</span><br><span class="line">  w[x][<span class="number">0</span>] += <span class="number">1L</span>L * ( m - a[u] ) * b[u];</span><br><span class="line">  w[x][a[u]] -= <span class="number">1L</span>L * m * b[u];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ls = u &lt;&lt; <span class="number">1</span> , rs = u &lt;&lt; <span class="number">1</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>( ls &gt; lim ) &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i )</span><br><span class="line">      f[u][i] = w[u][i];</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  dfs( ls );</span><br><span class="line">  <span class="keyword">if</span>( rs &gt; lim || d[ls] != d[rs] ) &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; m ; ++j )</span><br><span class="line">        f[u][( i + j ) % m] = min( f[u][( i + j ) % m] , f[ls][i] + w[u][j] );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  dfs( rs );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; m ; ++j )</span><br><span class="line">      f[u][( i + j ) % m] = min( f[u][( i + j ) % m] , f[ls][i] + f[rs][i] + w[u][j] );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  gen(); ++k , _k = <span class="number">0</span>;</span><br><span class="line">  lim = min( n , ( <span class="number">1</span> &lt;&lt; k ) - <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= lim ; ++i ) &#123;</span><br><span class="line">    sum[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt;= m ; ++j )</span><br><span class="line">      w[i][j] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) work( i );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= lim ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt; m ; ++j )</span><br><span class="line">      w[i][j] += sum[i] + w[i][j - <span class="number">1</span>];</span><br><span class="line">  <span class="built_in">memset</span>( f , <span class="number">0x3f</span> , <span class="keyword">sizeof</span> f );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = lim ; i ; --i ) &#123;</span><br><span class="line">    d[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( ( i &lt;&lt; <span class="number">1</span> ) &lt;= lim ) d[i] = d[i &lt;&lt; <span class="number">1</span>];</span><br><span class="line">    ++d[i];</span><br><span class="line">  &#125;</span><br><span class="line">  dfs( <span class="number">1</span> );</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; f[<span class="number">1</span>][<span class="number">0</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> T;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T);</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/09/Solutions/QBXT2020-Day6-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/" rel="prev" title="[QBXT2020] Day6 简要题解">
      <i class="fa fa-chevron-left"></i> [QBXT2020] Day6 简要题解
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/10/Solutions/QBXT2020-Day7-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/" rel="next" title="[QBXT2020] Day7 简要题解 ">
      [QBXT2020] Day7 简要题解  <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2018-物理实验"><span class="nav-number">1.</span> <span class="nav-text">[SDOI2018] 物理实验</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2018-战略游戏"><span class="nav-number">2.</span> <span class="nav-text">[SDOI2018] 战略游戏</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2018-反回文串"><span class="nav-number">3.</span> <span class="nav-text">[SDOI2018] 反回文串</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2018-原题识别"><span class="nav-number">4.</span> <span class="nav-text">[SDOI2018] 原题识别</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#离线做法"><span class="nav-number">4.1.</span> <span class="nav-text">离线做法</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#在线做法"><span class="nav-number">4.2.</span> <span class="nav-text">在线做法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2018-旧试题"><span class="nav-number">5.</span> <span class="nav-text">[SDOI2018] 旧试题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2018-荣誉称号"><span class="nav-number">6.</span> <span class="nav-text">[SDOI2018] 荣誉称号</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Guyan</p>
  <div class="site-description" itemprop="description">水平低啊</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guyan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
