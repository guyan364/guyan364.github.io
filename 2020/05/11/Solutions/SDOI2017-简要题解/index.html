<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="给出简要思路和代码">
<meta property="og:type" content="article">
<meta property="og:title" content="[SDOI2017] 简要题解">
<meta property="og:url" content="http://yoursite.com/2020/05/11/Solutions/SDOI2017-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/index.html">
<meta property="og:site_name" content="Guyan&#39;s blog">
<meta property="og:description" content="给出简要思路和代码">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-11T13:21:58.000Z">
<meta property="article:modified_time" content="2020-05-12T13:09:16.923Z">
<meta property="article:author" content="Guyan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/05/11/Solutions/SDOI2017-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>[SDOI2017] 简要题解 | Guyan's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Guyan's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/Solutions/SDOI2017-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guyan">
      <meta itemprop="description" content="水平低啊">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guyan's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [SDOI2017] 简要题解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 21:21:58" itemprop="dateCreated datePublished" datetime="2020-05-11T21:21:58+08:00">2020-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-12 21:09:16" itemprop="dateModified" datetime="2020-05-12T21:09:16+08:00">2020-05-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>给出简要思路和代码</p>
<a id="more"></a>
<h5 id="sdoi2017-数字表格"><a href="https://loj.ac/problem/2000" target="_blank" rel="noopener">[SDOI2017] 数字表格</a></h5>
<p>令 <span class="math inline">\(n \leq m\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
\prod_{g=1}^nf(g)^{\sum_{i=1}^n\sum_{j=1}^m[(i,j)=g]} &amp;= \prod_{g=1}^nf(g)^{\sum_{i=1}^{\lfloor \frac{n}{g} \rfloor}\sum_{j=1}^{\lfloor\frac{m}{g} \rfloor}[(i,j)=1]} \\
\sum_{i=1}^{\lfloor \frac{n}{g} \rfloor}\sum_{j=1}^{\lfloor\frac{m}{g} \rfloor}[(i,j)=1]&amp;=\sum_{d=1}^{\lfloor\frac{n}{g}\rfloor}\mu(d)\lfloor\frac{n}{gd}\rfloor\lfloor\frac{m}{gd}\rfloor \\
\prod_{T=1}^n\prod_{d\mid T}f(d)^{\mu(\frac{T}{D})\lfloor\frac{n}{T}\rfloor\lfloor\frac{m}{T}\rfloor}&amp;=\prod_{T=1}^n\left(\prod_{d\mid T}f(d)^{\mu(\frac{T}{D})}\right)^{\lfloor\frac{n}{T}\rfloor\lfloor\frac{m}{T}\rfloor}
\end{aligned}
\]</span></p>
<p>整除分块即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e6</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">long</span> <span class="keyword">long</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod;</span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">return</span> res;</span><br><span class="line">&#125; <span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> prime[N] , prime_tot , vis[N] , mu[N] , n , m , f[N] , g[N] , invg[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;n,&amp;m);</span><br><span class="line">  <span class="keyword">if</span>( n &gt; m ) swap( n , m );</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span> , tmp;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , r ; i &lt;= n ; i = r + <span class="number">1</span> ) &#123;</span><br><span class="line">    r = min( n / ( n / i ) , m / ( m / i ) );</span><br><span class="line">    tmp = <span class="number">1L</span>L * g[r] * invg[i - <span class="number">1</span>] % mod;</span><br><span class="line">    res = <span class="number">1L</span>L * res * fpow( tmp , <span class="number">1L</span>L * ( n / i ) * ( m / i ) ) % mod;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  mu[<span class="number">1</span>] = f[<span class="number">1</span>] = g[<span class="number">1</span>] = invg[<span class="number">0</span>] = <span class="number">1</span>; </span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt; N ; ++i ) &#123;</span><br><span class="line">    f[i] = pls( f[i - <span class="number">1</span>] , f[i - <span class="number">2</span>] ) , g[i] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>( !vis[i] ) prime[++prime_tot] = i , mu[i] = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= prime_tot ; ++j ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( <span class="number">1L</span>L * prime[j] * i &gt;= N ) <span class="keyword">break</span>;</span><br><span class="line">      vis[i * prime[j]] = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>( i % prime[j] ) mu[i * prime[j]] = -mu[i];</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , a , b ; i &lt; N ; ++i ) &#123;</span><br><span class="line">    a = f[i] , b = fpow( f[i] , mod - <span class="number">2</span> );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = i ; j &lt; N ; j +=i ) </span><br><span class="line">      <span class="keyword">if</span>( mu[j / i] == <span class="number">1</span> ) g[j] = <span class="number">1L</span>L * g[j] * a % mod;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>( mu[j / i] == <span class="number">-1</span> ) g[j] = <span class="number">1L</span>L * g[j] * b % mod;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt; N ; ++i ) &#123;</span><br><span class="line">    invg[i - <span class="number">1</span>] = g[i];</span><br><span class="line">    g[i] = <span class="number">1L</span>L * g[i - <span class="number">1</span>] * g[i] % mod;</span><br><span class="line">  &#125; invg[N - <span class="number">1</span>] = fpow( g[N - <span class="number">1</span>] , mod - <span class="number">2</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = N - <span class="number">2</span> ; i ; --i )</span><br><span class="line">    invg[i] = <span class="number">1L</span>L * invg[i] * invg[i + <span class="number">1</span>] % mod;</span><br><span class="line">  <span class="keyword">int</span> T; _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T);</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-树点涂色"><a href="https://loj.ac/problem/2001" target="_blank" rel="noopener">[SDOI2017] 树点涂色</a></h5>
<p>将颜色相同的点放在一段 , 发现树分为了多个直上直下的链 , 每次更改就是将一个点上面的所有点连起来 , 发现这就是 <span class="math inline">\(\rm LCT\)</span> 的 <span class="math inline">\(\rm access\)</span> 操作 , 于是维护一颗 <span class="math inline">\(\rm LCT\)</span> , 每次修改就是在更改虚实链的时候将当前链顶在原树中子树的点的答案减一 , 数据结构维护即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>; <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>( <span class="title">T</span> &amp; <span class="title">x</span> ) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> SEG &#123;</span><br><span class="line">  <span class="keyword">int</span> val[N &lt;&lt; <span class="number">2</span>] , tag[N &lt;&lt; <span class="number">2</span>];</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">up</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123; val[u] = max( val[u &lt;&lt; <span class="number">1</span>] , val[u &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] ); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">dn</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( !tag[u] ) <span class="keyword">return</span>;</span><br><span class="line">    tag[u &lt;&lt; <span class="number">1</span>] += tag[u] , tag[u &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] += tag[u];</span><br><span class="line">    val[u &lt;&lt; <span class="number">1</span>] += tag[u] , val[u &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] += tag[u];</span><br><span class="line">    tag[u] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> * dat )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( l == r ) &#123; val[u] = dat[l]; <span class="keyword">return</span>; &#125;</span><br><span class="line">    <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    build( l , mid , u &lt;&lt; <span class="number">1</span> , dat );</span><br><span class="line">    build( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , dat );</span><br><span class="line">    up( u );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">mdf</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> L , <span class="keyword">int</span> R , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( l &gt;= L &amp;&amp; r &lt;= R ) &#123; val[u] += k , tag[u] += k; <span class="keyword">return</span>; &#125;</span><br><span class="line">    <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    dn( u );</span><br><span class="line">    <span class="keyword">if</span>( mid &gt;= L ) mdf( l , mid , u &lt;&lt; <span class="number">1</span> , L , R , k );</span><br><span class="line">    <span class="keyword">if</span>( mid &lt; R ) mdf( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , L , R , k );</span><br><span class="line">    up( u );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">qry</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> L , <span class="keyword">int</span> R )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( l &gt;= L &amp;&amp; r &lt;= R ) <span class="keyword">return</span> val[u];</span><br><span class="line">    <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span> , res = <span class="number">-100</span>; dn( u );</span><br><span class="line">    <span class="keyword">if</span>( mid &gt;= L ) res = max( res , qry( l , mid , u &lt;&lt; <span class="number">1</span> , L , R ) );</span><br><span class="line">    <span class="keyword">if</span>( mid &lt; R ) res = max( res , qry( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , L , R ) );</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> dfn[N] , dfc , son[N] , top[N] , siz[N] , flx[N] , head[N] , eidx , fa[N] , dep[N] , n , m;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[N &lt;&lt; <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[v] , u &#125;; head[v] = eidx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  siz[u] = <span class="number">1</span>; </span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != fa[u] ) &#123;</span><br><span class="line">      dep[v] = dep[u] + <span class="number">1</span> , fa[v] = u;</span><br><span class="line">      dfs( v ); siz[u] += siz[v];</span><br><span class="line">      <span class="keyword">if</span>( siz[v] &gt; siz[son[u]] ) son[u] = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> ftop )</span> </span>&#123;</span><br><span class="line">  top[u] = ftop , flx[dfn[u] = ++dfc] = dep[u] + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>( son[u] ) dfs( son[u] , ftop );</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != son[u] &amp;&amp; v != fa[u] ) </span><br><span class="line">      dfs( v , v );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> LCT &#123;</span><br><span class="line">  <span class="keyword">int</span> p[N] , son[N][<span class="number">2</span>];</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">noroot</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123; <span class="keyword">return</span> p[u] ? son[p[u]][<span class="number">0</span>] == u || son[p[u]][<span class="number">1</span>] == u : <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">which</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123; <span class="keyword">return</span> p[u] ? son[p[u]][<span class="number">1</span>] == u : <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">rotate</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> w , f; f = p[u] , w = which( u );</span><br><span class="line">    p[u] = p[f]; <span class="keyword">if</span>( noroot( f ) ) son[p[f]][which( f )] = u;</span><br><span class="line">    <span class="keyword">if</span>( ( son[f][w] = son[u][w ^ <span class="number">1</span>] ) ) p[son[u][w ^ <span class="number">1</span>]] = f;</span><br><span class="line">    p[son[u][w ^ <span class="number">1</span>] = f] = u;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">splay</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> f;</span><br><span class="line">    <span class="keyword">while</span>( noroot( u ) ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( noroot( ( f = p[u] ) ) ) rotate( which( u ) ^ which( f ) ? u : f );</span><br><span class="line">      rotate( u );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">access</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> t = <span class="number">0</span> , u ; x ; t = x , x = p[x] ) &#123;</span><br><span class="line">      splay( x );</span><br><span class="line">      <span class="keyword">if</span>( ( u = son[x][<span class="number">1</span>] ) ) &#123;</span><br><span class="line">        <span class="keyword">while</span>( son[u][<span class="number">0</span>] ) u = son[u][<span class="number">0</span>];</span><br><span class="line">        SEG::mdf( <span class="number">1</span> , n , <span class="number">1</span> , dfn[u] , dfn[u] + siz[u] - <span class="number">1</span> , <span class="number">1</span> );</span><br><span class="line">      &#125;</span><br><span class="line">      son[x][<span class="number">1</span>] = t;</span><br><span class="line">      <span class="keyword">if</span>( ( u = t ) ) &#123;</span><br><span class="line">        <span class="keyword">while</span>( son[u][<span class="number">0</span>] ) u = son[u][<span class="number">0</span>];</span><br><span class="line">        SEG::mdf( <span class="number">1</span> , n , <span class="number">1</span> , dfn[u] , dfn[u] + siz[u] - <span class="number">1</span> , <span class="number">-1</span> );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>( top[u] != top[v] ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( dep[top[u]] &lt; dep[top[v]] ) swap( u , v );</span><br><span class="line">    u = fa[top[u]];</span><br><span class="line">  &#125; <span class="keyword">return</span> dep[u] &lt; dep[v] ? u : v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  read( n ) , read( m );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u , v ; i &lt; n ; ++i ) &#123;</span><br><span class="line">    read( u ) , read( v );</span><br><span class="line">    addedge( u , v );</span><br><span class="line">  &#125;</span><br><span class="line">  dfs( <span class="number">1</span> );</span><br><span class="line">  dfs( <span class="number">1</span> , <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">  SEG::build( <span class="number">1</span> , n , <span class="number">1</span> , flx );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= n ; ++i )</span><br><span class="line">    LCT::p[i] = fa[i];</span><br><span class="line">  <span class="keyword">int</span> opt , x , y , lca;</span><br><span class="line">  <span class="keyword">while</span>( m-- ) &#123;</span><br><span class="line">    read( opt ) , read( x );</span><br><span class="line">    <span class="keyword">if</span>( opt == <span class="number">1</span> )</span><br><span class="line">      LCT::access( x );</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( opt == <span class="number">3</span> ) <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,SEG::qry( <span class="number">1</span> , n , <span class="number">1</span> , dfn[x] , dfn[x] + siz[x] - <span class="number">1</span> ) );</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      read( y );</span><br><span class="line">      lca = LCA( x , y );</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,SEG::qry( <span class="number">1</span> , n , <span class="number">1</span> , dfn[x] , dfn[x] ) + SEG::qry( <span class="number">1</span> , n , <span class="number">1</span> , dfn[y] , dfn[y] ) </span><br><span class="line">          -SEG::qry( <span class="number">1</span> , n , <span class="number">1</span> , dfn[lca] , dfn[lca] ) * <span class="number">2</span> + <span class="number">1</span> );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-序列计数"><a href="https://loj.ac/problem/2002" target="_blank" rel="noopener">[SDOI2017] 序列计数</a></h5>
<p>用所有数都可以用的方案数减去没有质数的方案数. 设 <span class="math inline">\(f_{i,j}\)</span> 表示长度为 <span class="math inline">\(i\)</span> , 现在和为 <span class="math inline">\(j\)</span> 的方案数 , 每次枚举下一个数是多少转移 , 矩阵快速幂加速即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">2e7</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> K = <span class="number">1e2</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">20170408</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">if</span>( ( a += b ) &gt;= mod ) a -= mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">return</span> a - b &lt; <span class="number">0</span> ? a - b + mod : a - b; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> prime[N / <span class="number">10</span>] , prime_tot , n , m , val[K] , p;</span><br><span class="line"><span class="keyword">bool</span> vis[N];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Matrix</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> v[K][K];</span><br><span class="line">  Matrix <span class="keyword">operator</span> * ( <span class="keyword">const</span> Matrix &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Matrix res;</span><br><span class="line">    <span class="built_in">memset</span>( res.v , <span class="number">0</span> , <span class="keyword">sizeof</span> res.v );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; p ; ++i )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> k = <span class="number">0</span> ; k &lt; p ; ++k )</span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; p ; ++j )</span><br><span class="line">          inc( res.v[i][j] , <span class="number">1L</span>L * v[i][k] * rhs.v[k][j] % mod );</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">  Matrix <span class="keyword">operator</span> ^ ( <span class="keyword">int</span> k ) &#123;</span><br><span class="line">    Matrix res , base;</span><br><span class="line">    base = *<span class="keyword">this</span>;</span><br><span class="line">    <span class="built_in">memset</span>( res.v , <span class="number">0</span> , <span class="keyword">sizeof</span> res.v );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; p ; ++i ) res.v[i][i] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = res * base;</span><br><span class="line">      base = base * base; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; mat;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="built_in">cin</span> &gt;&gt; n &gt;&gt; m &gt;&gt; p;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> , t = min( p , m + <span class="number">1</span> ) ; i &lt; t ; ++i ) </span><br><span class="line">    val[i] = ( m - i ) / p + <span class="number">1</span>;</span><br><span class="line">  --val[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; p ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; p ; ++j )</span><br><span class="line">      inc( mat.v[( i + j ) % p][i] , val[j] );</span><br><span class="line">  <span class="keyword">int</span> res = ( mat^n ).v[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">  vis[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= m ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !vis[i] ) prime[++prime_tot] = i , --val[i % p];</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= prime_tot ; ++j ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( <span class="number">1L</span>L * i * prime[j] &gt; m ) <span class="keyword">break</span>;</span><br><span class="line">      vis[i * prime[j]] = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>( i % prime[j] == <span class="number">0</span> ) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>( mat.v , <span class="number">0</span> , <span class="keyword">sizeof</span> mat.v );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; p ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; p ; ++j )</span><br><span class="line">      inc( mat.v[( i + j ) % p][i] , val[j] );</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%d"</span>,mns( res , ( mat^n ).v[<span class="number">0</span>][<span class="number">0</span>] ) );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-新生舞会"><a href="https://loj.ac/problem/2003" target="_blank" rel="noopener">[SDOI2017] 新生舞会</a></h5>
<p>分数规划 , 二分 <span class="math inline">\(C\)</span> , 得到 <span class="math inline">\(\sum_{i=1}^n a_i - Cb_i = 0\)</span> , 于是每次更改匹配权值为 <span class="math inline">\(a_{i,j} - Cb_{i,j}\)</span> , 然后跑一遍最大匹配即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">5e2</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> eps = <span class="number">1e-7</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> INF = <span class="number">1e15</span>;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , A[N][N] , B[N][N] , head[N] , eidx , head_backup[N] , eidx_backup , fl[N] , que[N * N] , he , ta , st , ed , las[N];</span><br><span class="line"><span class="keyword">double</span> dis[N]; <span class="keyword">bool</span> inq[N];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to , flow , cap; <span class="keyword">double</span> cost; &#125; edge[N * N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v , <span class="keyword">int</span> cap , <span class="keyword">double</span> cost )</span> </span>&#123;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[u] , v , <span class="number">0</span> , cap , cost &#125;; head[u] = eidx;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[v] , u , <span class="number">0</span> , <span class="number">0</span> , -cost &#125;; head[v] = eidx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">spfa</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> u;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> , t = n * <span class="number">2</span> + <span class="number">1</span> ; i &lt;= t ; ++i ) dis[i] = INF , fl[i] = <span class="number">0</span>;</span><br><span class="line">  fl[que[he = ta = <span class="number">1</span>] = st] = <span class="number">0x3f3f3f3f</span> , dis[st] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>( he &lt;= ta ) &#123;</span><br><span class="line">    inq[u = que[he++]] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; ~i ; i = edge[i].nxt )</span><br><span class="line">      <span class="keyword">if</span>( edge[i].flow &lt; edge[i].cap &amp;&amp; dis[v = edge[i].to] &gt; dis[u] + edge[i].cost ) &#123;</span><br><span class="line">        dis[v] = dis[u] + edge[i].cost , fl[v] = min( fl[u] , edge[i].cap - edge[i].flow );</span><br><span class="line">        las[v] = i;</span><br><span class="line">        <span class="keyword">if</span>( !inq[v] ) inq[que[++ta] = v] = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fl[ed] != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">MCMF</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> u;</span><br><span class="line">  <span class="keyword">double</span> res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>( spfa() ) &#123;</span><br><span class="line">    u = ed;</span><br><span class="line">    res += dis[ed] * fl[ed];</span><br><span class="line">    <span class="keyword">while</span>( u != st ) &#123;</span><br><span class="line">      edge[las[u]].flow += fl[ed];</span><br><span class="line">      edge[las[u] ^ <span class="number">1</span>].flow -= fl[ed];</span><br><span class="line">      u = edge[las[u] ^ <span class="number">1</span>].to;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">jud</span><span class="params">( <span class="keyword">double</span> M )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= n ; ++j )</span><br><span class="line">      addedge( i , j + n , <span class="number">1</span> , -(A[i][j] - M * B[i][j]) );</span><br><span class="line">  <span class="keyword">double</span> res = -MCMF();</span><br><span class="line">  <span class="built_in">memcpy</span>( head , head_backup , <span class="keyword">sizeof</span> head ) , eidx = eidx_backup;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= eidx ; ++i ) edge[i].flow = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> res &gt; -eps;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;n);</span><br><span class="line">  st = <span class="number">0</span> , ed = n * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= n ; ++j )</span><br><span class="line">      _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,A[i]+j);</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= n ; ++j )</span><br><span class="line">      _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,B[i]+j);</span><br><span class="line">  <span class="built_in">memset</span>( head , <span class="number">-1</span> , <span class="keyword">sizeof</span> head ) , eidx = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    addedge( st , i , <span class="number">1</span> , <span class="number">0</span> );</span><br><span class="line">    addedge( i + n , ed , <span class="number">1</span> , <span class="number">0</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>( head_backup , head , <span class="keyword">sizeof</span> head ) , eidx_backup = eidx;</span><br><span class="line">  <span class="keyword">double</span> l = <span class="number">0</span> , r = <span class="number">1e4</span> , mid , res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>( r - l &gt; eps ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( jud( ( mid = ( l + r ) / <span class="number">2</span> ) ) ) res = mid , l = mid;</span><br><span class="line">    <span class="keyword">else</span> r = mid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%.6f"</span>,res);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-硬币游戏"><a href="https://loj.ac/problem/2004" target="_blank" rel="noopener">[SDOI2017] 硬币游戏</a></h5>
<p>暴力的想法是直接建出 <span class="math inline">\(\rm AC\)</span> 自动机 , 然后直接高斯消元 , 当然这样节点数太多 , 过不了. 考虑优化状态数 , 增设一个状态表示无限走下去的概率 , 设为 <span class="math inline">\(f_0\)</span> , 设 <span class="math inline">\(f_i(i &gt; 0)\)</span> 表示最后停在第 <span class="math inline">\(i\)</span> 个字符串的概率 , 可以得到 <span class="math display">\[
\begin{aligned} 
\sum_{i=1}^nf_i &amp;= 1 \\
f_i&amp;=f_0\cdot \frac{1}{2^m}-\sum_{j\neq i}^nf_j\sum_{s_{i,[1,m-k+1]}=s_{j,[k,m]}}\frac{1}{2^{k-1}}
\end{aligned}
\]</span> 后面 <span class="math inline">\(s_{i,[1,m-k+1]}=s_{j,[k,m]}\)</span> 表示 <span class="math inline">\(s_j\)</span> 的后缀是 <span class="math inline">\(s_i\)</span> 的前缀. <span class="math inline">\(n+1\)</span> 个变量 , <span class="math inline">\(n+1\)</span> 个方程 , 就可以直接高斯消元了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">3e2</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = N * N;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> trs[M][<span class="number">2</span>] , lnk[M] , head[M] , eidx , dep[M] , nidx , n , m , u , que[M] , he , ta , id[N];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[M];</span><br><span class="line"><span class="keyword">char</span> str[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> mat[N][N] , Pow[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">guass</span><span class="params">( <span class="keyword">int</span> n )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> , t ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    t = i; <span class="keyword">for</span>( <span class="keyword">int</span> j = i + <span class="number">1</span> ; j &lt;= n ; ++j )</span><br><span class="line">      <span class="keyword">if</span>( <span class="built_in">fabs</span>( mat[j][i] ) &gt; <span class="built_in">fabs</span>( mat[t][i] ) ) t = j;</span><br><span class="line">    <span class="keyword">if</span>( t != i ) swap( mat[i] , mat[t] );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = i + <span class="number">1</span> ; j &lt;= n ; ++j ) &#123;</span><br><span class="line">      <span class="keyword">double</span> tmp = mat[j][i] / mat[i][i];</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> k = i ; k &lt;= n + <span class="number">1</span> ; ++k )</span><br><span class="line">        mat[j][k] -= tmp * mat[i][k];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = n ; ~i ; --i ) &#123;</span><br><span class="line">    mat[i][n + <span class="number">1</span>] /= mat[i][i];</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = i - <span class="number">1</span> ; ~j ; --j )</span><br><span class="line">      mat[j][n + <span class="number">1</span>] -= mat[j][i] * mat[i][n + <span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;n,&amp;m);</span><br><span class="line">  Pow[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= m ; ++i ) Pow[i] = Pow[i - <span class="number">1</span>] / <span class="number">2.0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%s"</span>,str+<span class="number">1</span>) , u = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= m ; ++j ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( !trs[u][str[j] == <span class="string">'T'</span>] )</span><br><span class="line">        trs[u][str[j] == <span class="string">'T'</span>] = ++nidx;</span><br><span class="line">      dep[trs[u][str[j] == <span class="string">'T'</span>]] = dep[u] + <span class="number">1</span>;</span><br><span class="line">      u = trs[u][str[j] == <span class="string">'T'</span>];</span><br><span class="line">      addedge( u , i );</span><br><span class="line">    &#125;</span><br><span class="line">    id[i] = u;</span><br><span class="line">  &#125;</span><br><span class="line">  he = <span class="number">1</span> , ta = <span class="number">0</span>; <span class="keyword">if</span>( trs[<span class="number">0</span>][<span class="number">0</span>] ) que[++ta] = trs[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span>( trs[<span class="number">0</span>][<span class="number">1</span>] ) que[++ta] = trs[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">while</span>( he &lt;= ta ) &#123;</span><br><span class="line">    u = que[he++];</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">2</span> ; ++i )</span><br><span class="line">      <span class="keyword">if</span>( trs[u][i] ) lnk[que[++ta] = trs[u][i]] = trs[lnk[u]][i];</span><br><span class="line">      <span class="keyword">else</span> trs[u][i] = trs[lnk[u]][i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> x = id[i] ; x ; x = lnk[x] ) </span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> e = head[x] ; e ; e = edge[e].nxt )</span><br><span class="line">        mat[edge[e].to][i] += Pow[m - dep[x]];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) mat[<span class="number">0</span>][i] = <span class="number">1</span> , mat[i][<span class="number">0</span>] = -Pow[m];</span><br><span class="line">  mat[<span class="number">0</span>][n + <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  guass( n );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) <span class="built_in">printf</span>(<span class="string">"%.10f\n"</span>,mat[i][n + <span class="number">1</span>] );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-相关分析"><a href="https://loj.ac/problem/2005" target="_blank" rel="noopener">[SDOI2017] 相关分析</a></h5>
<p>只要保存 <span class="math inline">\(\sum_i x_i\)</span> , <span class="math inline">\(\sum_i y_i\)</span> , <span class="math inline">\(\sum_i x_i y_i\)</span> 即可 , 对于第一种操作 , <span class="math inline">\(\sum_i x&#39;_i y&#39;_i = \sum_i(x_i+S)(y_i+T) = \sum_ix_iy_i+Sx_i+Ty_i\)</span> , 对于第二种操作 <span class="math inline">\(x_iy_i = ( S + i )( T + i ) = ST + iS + iT + i^2\)</span> , 直接线段树维护即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>( <span class="title">T</span> &amp; <span class="title">x</span> ) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> lol;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e5</span> + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> tag1 , tag2;</span><br><span class="line">  <span class="keyword">int</span> a , b;</span><br><span class="line">  lol x2 , x , y , xy;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">int</span> _x , <span class="keyword">int</span> _y )</span> </span>&#123;</span><br><span class="line">    x = _x , y = _y;</span><br><span class="line">    xy = <span class="number">1L</span>L * _x * _y;</span><br><span class="line">    x2 = <span class="number">1L</span>L * x * x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">up</span><span class="params">( node &amp; ls , node &amp; rs )</span> </span>&#123;</span><br><span class="line">    x2 = ls.x2 + rs.x2;</span><br><span class="line">    x = ls.x + rs.x;</span><br><span class="line">    y = ls.y + rs.y;</span><br><span class="line">    xy = ls.xy + rs.xy;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; val[N &lt;&lt; <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> dat[N][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( l == r ) &#123; val[u].init( dat[l][<span class="number">0</span>] , dat[l][<span class="number">1</span>] ); <span class="keyword">return</span>; &#125;</span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  build( l , mid , u &lt;&lt; <span class="number">1</span> );</span><br><span class="line">  build( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> );</span><br><span class="line">  val[u].up( val[u &lt;&lt; <span class="number">1</span>] , val[u &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lol _S2( lol n ) &#123; <span class="keyword">return</span> n &lt;= <span class="number">0</span> ? <span class="number">0</span> : n * ( n + <span class="number">1</span> ) * ( <span class="number">2</span> * n + <span class="number">1</span> ) / <span class="number">6</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">lol <span class="title">S2</span><span class="params">( lol l , lol r )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( ( l &lt; <span class="number">0</span> ) ^ ( r &lt; <span class="number">0</span> ) ) &#123;</span><br><span class="line">    l = <span class="built_in">abs</span>( l ) , r = <span class="built_in">abs</span>( r );</span><br><span class="line">    <span class="keyword">return</span> _S2( l ) + _S2( r );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    l = <span class="built_in">abs</span>( l ) , r = <span class="built_in">abs</span>( r );</span><br><span class="line">    <span class="keyword">if</span>( l &gt; r ) swap( l , r );</span><br><span class="line">    <span class="keyword">return</span> _S2( r ) - _S2( l - <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">lol <span class="title">S</span><span class="params">( lol l , lol r )</span> </span>&#123; <span class="keyword">return</span> ( r - l + <span class="number">1</span> ) * ( r + l ) / <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">lol <span class="title">SS</span><span class="params">( lol s , lol t , lol n )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> lol tmp , res;</span><br><span class="line">  tmp = n * ( n + <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line">  res = tmp * ( s + t ) + s * t * n + _S2( n );</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addtag</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> s , <span class="keyword">int</span> t )</span> </span>&#123;</span><br><span class="line">  val[u].x2 += <span class="number">2.0</span> * s * val[u].x + <span class="number">1.0</span> * s * s * ( r - l + <span class="number">1</span> );</span><br><span class="line">  val[u].xy += <span class="number">1.0</span> * s * t * ( r - l + <span class="number">1</span> ) + <span class="number">1.0</span> * t * val[u].x + s * val[u].y;</span><br><span class="line">  val[u].x += <span class="number">1.0</span> * s * ( r - l + <span class="number">1</span> );</span><br><span class="line">  val[u].y += <span class="number">1.0</span> * t * ( r - l + <span class="number">1</span> );</span><br><span class="line">  val[u].a += s , val[u].b += t;</span><br><span class="line">  <span class="keyword">if</span>( !val[u].tag2 ) val[u].tag1 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mdftag</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> s , <span class="keyword">int</span> t )</span> </span>&#123;</span><br><span class="line">  val[u].tag1 = <span class="number">0</span> , val[u].a = s , val[u].b = t , val[u].tag2 = <span class="number">1</span>;</span><br><span class="line">  val[u].x2 = S2( s + l , s + r ) , val[u].x = S( s + l , s + r );</span><br><span class="line">  val[u].y = S( t + l , t + r ) , val[u].xy = SS( s + l - <span class="number">1</span> , t + l - <span class="number">1</span> , r - l + <span class="number">1</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dn</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> l , <span class="keyword">int</span> r )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>( val[u].tag1 ) &#123;</span><br><span class="line">    val[u].tag1 = <span class="number">0</span>;</span><br><span class="line">    addtag( u &lt;&lt; <span class="number">1</span> , l , mid , val[u].a , val[u].b );</span><br><span class="line">    addtag( u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , mid + <span class="number">1</span> , r , val[u].a , val[u].b );</span><br><span class="line">    val[u].a = val[u].b = <span class="number">0</span>;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">if</span>( val[u].tag2 ) &#123;</span><br><span class="line">    val[u].tag2 = <span class="number">0</span>;</span><br><span class="line">    mdftag( u &lt;&lt; <span class="number">1</span> , l , mid , val[u].a , val[u].b );</span><br><span class="line">    mdftag( u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , mid + <span class="number">1</span> , r , val[u].a , val[u].b );</span><br><span class="line">    val[u].a = val[u].b = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> L , <span class="keyword">int</span> R , <span class="keyword">int</span> s , <span class="keyword">int</span> t )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( l &gt;= L &amp;&amp; r &lt;= R ) &#123; addtag( u , l , r , s , t ); <span class="keyword">return</span>; &#125; </span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>; dn( u , l , r );</span><br><span class="line">  <span class="keyword">if</span>( mid &gt;= L ) add( l , mid , u &lt;&lt; <span class="number">1</span> , L , R , s , t );</span><br><span class="line">  <span class="keyword">if</span>( mid &lt; R ) add( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , L , R , s , t );</span><br><span class="line">  val[u].up( val[u &lt;&lt; <span class="number">1</span>] , val[u &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mdf</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> L , <span class="keyword">int</span> R , <span class="keyword">int</span> s , <span class="keyword">int</span> t )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( l &gt;= L &amp;&amp; r &lt;= R ) &#123; mdftag( u , l , r , s , t ); <span class="keyword">return</span>; &#125; </span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>; dn( u , l , r );</span><br><span class="line">  <span class="keyword">if</span>( mid &gt;= L ) mdf( l , mid , u &lt;&lt; <span class="number">1</span> , L , R , s , t );</span><br><span class="line">  <span class="keyword">if</span>( mid &lt; R ) mdf( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , L , R , s , t );</span><br><span class="line">  val[u].up( val[u &lt;&lt; <span class="number">1</span>] , val[u &lt;&lt; <span class="number">1</span> | <span class="number">1</span>] );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Ans</span> &#123;</span></span><br><span class="line">  lol x , y , x2 , xy;</span><br><span class="line">  Ans() &#123;&#125;</span><br><span class="line">  Ans( lol _a , lol _b , lol _c , lol _d ):x( _a ) , y( _b ) , x2( _c ) , xy( _d ) &#123;&#125;</span><br><span class="line">  Ans <span class="keyword">operator</span> + ( <span class="keyword">const</span> Ans &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> (Ans) &#123; x + rhs.x , y + rhs.y , x2 + rhs.x2 , xy + rhs.xy &#125;; &#125;</span><br><span class="line">&#125; res;</span><br><span class="line"></span><br><span class="line"><span class="function">Ans <span class="title">qry</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r , <span class="keyword">int</span> u , <span class="keyword">int</span> L , <span class="keyword">int</span> R )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( l &gt;= L &amp;&amp; r &lt;= R ) <span class="keyword">return</span> Ans( val[u].x , val[u].y , val[u].x2 , val[u].xy );</span><br><span class="line">  <span class="keyword">int</span> mid = ( l + r ) &gt;&gt; <span class="number">1</span>; dn( u , l , r );</span><br><span class="line">  <span class="keyword">if</span>( mid &gt;= R ) <span class="keyword">return</span> qry( l , mid , u &lt;&lt; <span class="number">1</span> , L , R );</span><br><span class="line">  <span class="keyword">if</span>( mid &lt; L ) <span class="keyword">return</span> qry( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , L , R );</span><br><span class="line">  <span class="keyword">return</span> qry( l , mid , u &lt;&lt; <span class="number">1</span> , L , R ) + qry( mid + <span class="number">1</span> , r , u &lt;&lt; <span class="number">1</span> | <span class="number">1</span> , L , R );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , m;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  read( n ) , read( m );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) read( dat[i][<span class="number">0</span>] );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) read( dat[i][<span class="number">1</span>] );</span><br><span class="line">  build( <span class="number">1</span> , n , <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">int</span> opt , l , r , s , t;</span><br><span class="line">  <span class="keyword">double</span> xb , yb;</span><br><span class="line">  <span class="keyword">while</span>( m-- ) &#123;</span><br><span class="line">    read( opt ) , read( l ) , read( r );</span><br><span class="line">    <span class="keyword">if</span>( opt == <span class="number">1</span> ) &#123;</span><br><span class="line">      res = qry( <span class="number">1</span> , n , <span class="number">1</span> , l , r );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">      <span class="built_in">cout</span> &lt;&lt; <span class="string">'#'</span> &lt;&lt; res.x2 &lt;&lt; <span class="string">' '</span> &lt;&lt; res.x &lt;&lt; <span class="string">' '</span> &lt;&lt; res.y &lt;&lt; <span class="string">' '</span> &lt;&lt; res.xy &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      xb = <span class="number">1.0</span> * res.x / ( r - l + <span class="number">1</span> );</span><br><span class="line">      yb = <span class="number">1.0</span> * res.y / ( r - l + <span class="number">1</span> );</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%.10f\n"</span>,( <span class="number">1.0</span> * res.xy - yb * res.x - xb * res.y + yb * xb * ( r - l + <span class="number">1</span> ) ) /</span><br><span class="line">                       ( <span class="number">1.0</span> * res.x2 - <span class="number">2.0</span> * res.x * xb + xb * xb * ( r - l + <span class="number">1</span> ) ) );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      read( s ) , read( t );</span><br><span class="line">      <span class="keyword">if</span>( opt == <span class="number">2</span> ) add( <span class="number">1</span> , n , <span class="number">1</span> , l , r , s , t );</span><br><span class="line">      <span class="keyword">else</span> mdf( <span class="number">1</span> , n , <span class="number">1</span> , l , r , s , t );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-龙与地下城"><a href="https://loj.ac/problem/2267" target="_blank" rel="noopener">[SDOI2017] 龙与地下城</a></h5>
<p>直接多项式快速幂 , 每次将很小的值丢掉不用即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">8e6</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">2e6</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> PI = <span class="built_in">acos</span>( <span class="number">-1.0</span> );</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> eps = <span class="number">1e-12</span>;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Complex</span> &#123;</span></span><br><span class="line">  <span class="keyword">double</span> x , y;</span><br><span class="line">  Complex() &#123;&#125;</span><br><span class="line">  Complex( <span class="keyword">double</span> _x , <span class="keyword">double</span> _y ):x( _x ) , y( _y ) &#123;&#125;</span><br><span class="line">  Complex <span class="keyword">operator</span> + ( <span class="keyword">const</span> Complex &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Complex( x + rhs.x , y + rhs.y ); &#125;</span><br><span class="line">  Complex <span class="keyword">operator</span> - ( <span class="keyword">const</span> Complex &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Complex( x - rhs.x , y - rhs.y ); &#125;</span><br><span class="line">  Complex <span class="keyword">operator</span> * ( <span class="keyword">const</span> Complex &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Complex( x * rhs.x - y * rhs.y , x * rhs.y + y * rhs.x ); &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> = ( <span class="keyword">const</span> <span class="keyword">double</span> &amp; rhs ) &#123; x = rhs , y = <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> *= ( <span class="keyword">const</span> <span class="keyword">double</span> &amp; rhs ) &#123; x *= rhs , y *= rhs; &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> /= ( <span class="keyword">const</span> <span class="keyword">double</span> &amp; rhs ) &#123; x /= rhs , y /= rhs; &#125;</span><br><span class="line">  <span class="function">Complex <span class="title">conj</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> Complex( x , -y ); &#125;</span><br><span class="line">&#125; WN[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> r[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">int</span> n )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> _n = <span class="number">0</span> , l;</span><br><span class="line">  <span class="keyword">if</span>( _n == n ) <span class="keyword">return</span>;</span><br><span class="line">  _n = n; l = <span class="number">0</span>; <span class="keyword">while</span>( ( <span class="number">1</span> &lt;&lt; l ) &lt; n ) ++l;</span><br><span class="line">  --l; <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; n ; ++i ) r[i] = ( r[i &gt;&gt; <span class="number">1</span>] &gt;&gt; <span class="number">1</span> ) | ( (i&amp;<span class="number">1</span>) &lt;&lt; l );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; ++i ) WN[i] = Complex( <span class="built_in">cos</span>( PI * i / n ) , <span class="built_in">sin</span>( PI * i / n ) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FFT</span><span class="params">( Complex * f , <span class="keyword">int</span> n , <span class="keyword">int</span> flag )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Complex x , y;</span><br><span class="line">  init( n );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; n ; ++i ) <span class="keyword">if</span>( i &lt; r[i] ) swap( f[i] , f[r[i]] );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> mid = <span class="number">1</span> , lg = <span class="number">0</span> ; mid &lt; n ; mid &lt;&lt;= <span class="number">1</span> , ++lg ) </span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; i += ( mid &lt;&lt; <span class="number">1</span> ) )</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; mid ; ++j ) &#123;</span><br><span class="line">        x = f[i + j] , y = f[i + j + mid] * ( flag ? WN[( n &gt;&gt; lg ) * j].conj() : WN[( n &gt;&gt; lg ) * j] );</span><br><span class="line">        f[i + j] = x + y;</span><br><span class="line">        f[i + j + mid] = x - y;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="keyword">if</span>( flag ) </span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; ++i ) f[i] /= n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Poly</span> &#123;</span></span><br><span class="line">  <span class="keyword">double</span> f[N];</span><br><span class="line">  <span class="keyword">int</span> base , deg;</span><br><span class="line">  <span class="keyword">double</span> &amp; <span class="keyword">operator</span> [] ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; k ) &#123; <span class="keyword">return</span> f[k]; &#125;</span><br><span class="line">&#125; A , B , F;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> X , Y;</span><br><span class="line"></span><br><span class="line">Complex _A[M] , _B[M];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mul</span><span class="params">( Poly &amp; a , Poly &amp; b )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> lim = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( lim &lt;= a.deg + b.deg ) lim &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; lim ; ++i ) _A[i] = <span class="number">0</span> , _B[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= a.deg ; ++i ) _A[i] = a[i];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= b.deg ; ++i ) _B[i] = b[i];</span><br><span class="line">  FFT( _A , lim , <span class="number">0</span> ) , FFT( _B , lim , <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; lim ; ++i ) _A[i] = _A[i] * _B[i];</span><br><span class="line">  FFT( _A , lim , <span class="number">1</span> );</span><br><span class="line">  a.deg += b.deg;</span><br><span class="line">  a.base += b.base;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= a.deg ; ++i ) a[i] = _A[i].x;</span><br><span class="line">  <span class="keyword">if</span>( ( X - <span class="number">1</span> ) * Y &lt;= <span class="number">5e5</span> ) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">while</span>( a[a.deg] &lt; eps ) --a.deg;</span><br><span class="line">  lim = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>( a[lim] &lt; eps ) ++lim;</span><br><span class="line">  a.deg -= lim;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= a.deg ; ++i ) a[i] = a[i + lim];</span><br><span class="line">  a.base += lim;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> ans[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;X,&amp;Y);</span><br><span class="line">  A.base = B.base = F.base = <span class="number">0</span>;</span><br><span class="line">  A.deg = B.deg = F.deg = <span class="number">0</span>;</span><br><span class="line">  F.deg = X - <span class="number">1</span> , A[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; X ; ++i ) F[i] = <span class="number">1.0</span> / X;</span><br><span class="line">  B = F;</span><br><span class="line">  <span class="keyword">int</span> _Y = Y;</span><br><span class="line">  <span class="keyword">while</span>( _Y ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( _Y &amp; <span class="number">1</span> ) mul( A , B );</span><br><span class="line">    mul( B , B ); _Y &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> , t = ( X - <span class="number">1</span> ) * Y - A.base ; i &lt;= t ; ++i )</span><br><span class="line">    ans[A.base + i] = A[i];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; A.base ; ++i ) ans[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , t = ( X - <span class="number">1</span> ) * Y ; i &lt;= t ; ++i )</span><br><span class="line">    ans[i] += ans[i - <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">int</span> _T = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">while</span>( _T-- ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;X,&amp;Y);</span><br><span class="line">    <span class="keyword">if</span>( !X ) <span class="built_in">printf</span>(<span class="string">"%.12f\n"</span>,ans[Y]);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"%.12f\n"</span>,ans[Y]-ans[X - <span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> T; </span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T);</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-苹果树"><a href="https://loj.ac/problem/2268" target="_blank" rel="noopener">[SDOI2017] 苹果树</a></h5>
<p>先做一个转化 , 将树上一个点 <span class="math inline">\(i(a_i &gt; 1)\)</span> , 拆为两个点 , 一个点 <span class="math inline">\(j\)</span> 在原来的位置 , <span class="math inline">\(a_j = 1\)</span>, 另一个点 <span class="math inline">\(k\)</span> 挂在 <span class="math inline">\(i\)</span> 上 <span class="math inline">\(a_k = a_i - 1\)</span> , 此时发现 , 取原来位置的点 , 也就是上面的 <span class="math inline">\(a_j\)</span> , 当是最深的点时 , 不会对还能取的点造成任何限制 , 于是直接贪心取到叶子节点 , 接着考虑剩下这些点怎么取. 这里要用到后序遍历的性质 , 也就是只有全部遍历完在离开, 就是说对于一个点 <span class="math inline">\(i\)</span> , 其子树内的点在后序遍历上在 <span class="math inline">\(i\)</span> 的前面. 此时正反做一遍后序遍历 , 对于选定的必须选的到叶子的路径 , 找出叶子节点在两个遍历序中的位置. 只取两个遍历序中在叶子节点前面的点 , 发现刚好绕过的选定的这条到叶子的路径 , 于是对两边的点做背包就行了 , 可以预处理背包 , 复杂度就是 <span class="math inline">\(O(nk)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> id( x , y ) ( (x) * (k+1) + y )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">4e4</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">6e7</span> + <span class="number">5</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">chkmx</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">if</span>( a &lt; b ) a = b; &#125;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , k , mark[N] , f[M] , g[M] , dfn1[N] , dfn2[N] , siz[N] , rmp1[N] , rmp2[N] , dfc1 , dfc2 , a[N] , v[N] , val[N] , ans;</span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; G[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clr</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  dfc1 = dfc2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">    swap( vec , G[i] );</span><br><span class="line">    mark[i] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> que[M] , he , ta;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs1</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  siz[u] = <span class="number">1</span> , val[u] += v[u];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">int</span> &amp; v : G[u] )</span><br><span class="line">    val[v] = val[u] , dfs1( v ) , siz[u] += siz[v];</span><br><span class="line">  rmp1[dfn1[u] = ++dfc1] = u;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs2</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  reverse( G[u].begin() , G[u].end() );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">int</span> &amp; v : G[u] )</span><br><span class="line">    dfs2( v );</span><br><span class="line">  rmp2[dfn2[u] = ++dfc2] = u;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dp</span><span class="params">( <span class="keyword">int</span> * f , <span class="keyword">int</span> * rmp )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= k ; ++i ) f[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , c , v , sz ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    c = a[rmp[i]] , sz = siz[rmp[i]] , v = ::v[rmp[i]];</span><br><span class="line">    que[he = ta = <span class="number">1</span>] = <span class="number">0</span> , f[id( i , <span class="number">0</span> )] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= k ; ++j ) &#123;</span><br><span class="line">      f[id( i , j )] = f[id( i - sz , j )];</span><br><span class="line">      <span class="keyword">while</span>( he &lt;= ta &amp;&amp; j - que[he] &gt; c ) ++he;</span><br><span class="line">      chkmx( f[id( i , j )] , f[id( i - <span class="number">1</span> , que[he] )] + ( j - que[he] ) * v );</span><br><span class="line">      <span class="keyword">while</span>( he &lt;= ta &amp;&amp; f[id( i - <span class="number">1</span> , j )] - j * v &gt; f[id( i - <span class="number">1</span> , que[ta] )] - que[ta] * v ) --ta;</span><br><span class="line">      que[++ta] = j;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;n,&amp;k);</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , x ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>,&amp;x,a+i,v+i);</span><br><span class="line">    <span class="keyword">if</span>( x ) mark[x] = <span class="number">1</span> , G[x].push_back( i );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = n ; i ; --i ) </span><br><span class="line">    <span class="keyword">if</span>( a[i] &gt; <span class="number">1</span> ) &#123;</span><br><span class="line">      a[++n] = a[i] - <span class="number">1</span>;</span><br><span class="line">      a[i] = <span class="number">1</span>; v[n] = v[i];</span><br><span class="line">      G[i].push_back( n );</span><br><span class="line">      mark[n] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  ans = <span class="number">0</span>; val[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  dfs1( <span class="number">1</span> ) , dfs2( <span class="number">1</span> );</span><br><span class="line">  dp( f , rmp1 ); dp( g , rmp2 );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) <span class="keyword">if</span>( !mark[i] )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt;= k ; ++j )</span><br><span class="line">      chkmx( ans , val[i] + f[id( dfn1[i] - <span class="number">1</span> , j )] + g[id( dfn2[i] - siz[i] , k - j )] );</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,ans);</span><br><span class="line">  clr();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> T;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T);</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-切树游戏"><a href="https://loj.ac/problem/2269" target="_blank" rel="noopener">[SDOI2017] 切树游戏</a></h5>
<p>首先有一个 <span class="math inline">\(\rm DP\)</span> , 设 <span class="math inline">\(f_{i,j}\)</span> 表示以 <span class="math inline">\(i\)</span> 为根且权值为 <span class="math inline">\(j\)</span> 的联通块数量 , 转移有 <span class="math inline">\(f&#39;_{i,j} = f_{i,j}+\sum_k f_{i,k}f_{\text{son}_i.j \oplus k}\)</span> , 这就是异或卷积 , 考虑用 <span class="math inline">\(\rm FWT\)</span> 优化 , 由于 <span class="math inline">\(\rm FWT\)</span> 是线性变换 , 可以先对所有数组进行 <span class="math inline">\(\rm FWT\)</span> , 最后运算完再 <span class="math inline">\(\rm IFWT\)</span> 回去. 由于有修需要用到动态 <span class="math inline">\(\rm DP\)</span> , 有 <span class="math inline">\(\begin{bmatrix} f_i \\g_i \\ 1\end{bmatrix}\)</span>三个状态 , 其中 <span class="math inline">\(g_{i}\)</span> 代表 <span class="math inline">\(i\)</span> 子树中 <span class="math inline">\(f\)</span> 之和. 然后就可以设计矩阵了. 注意到维护虚儿子的信息时 , 有乘 <span class="math inline">\(0\)</span> 操作 , 这没有逆操作 , 所以需要将一个数表示为 <span class="math inline">\(c \cdot 0^k\)</span> , 每次乘 <span class="math inline">\(0\)</span> , 除 <span class="math inline">\(0\)</span> 就直接对 <span class="math inline">\(k\)</span> 进行操作即可. 由于这些矩阵的元素都是一个数组 , 考虑优化一下常数. 对于转移矩阵 <span class="math display">\[
\begin{aligned}
\begin{bmatrix}f_u\prod (f_s+1) &amp;0&amp;f_u\prod (f_s+1)\\f_u\prod (f_s+1) &amp;1&amp;f_u\prod (f_s+1)+\sum g_s\\ 0 &amp; 0 &amp; 1\end{bmatrix} \begin{bmatrix}f_i\\g_i\\1\end{bmatrix} =\begin{bmatrix}f_{i+1}\\g_{i+1}\\1\end{bmatrix}
\end{aligned}
\]</span> 手玩一下有 <span class="math display">\[
\begin{aligned}
\begin{bmatrix} a &amp;0 &amp;b\\c&amp;1&amp;d\\0&amp;0&amp;1\end{bmatrix}\begin{bmatrix}e&amp;0&amp;f\\g&amp;1&amp;h\\0&amp;0&amp;1\end{bmatrix} =\begin{bmatrix}ae &amp;0&amp;af+b\\ ce+g&amp;1&amp;cf+h+d \\0&amp;0&amp;1\end{bmatrix}
\end{aligned}
\]</span> 于是只用保存四个位置的数组 , 就能过了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">( <span class="keyword">int</span> &amp; x )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">( <span class="keyword">char</span> * str )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , tp; c = Getchar() , tp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'A'</span> || c &gt; <span class="string">'z'</span> ) c = Getchar();</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'z'</span> &amp;&amp; c &gt;= <span class="string">'A'</span> ) str[tp++] = c , c = Getchar();</span><br><span class="line">    str[tp] = <span class="string">'\0'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">3e4</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">128</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">1e4</span> + <span class="number">7</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> inv2 = ( mod + <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = res * b % mod;</span><br><span class="line">    b = b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , m;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FWT</span><span class="params">( <span class="keyword">int</span> * f )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> x , y;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; ( <span class="number">1</span> &lt;&lt; i ) &lt; m ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; m ; ++j )</span><br><span class="line">      <span class="keyword">if</span>( ( j &gt;&gt; i ) &amp; <span class="number">1</span> ) &#123;</span><br><span class="line">        x = f[j ^ ( <span class="number">1</span> &lt;&lt; i )] , y = f[j];</span><br><span class="line">        f[j ^ ( <span class="number">1</span> &lt;&lt; i )] = pls( x , y );</span><br><span class="line">        f[j] = mns( x , y );</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">IFWT</span><span class="params">( <span class="keyword">int</span> * f )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> x , y;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; ( <span class="number">1</span> &lt;&lt; i ) &lt; m ; ++i )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; m ; ++j )</span><br><span class="line">      <span class="keyword">if</span>( ( j &gt;&gt; i ) &amp; <span class="number">1</span> ) &#123;</span><br><span class="line">        x = f[j ^ ( <span class="number">1</span> &lt;&lt; i )] , y = f[j];</span><br><span class="line">        f[j ^ ( <span class="number">1</span> &lt;&lt; i )] = inv2 * pls( x , y ) % mod;</span><br><span class="line">        f[j] = inv2 * mns( x , y ) % mod;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Int</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> x , y;</span><br><span class="line">  Int() &#123; x = <span class="number">1</span> , y = <span class="number">1</span>; &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> *= ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) &#123; <span class="keyword">if</span>( !rhs ) ++y; <span class="keyword">else</span> x = x * rhs % mod; &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> /= ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) &#123; <span class="keyword">if</span>( !rhs ) --y; <span class="keyword">else</span> x = x * fpow( rhs , mod - <span class="number">2</span> ) % mod; &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> = ( <span class="keyword">const</span> <span class="keyword">int</span> &amp; rhs ) &#123; <span class="keyword">if</span>( !rhs ) x = <span class="number">1</span> , y = <span class="number">1</span>; <span class="keyword">else</span> x = rhs , y = <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> y ? <span class="number">0</span> : x; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Int fs[N][M];</span><br><span class="line"><span class="keyword">int</span> gs[N][M] , org[M][M];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> A[M] , B[M] , C[M] , D[M];</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( Int * fs , <span class="keyword">int</span> * gs )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) &#123;</span><br><span class="line">      A[i] = B[i] = C[i] = fs[i];</span><br><span class="line">      D[i] = pls( gs[i] , fs[i] );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Data <span class="keyword">operator</span> * ( <span class="keyword">const</span> Data &amp; rhs ) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Data res;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) &#123;</span><br><span class="line">      res.A[i] = A[i] * rhs.A[i] % mod;</span><br><span class="line">      res.B[i] = pls( A[i] * rhs.B[i] % mod , B[i] );</span><br><span class="line">      res.C[i] = pls( C[i] * rhs.A[i] % mod , rhs.C[i] );</span><br><span class="line">      res.D[i] = pls( C[i] * rhs.B[i] % mod , pls( D[i] , rhs.D[i] ) );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; val[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> son[N][<span class="number">2</span>] , p[N];</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">which</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123; <span class="keyword">return</span> p[x] ? x == son[p[x]][<span class="number">1</span>] : <span class="number">0</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">noroot</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123; <span class="keyword">return</span> p[x] ? x == son[p[x]][<span class="number">0</span>] || x == son[p[x]][<span class="number">1</span>] : <span class="number">0</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">up</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  val[u].init( fs[u] , gs[u] );</span><br><span class="line">  <span class="keyword">if</span>( son[u][<span class="number">0</span>] ) val[u] = val[son[u][<span class="number">0</span>]] * val[u];</span><br><span class="line">  <span class="keyword">if</span>( son[u][<span class="number">1</span>] ) val[u] = val[u] * val[son[u][<span class="number">1</span>]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> w , f; w = which( u ) , f = p[u];</span><br><span class="line">  p[u] = p[f]; <span class="keyword">if</span>( noroot( f ) ) son[p[f]][which( f )] = u;</span><br><span class="line">  <span class="keyword">if</span>( ( son[f][w] = son[u][w ^ <span class="number">1</span>] ) ) p[son[u][w ^ <span class="number">1</span>]] = f;</span><br><span class="line">  son[p[f] = u][w ^ <span class="number">1</span>] = f; up( f );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">splay</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> f; </span><br><span class="line">  <span class="keyword">while</span>( noroot( u ) ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( noroot( f = p[u] ) ) rotate( which( u ) ^ which( f ) ? u : f );</span><br><span class="line">    rotate( u );</span><br><span class="line">  &#125; up( u );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) &#123;</span><br><span class="line">    fs[u][i] *= pls( val[v].B[i] , <span class="number">1</span> );</span><br><span class="line">    inc( gs[u][i] , val[v].D[i] );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) &#123;</span><br><span class="line">    fs[u][i] /= pls( val[v].B[i] , <span class="number">1</span> );</span><br><span class="line">    dec( gs[u][i] , val[v].D[i] );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">access</span><span class="params">( <span class="keyword">int</span> x )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> t = <span class="number">0</span> ; x ; t = x , x = p[x] ) &#123;</span><br><span class="line">    splay( x );</span><br><span class="line">    <span class="keyword">if</span>( son[x][<span class="number">1</span>] ) add( x , son[x][<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">if</span>( t ) del( x , t );</span><br><span class="line">    son[x][<span class="number">1</span>] = t;</span><br><span class="line">    up( x );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> head[N] , eidx , dat[N];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[N &lt;&lt; <span class="number">1</span>];</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx;</span><br><span class="line">  edge[++eidx] = (Edge) &#123; head[v] , u &#125;; head[v] = eidx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> fa )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) fs[u][i] = org[dat[u]][i];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">    <span class="keyword">if</span>( ( v = edge[i].to ) != fa ) &#123;</span><br><span class="line">      p[v] = u;</span><br><span class="line">      dfs( v , u ); </span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) &#123;</span><br><span class="line">        fs[u][i] *= pls( fs[v][i] , <span class="number">1</span> );</span><br><span class="line">        inc( gs[u][i] , gs[v][i] );</span><br><span class="line">        inc( gs[u][i] , fs[v][i] );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  val[u].init( fs[u] , gs[u] );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  read( n ) , read( m );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) &#123; org[i][i] = <span class="number">1</span>; FWT( org[i] ); &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) read( dat[i] );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u , v ; i &lt; n ; ++i ) &#123;</span><br><span class="line">    read( u ) , read( v );</span><br><span class="line">    addedge( u , v );</span><br><span class="line">  &#125; dfs( <span class="number">1</span> , <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> q , x , tmp[M];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> str[<span class="number">15</span>];</span><br><span class="line">  read( q );</span><br><span class="line">  <span class="keyword">while</span>( q-- ) &#123;</span><br><span class="line">    read( str );</span><br><span class="line">    <span class="keyword">if</span>( str[<span class="number">0</span>] == <span class="string">'Q'</span> ) &#123;</span><br><span class="line">      splay( <span class="number">1</span> ); read( x );</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) tmp[i] = val[<span class="number">1</span>].D[i];</span><br><span class="line">      IFWT( tmp );</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,tmp[x]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      read( x ); access( x ); splay( x );</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) fs[x][i] /= org[dat[x]][i];</span><br><span class="line">      read( dat[x] );</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m ; ++i ) fs[x][i] *= org[dat[x]][i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-天才黑客"><a href="https://loj.ac/problem/2270" target="_blank" rel="noopener">[SDOI2017] 天才黑客</a></h5>
<p>暴力就是将边看作两个点 , 一个出点一个入点 , 入点向出点连权值为原边长度的边 , 对于原图中一个点所有的入边 , 向其出边连边 , 权值为在字典树上 <span class="math inline">\(\text{lca}\)</span> 的深度 , 这样边的个数是 <span class="math inline">\(O(m^2)\)</span> 需要优化. 将所有边按照在字典序中的 <span class="math inline">\(\rm dfs\)</span> 序排序 , 由于一条边到另一条边的花费是 <span class="math inline">\(\text{lca}\)</span> 的深度 , 注意到由于按照 <span class="math inline">\(\rm dfs\)</span> 排序过了 , 对于边 <span class="math inline">\(u\)</span> , <span class="math inline">\(\text{dep}_{\text{lca}(u,v)}(v&lt;u)\)</span> , 在 <span class="math inline">\(v\)</span> 递减时逐渐减小. 同理对于 <span class="math inline">\(\text{dep}_{\text{lca}(u,v)}(v&gt;u)\)</span> 在 <span class="math inline">\(v\)</span> 递增时逐渐减小. 并且 <span class="math inline">\(\text{lca}(u,v)\)</span> 一定在 <span class="math inline">\(\text{lca}(v,v+1)\)</span> 中出现过 , 由于最短路找最小边走的性质 , 可以利用这个优化建图 , 具体来说就是建立两排虚点 , 上层虚点向下层虚点连权值为 <span class="math inline">\(\text{dep}_{\text{lca}(u,u+1)}\)</span> 的边 , 下层虚点直接连向出边节点 , 入边节点连向上层虚点 , 每排虚点两点间连边 <span class="math inline">\((u,u+1)\)</span> , 权值为 <span class="math inline">\(0\)</span> , 发现这只处理了后缀连边 , 前缀也做一遍 , 最后直接最短路即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> id( x , type ) ( (type) * (::m) + x )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; pii;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">7e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">4e6</span> + <span class="number">5</span>; </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"><span class="keyword">int</span> _w;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , m , k , nidx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Trie &#123;</span><br><span class="line">  <span class="keyword">int</span> head[N] , eidx , dfn[N] , top[N] , fa[N] , dep[N] , dfc , siz[N] , son[N];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to; &#125; edge[N &lt;&lt; <span class="number">1</span>];</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">    edge[++eidx] = (Edge) &#123; head[u] , v &#125;; head[u] = eidx;</span><br><span class="line">    edge[++eidx] = (Edge) &#123; head[v] , u &#125;; head[v] = eidx;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">    siz[u] = <span class="number">1</span> , son[u] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">      <span class="keyword">if</span>( ( v = edge[i].to ) != fa[u] ) &#123;</span><br><span class="line">        fa[v] = u , dep[v] = dep[u] + <span class="number">1</span>; </span><br><span class="line">        dfs( v ); siz[u] += siz[v];</span><br><span class="line">        <span class="keyword">if</span>( siz[v] &gt; siz[son[u]] ) son[u] = v;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> ftop )</span> </span>&#123;</span><br><span class="line">    top[u] = ftop , dfn[u] = ++dfc;</span><br><span class="line">    <span class="keyword">if</span>( son[u] ) dfs( son[u] , ftop );</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">      <span class="keyword">if</span>( ( v = edge[i].to ) != fa[u] &amp;&amp; v != son[u] )</span><br><span class="line">        dfs( v , v );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>( head , <span class="number">0</span> , <span class="keyword">sizeof</span>( <span class="keyword">int</span> ) * ( k + <span class="number">1</span> ) ) , eidx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , u , v , w ; i &lt; k ; ++i ) &#123;</span><br><span class="line">      _w = <span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>,&amp;u,&amp;v,&amp;w);</span><br><span class="line">      addedge( u , v );</span><br><span class="line">    &#125;</span><br><span class="line">    dfs( <span class="number">1</span> );</span><br><span class="line">    dfs( <span class="number">1</span> , <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>( top[u] != top[v] ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( dep[top[u]] &lt; dep[top[v]] ) swap( u , v );</span><br><span class="line">      u = fa[top[u]];</span><br><span class="line">    &#125; <span class="keyword">return</span> dep[u] &lt; dep[v] ? u : v;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">cost</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v )</span> </span>&#123; <span class="keyword">return</span> dep[LCA( u , v )]; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; in[N] , ou[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Dijkstra &#123;</span><br><span class="line">  <span class="keyword">int</span> head[N] , eidx , dis[N];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span> <span class="keyword">int</span> nxt , to , val; &#125; edge[M];</span><br><span class="line">  priority_queue&lt;pii,<span class="built_in">vector</span>&lt;pii&gt; , greater&lt;pii&gt; &gt; Q;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="built_in">memset</span>( head , <span class="number">0</span> , <span class="keyword">sizeof</span> head ) , eidx = <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">( <span class="keyword">int</span> u , <span class="keyword">int</span> v , <span class="keyword">int</span> w )</span> </span>&#123; edge[++eidx] = (Edge) &#123; head[u] , v , w &#125;; head[u] = eidx; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">dij</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> u , w;</span><br><span class="line">    <span class="built_in">memset</span>( dis , <span class="number">0x7f</span> , <span class="keyword">sizeof</span> dis );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">auto</span> v : ou[<span class="number">1</span>] )</span><br><span class="line">      Q.push( pii( dis[id( v , <span class="number">0</span> )] = <span class="number">0</span> , id( v , <span class="number">0</span> ) ) );</span><br><span class="line">    <span class="keyword">while</span>( !Q.empty() ) &#123;</span><br><span class="line">      u = Q.top().second , w = Q.top().first; Q.pop();</span><br><span class="line">      <span class="keyword">if</span>( dis[u] != w ) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> i = head[u] , v ; i ; i = edge[i].nxt )</span><br><span class="line">        <span class="keyword">if</span>( dis[v = edge[i].to] &gt; dis[u] + edge[i].val )</span><br><span class="line">          Q.push( pii( dis[v] = dis[u] + edge[i].val , v ) );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Ele</span> &#123;</span> <span class="keyword">int</span> u , v , w , d; &#125; dat[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">return</span> Trie::dfn[dat[<span class="built_in">abs</span>(a)].d] &lt; Trie::dfn[dat[<span class="built_in">abs</span>(b)].d]; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">work</span><span class="params">( <span class="keyword">int</span> u )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> a[N] , tot , pu[N] , pd[N] , su[N] , sd[N];</span><br><span class="line">  tot = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>( in[u].empty() || ou[u].empty() ) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">auto</span> v : in[u] ) a[++tot] = v;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">auto</span> v : ou[u] ) a[++tot] = -v;</span><br><span class="line">  sort( a + <span class="number">1</span> , a + <span class="number">1</span> + tot , cmp );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= tot ; ++i ) &#123;</span><br><span class="line">    pu[i] = ++nidx; pd[i] = ++nidx;</span><br><span class="line">    su[i] = ++nidx; sd[i] = ++nidx;</span><br><span class="line">    <span class="keyword">if</span>( i != <span class="number">1</span> ) &#123;</span><br><span class="line">      Dijkstra::addedge( pu[i - <span class="number">1</span>] , pu[i] , <span class="number">0</span> );</span><br><span class="line">      Dijkstra::addedge( pd[i - <span class="number">1</span>] , pd[i] , <span class="number">0</span> );</span><br><span class="line">      Dijkstra::addedge( su[i] , su[i - <span class="number">1</span>] , <span class="number">0</span> );</span><br><span class="line">      Dijkstra::addedge( sd[i] , sd[i - <span class="number">1</span>] , <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( a[i] &gt; <span class="number">0</span> ) Dijkstra::addedge( id( a[i] , <span class="number">1</span> ) , pu[i] , <span class="number">0</span> ) , Dijkstra::addedge( id( a[i] , <span class="number">1</span> ) , su[i] , <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">else</span> a[i] = -a[i] , Dijkstra::addedge( pd[i] , id( a[i] , <span class="number">0</span> ) , <span class="number">0</span> ) , Dijkstra::addedge( sd[i] , id( a[i] , <span class="number">0</span> ) , <span class="number">0</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , tmp ; i &lt; tot ; ++i ) &#123;</span><br><span class="line">    tmp = Trie::cost( dat[a[i]].d , dat[a[i + <span class="number">1</span>]].d );</span><br><span class="line">    Dijkstra::addedge( pu[i] , pd[i + <span class="number">1</span>] , tmp );</span><br><span class="line">    Dijkstra::addedge( su[i + <span class="number">1</span>] , sd[i] , tmp );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>,&amp;n,&amp;m,&amp;k); Dijkstra::init(); nidx = id( m , <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) in[i].clear() , ou[i].clear();</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= m ; ++i ) &#123;</span><br><span class="line">    _w = <span class="built_in">scanf</span>(<span class="string">"%d%d%d%d"</span>,&amp;dat[i].u,&amp;dat[i].v,&amp;dat[i].w,&amp;dat[i].d);</span><br><span class="line">    in[dat[i].v].push_back( i );</span><br><span class="line">    ou[dat[i].u].push_back( i );</span><br><span class="line">    Dijkstra::addedge( id( i , <span class="number">0</span> ) , id( i , <span class="number">1</span> ) , dat[i].w );</span><br><span class="line">  &#125; Trie::init();</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= n ; ++i ) work( i );</span><br><span class="line">  Dijkstra::dij();</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> , ans ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    ans = INF * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">auto</span> v : in[i] )</span><br><span class="line">      ans = min( ans , Dijkstra::dis[id( v , <span class="number">1</span> )] );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,ans);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> T;</span><br><span class="line">  _w = <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T);</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-遗忘的集合"><a href="https://loj.ac/problem/2271" target="_blank" rel="noopener">[SDOI2017] 遗忘的集合</a></h5>
<p>令 <span class="math inline">\(G(x) = \sum_{i}[i \in S]x^i\)</span> , 于是 <span class="math inline">\(F(x) = \exp(G(x))\)</span> , 那么 <span class="math inline">\(G(x) = \ln(F(x))\)</span> 对于 <span class="math inline">\(\ln(F(x))\)</span> 这是唯一的 , 所以字典序是个无用条件 , 由于模数不是 <span class="math inline">\(\rm NTT\)</span> 模数 , 需要用 <span class="math inline">\(\rm MTT\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">read</span>( <span class="title">T</span> &amp; <span class="title">x</span> ) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> lol;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">8e5</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> PI = <span class="built_in">acos</span>( <span class="number">-1.0</span> );</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Num</span> &#123;</span></span><br><span class="line">  <span class="keyword">double</span> x , y;</span><br><span class="line">  Num() &#123;&#125;</span><br><span class="line">  Num( <span class="keyword">double</span> _x , <span class="keyword">double</span> _y ):x( _x ) , y( _y ) &#123;&#125;</span><br><span class="line">  Num <span class="keyword">operator</span> + ( <span class="keyword">const</span> Num &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Num( x + rhs.x , y + rhs.y ); &#125;</span><br><span class="line">  Num <span class="keyword">operator</span> - ( <span class="keyword">const</span> Num &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Num( x - rhs.x , y - rhs.y ); &#125;</span><br><span class="line">  Num <span class="keyword">operator</span> * ( <span class="keyword">const</span> Num &amp; rhs ) <span class="keyword">const</span> &#123; <span class="keyword">return</span> Num( x * rhs.x - y * rhs.y , x * rhs.y + y * rhs.x ); &#125;</span><br><span class="line">  <span class="function">Num <span class="title">Conj</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> Num( x , -y ); &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="keyword">operator</span> = ( <span class="keyword">const</span> <span class="keyword">double</span> &amp; rhs ) &#123; x = rhs , y = <span class="number">0</span>; &#125;</span><br><span class="line">&#125; WN[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> r[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FFT</span><span class="params">( Num * f , <span class="keyword">int</span> n , <span class="keyword">int</span> flag )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Num x , y;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; n ; ++i ) <span class="keyword">if</span>( i &lt; r[i] ) swap( f[i] , f[r[i]] );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> mid = <span class="number">1</span> , l = <span class="number">0</span> ; mid &lt; n ; mid &lt;&lt;= <span class="number">1</span> , ++l ) &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; i += ( mid &lt;&lt; <span class="number">1</span> ) ) &#123;</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; mid ; ++j ) &#123;</span><br><span class="line">        x = f[i + j] , y = f[i + j + mid] * ( flag == <span class="number">1</span> ? WN[( n &gt;&gt; l ) * j] : WN[( n &gt;&gt; l ) * j].Conj() );</span><br><span class="line">        f[i + j] = x + y;</span><br><span class="line">        f[i + j + mid] = x - y;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>( flag == <span class="number">-1</span> ) &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; ++i )</span><br><span class="line">      f[i].x /= n , f[i].y /= n;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mod;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">return</span> a + b &gt;= mod ? a + b - mod : a + b; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; <span class="keyword">return</span> a - b &lt; <span class="number">0</span> ? a - b + mod : a - b; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod;</span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Num A[N] , B[N] , C[N] , D[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MTT</span><span class="params">( <span class="keyword">int</span> * f , <span class="keyword">int</span> * g , <span class="keyword">int</span> * h , <span class="keyword">int</span> n , <span class="keyword">int</span> m , <span class="keyword">int</span> k = <span class="number">-1</span> )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Num a , b , c , d;</span><br><span class="line">  <span class="keyword">static</span> lol s1 , s2 , s3 , s4;</span><br><span class="line">  <span class="keyword">if</span>( !~k ) k = n + m;</span><br><span class="line">  <span class="keyword">int</span> lim = <span class="number">1</span> , l = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">while</span>( lim &lt;= n + m ) lim &lt;&lt;= <span class="number">1</span> , ++l;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; lim ; ++i ) r[i] = ( r[i &gt;&gt; <span class="number">1</span>] &gt;&gt; <span class="number">1</span> ) | ( (i&amp;<span class="number">1</span>) &lt;&lt; l );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; lim ; ++i ) WN[i] = Num( <span class="built_in">cos</span>( PI * i / lim ) , <span class="built_in">sin</span>( PI * i / lim ) );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= n ; ++i ) A[i] = Num( f[i] &amp; <span class="number">32767</span> , f[i] &gt;&gt; <span class="number">15</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= m ; ++i ) B[i] = Num( g[i] &amp; <span class="number">32767</span> , g[i] &gt;&gt; <span class="number">15</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = n + <span class="number">1</span> ; i &lt; lim ; ++i ) A[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = m + <span class="number">1</span> ; i &lt; lim ; ++i ) B[i] = <span class="number">0</span>;</span><br><span class="line">  FFT( A , lim , <span class="number">1</span> ) , FFT( B , lim , <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> , j ; i &lt; lim ; ++i ) &#123;</span><br><span class="line">    j = ( lim - i ) &amp; ( lim - <span class="number">1</span> );</span><br><span class="line">    a = ( A[i] + A[j].Conj() ) * Num( <span class="number">0.5</span> , <span class="number">0</span> );</span><br><span class="line">    b = ( A[i] - A[j].Conj() ) * Num( <span class="number">0</span> , <span class="number">-0.5</span> );</span><br><span class="line">    c = ( B[i] + B[j].Conj() ) * Num( <span class="number">0.5</span> , <span class="number">0</span> );</span><br><span class="line">    d = ( B[i] - B[j].Conj() ) * Num( <span class="number">0</span> , <span class="number">-0.5</span> );</span><br><span class="line">    C[i] = a * c + a * d * Num( <span class="number">0</span> , <span class="number">1</span> );</span><br><span class="line">    D[i] = b * c + b * d * Num( <span class="number">0</span> , <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  FFT( C , lim , <span class="number">-1</span> ) , FFT( D , lim , <span class="number">-1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= k ; ++i ) &#123;</span><br><span class="line">    s1 = ((lol)( C[i].x + <span class="number">0.5</span> )) % mod;</span><br><span class="line">    s2 = ((lol)( C[i].y + <span class="number">0.5</span> )) % mod;</span><br><span class="line">    s3 = ((lol)( D[i].x + <span class="number">0.5</span> )) % mod;</span><br><span class="line">    s4 = ((lol)( D[i].y + <span class="number">0.5</span> )) % mod;</span><br><span class="line">    h[i] = ( s1 + ( ( s2 + s3 ) &lt;&lt; <span class="number">15</span> ) + ( s4 &lt;&lt; <span class="number">30</span> ) ) % mod;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> tmpg[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Inv</span><span class="params">( <span class="keyword">int</span> * f , <span class="keyword">int</span> * g , <span class="keyword">int</span> _n )</span> </span>&#123;</span><br><span class="line">  ++_n; g[<span class="number">0</span>] = fpow( f[<span class="number">0</span>] , mod - <span class="number">2</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> n = <span class="number">1</span> ; n &lt; _n * <span class="number">2</span> ; n &lt;&lt;= <span class="number">1</span> ) &#123;</span><br><span class="line">    MTT( f , g , tmpg , n - <span class="number">1</span> , n - <span class="number">1</span> );</span><br><span class="line">    MTT( tmpg , g , tmpg , n - <span class="number">1</span> , n - <span class="number">1</span> );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> , t = min( n , _n ) ; i &lt; t ; ++i )</span><br><span class="line">      g[i] = mns( pls( g[i] , g[i] ) , tmpg[i] );</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> df[N] , invf[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Ln</span><span class="params">( <span class="keyword">int</span> * f , <span class="keyword">int</span> * g , <span class="keyword">int</span> _n )</span> </span>&#123;</span><br><span class="line">  Inv( f , invf , _n );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = _n ; i ; --i ) df[i - <span class="number">1</span>] = <span class="number">1L</span>L * f[i] * i % mod;</span><br><span class="line">  df[_n] = <span class="number">0</span>; MTT( df , invf , g , _n , _n , _n );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = _n ; i ; --i ) g[i] = <span class="number">1L</span>L * g[i - <span class="number">1</span>] * fpow( i , mod - <span class="number">2</span> ) % mod;</span><br><span class="line">  g[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n , m , f[N] , g[N] , prime[N] , prime_tot , ans[N] , mu[N];</span><br><span class="line"><span class="keyword">bool</span> vis[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  read( n ) , read( mod );</span><br><span class="line">  mu[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !vis[i] ) prime[++prime_tot] = i , mu[i] = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">1</span> ; j &lt;= prime_tot ; ++j ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( <span class="number">1L</span>L * i * prime[j] &gt; n ) <span class="keyword">break</span>;</span><br><span class="line">      vis[i * prime[j]] = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>( i % prime[j] ) mu[i * prime[j]] = -mu[i];</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) read( f[i] );</span><br><span class="line">  f[<span class="number">0</span>] = <span class="number">1</span>; Ln( f , g , n );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) g[i] = <span class="number">1L</span>L * g[i] * i % mod;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> j = i ; j &lt;= n ; j += i )</span><br><span class="line">      <span class="keyword">if</span>( mu[j / i] == <span class="number">1</span> ) ans[j] += g[i];</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>( mu[j / i] == <span class="number">-1</span> ) ans[j] -= g[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i )</span><br><span class="line">    <span class="keyword">if</span>( ans[i] ) ++cnt;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; cnt &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i )</span><br><span class="line">    <span class="keyword">if</span>( ans[i] )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%d "</span>,i);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="sdoi2017-文本校正"><a href="https://loj.ac/problem/2272" target="_blank" rel="noopener">[SDOI2017] 文本校正</a></h5>
<p>总共 <span class="math inline">\(3!\)</span> 种情况 , 逐个考虑</p>
<p>对于 <span class="math inline">\(1,2,3\)</span> , 直接匹配</p>
<p>对于 <span class="math inline">\(2,3,1\)</span> 和 <span class="math inline">\(3,1,2\)</span> , 就是枚举一个分界点 , <span class="math inline">\(O(n)\)</span> 哈希</p>
<p>对于 <span class="math inline">\(3,2,1\)</span> , 如果 <span class="math inline">\(s = ab\)</span> , 其中 <span class="math inline">\(a,b\)</span> 都是回文串 , 则称 <span class="math inline">\(s\)</span> 为双回文串 , 双回文可以拆成 <span class="math inline">\(ab\)</span> , 其中 <span class="math inline">\(a\)</span> 是 <span class="math inline">\(s\)</span> 的最长回文前缀或 <span class="math inline">\(b\)</span> 是 <span class="math inline">\(s\)</span> 的最长回文后缀. 将 <span class="math inline">\(T\)</span> 串反过来插入 <span class="math inline">\(S\)</span> 串 , 也就是 <span class="math inline">\(s_1t_ns_2t_{n-1}\dots s_{n-1}t_2s_nt_1\)</span> , 如果 <span class="math inline">\(T\)</span> 串满足 <span class="math inline">\(3,2,1\)</span> 那么新串一定是由三个回文串构成的 , 并且每个回文串长度为偶数 , 于是直接 <span class="math inline">\(\rm manacher\)</span> 处理一下 , 枚举第一个回文串的长度 , 后面判断一下是否是双回文串 , 找出每个点的最长回文前缀即可</p>
<p>对于 <span class="math inline">\(2,1,3\)</span> 和 <span class="math inline">\(1,3,2\)</span> , 两种情况相同 , 都是有个公共前 / 后缀 , 剩下找个分界点</p>
<p>以 <span class="math inline">\(1,3,2\)</span> 为例 , 从大到小枚举 <span class="math inline">\(1\)</span> 的长度 , 每次 <span class="math inline">\(2,3\)</span> 都会增加一个字符.</p>
<p>接下来的问题是 , 求出 <span class="math inline">\(2\)</span> 的最大长度 , 这个可以用 <span class="math inline">\(\rm kmp\)</span> , 和 <span class="math inline">\(S\)</span> 匹配 , 每次可以找出 <span class="math inline">\(2,3\)</span> 和 <span class="math inline">\(S\)</span> 后缀的最长匹配 , 这就是 <span class="math inline">\(2\)</span> 的最长长度. 同时 <span class="math inline">\(S\)</span> 也和 <span class="math inline">\(T\)</span> 匹配 , 每次可以找出 <span class="math inline">\(3,2\)</span> 和 <span class="math inline">\(T\)</span> 后缀的最长匹配 , 判断一下就行了</p>
<p>为什么是对的 , 对于 <span class="math inline">\(3,2\)</span> 和 <span class="math inline">\(2,3\)</span> , 仿照上面翻转后交叉 , 是一个双回文串 , 找 <span class="math inline">\(2\)</span> 的最长长度就是找最长回文后缀 , <span class="math inline">\(3\)</span> 同理 , 于是剩下一部分一定是个合法的回文串 , 于是就只用找最长前后缀就行了 , 不用跳 <span class="math inline">\(\rm next\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> IO &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> IN_LEN = <span class="number">1</span> &lt;&lt; <span class="number">18</span> | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[IN_LEN] , *s , *t;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Getchar</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123; <span class="keyword">return</span> s == t &amp;&amp; ( t = ( s = buf ) + fread( buf , <span class="number">1</span> , IN_LEN , <span class="built_in">stdin</span> ) ) , s == t ? <span class="number">-1</span> : *s++; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">( <span class="keyword">int</span> &amp; x )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c , f; c = Getchar() , x = f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span> ) &#123; <span class="keyword">if</span>( c == <span class="string">'-'</span> ) f = <span class="number">1</span>; c = Getchar(); &#125;</span><br><span class="line">    <span class="keyword">while</span>( c &lt;= <span class="string">'9'</span> &amp;&amp; c &gt;= <span class="string">'0'</span> ) x = x * <span class="number">10</span> + c - <span class="number">48</span> , c = Getchar();</span><br><span class="line">    x = f ? -x : x;</span><br><span class="line">  &#125; </span><br><span class="line">&#125; <span class="keyword">using</span> IO::read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">2e6</span> + <span class="number">55</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">1e9</span> + <span class="number">9</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> base = <span class="number">131</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">pls</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">mns</span><span class="params">( <span class="keyword">int</span> a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; <span class="keyword">return</span> a + ( a &gt;&gt; <span class="number">31</span> &amp; mod ); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">inc</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a += b - mod; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dec</span><span class="params">( <span class="keyword">int</span> &amp; a , <span class="keyword">int</span> b )</span> </span>&#123; a -= b; a += a &gt;&gt; <span class="number">31</span> &amp; mod; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">fpow</span><span class="params">( <span class="keyword">int</span> b , <span class="keyword">int</span> k )</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>( k ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( k &amp; <span class="number">1</span> ) res = <span class="number">1L</span>L * res * b % mod; </span><br><span class="line">    b = <span class="number">1L</span>L * b * b % mod; k &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> S[N] , T[N] , ST[N] , n , m , Pow[N];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KMP</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> nxt[N] , str[N];</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">int</span> * s , <span class="keyword">int</span> n )</span> </span>&#123;</span><br><span class="line">    nxt[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>( str + <span class="number">1</span> , s + <span class="number">1</span> , <span class="keyword">sizeof</span>( <span class="keyword">int</span> ) * n ); str[n + <span class="number">1</span>] = m + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> , k = <span class="number">0</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">      <span class="keyword">while</span>( k &amp;&amp; str[k + <span class="number">1</span>] != str[i] ) k = nxt[k];</span><br><span class="line">      <span class="keyword">if</span>( str[k + <span class="number">1</span>] == str[i] ) ++k;</span><br><span class="line">      nxt[i] = k;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> &amp; <span class="title">match</span><span class="params">( <span class="keyword">int</span> &amp; now , <span class="keyword">int</span> c )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>( now &amp;&amp; str[now + <span class="number">1</span>] != c ) now = nxt[now];</span><br><span class="line">    <span class="keyword">if</span>( str[now + <span class="number">1</span>] == c ) ++now;</span><br><span class="line">    <span class="keyword">return</span> now;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; kmp[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Hash</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> hs[N] , str[N];</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">int</span> * s , <span class="keyword">int</span> n )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>( str + <span class="number">1</span> , s + <span class="number">1</span> , <span class="keyword">sizeof</span>( <span class="keyword">int</span> ) * n ); str[n + <span class="number">1</span>] = m + <span class="number">1</span> , hs[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) hs[i] = ( <span class="number">1L</span>L * hs[i - <span class="number">1</span>] * base + str[i] ) % mod;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">val</span><span class="params">( <span class="keyword">int</span> l , <span class="keyword">int</span> r )</span> </span>&#123; <span class="keyword">return</span> mns( hs[r] , <span class="number">1L</span>L * hs[l - <span class="number">1</span>] * Pow[r - l + <span class="number">1</span>] % mod ); &#125;</span><br><span class="line">&#125; hs[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Manacher</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> f[N] , str[N]; <span class="comment">// f[i] -&gt; str( i - f[i] + 1 , i + f[i] ) is pal</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">( <span class="keyword">int</span> * s , <span class="keyword">int</span> n )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>( str + <span class="number">1</span> , s + <span class="number">1</span> , <span class="keyword">sizeof</span>( <span class="keyword">int</span> ) * n ); str[n + <span class="number">1</span>] = m + <span class="number">1</span>; </span><br><span class="line">    str[<span class="number">0</span>] = m + <span class="number">2</span>; <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> , r = <span class="number">0</span> , k = <span class="number">0</span> ; i &lt;= n ; ++i ) &#123;</span><br><span class="line">      f[i] = r &gt; i ? min( r - i , f[<span class="number">2</span> * k - i] ) : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span>( str[i - f[i]] == str[i + f[i] + <span class="number">1</span>] ) ++f[i];</span><br><span class="line">      <span class="keyword">if</span>( i + f[i] &gt; r ) r = i + f[i] , k = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; pal;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  read( n ) , read( m ); <span class="keyword">int</span> _flag123 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) read( S[i] );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) read( T[i] ) , _flag123 &amp;= T[i] == S[i];</span><br><span class="line">  <span class="keyword">if</span>( _flag123 ) <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"YES\n1 1\n2 2\n3 %d\n"</span>,n),<span class="keyword">void</span>();</span><br><span class="line"></span><br><span class="line">  hs[<span class="number">0</span>].init( S , n ); hs[<span class="number">1</span>].init( T , n );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; n ; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( hs[<span class="number">1</span>].val( <span class="number">1</span> , i ) == hs[<span class="number">0</span>].val( n - i + <span class="number">1</span> , n ) &amp;&amp; hs[<span class="number">1</span>].val( i + <span class="number">1</span> , n ) == hs[<span class="number">0</span>].val( <span class="number">1</span> , n - i ) ) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"YES"</span>);</span><br><span class="line">      <span class="keyword">if</span>( i == <span class="number">1</span> ) <span class="built_in">printf</span>(<span class="string">"2 2\n3 %d\n1 1\n"</span>,n);</span><br><span class="line">      <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"%d %d\n1 1\n2 %d\n"</span>,i+<span class="number">1</span>,n,i);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  kmp[<span class="number">0</span>].init( S , n ); kmp[<span class="number">1</span>].init( T , n );</span><br><span class="line">  <span class="keyword">int</span> cur1 = <span class="number">0</span> , cur2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; n ; ++i ) &#123;</span><br><span class="line">    kmp[<span class="number">0</span>].match( cur1 , T[i] );</span><br><span class="line">    kmp[<span class="number">1</span>].match( cur2 , S[i] );</span><br><span class="line">    <span class="keyword">if</span>( hs[<span class="number">0</span>].val( i + <span class="number">1</span> , n ) == hs[<span class="number">1</span>].val( i + <span class="number">1</span> , n ) ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( cur1 &amp;&amp; hs[<span class="number">0</span>].val( cur1 + <span class="number">1</span> , i ) == hs[<span class="number">1</span>].val( <span class="number">1</span> , i - cur1 ) )</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"YES\n%d %d\n%d %d\n%d %d\n"</span>,i-cur1+<span class="number">1</span>,i,<span class="number">1</span>,i-cur1,i+<span class="number">1</span>,n),<span class="keyword">void</span>();</span><br><span class="line">      <span class="keyword">if</span>( cur2 &amp;&amp; hs[<span class="number">1</span>].val( cur2 + <span class="number">1</span> , i ) == hs[<span class="number">0</span>].val( <span class="number">1</span> , i - cur2 ) )</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"YES\n%d %d\n%d %d\n%d %d\n"</span>,cur2+<span class="number">1</span>,i,<span class="number">1</span>,cur2,i+<span class="number">1</span>,n),<span class="keyword">void</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>( ST + <span class="number">1</span> , S + <span class="number">1</span> , <span class="keyword">sizeof</span>( <span class="keyword">int</span> ) * n ); </span><br><span class="line">  reverse( ST + <span class="number">1</span> , ST + <span class="number">1</span> + n ); kmp[<span class="number">0</span>].init( ST , n );</span><br><span class="line">  <span class="built_in">memcpy</span>( ST + <span class="number">1</span> , T + <span class="number">1</span> , <span class="keyword">sizeof</span>( <span class="keyword">int</span> ) * n ); </span><br><span class="line">  reverse( ST + <span class="number">1</span> , ST + <span class="number">1</span> + n ); kmp[<span class="number">1</span>].init( ST , n );</span><br><span class="line">  cur1 = <span class="number">0</span> , cur2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = n ; i &gt; <span class="number">1</span> ; --i ) &#123;</span><br><span class="line">    kmp[<span class="number">0</span>].match( cur1 , T[i] );</span><br><span class="line">    kmp[<span class="number">1</span>].match( cur2 , S[i] );</span><br><span class="line">    <span class="keyword">if</span>( hs[<span class="number">0</span>].val( <span class="number">1</span> , i - <span class="number">1</span> ) == hs[<span class="number">1</span>].val( <span class="number">1</span> , i - <span class="number">1</span> ) ) &#123;</span><br><span class="line">      <span class="keyword">if</span>( cur1 &amp;&amp; hs[<span class="number">0</span>].val( i , n - cur1 ) == hs[<span class="number">1</span>].val( i + cur1 , n ) )</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"YES\n%d %d\n%d %d\n%d %d\n"</span>,<span class="number">1</span>,i<span class="number">-1</span>,i+cur1,n,i,i+cur1<span class="number">-1</span>),<span class="keyword">void</span>();</span><br><span class="line">      <span class="keyword">if</span>( cur2 &amp;&amp; hs[<span class="number">1</span>].val( i , n - cur2 ) == hs[<span class="number">0</span>].val( i + cur2 , n ) ) </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"YES\n%d %d\n%d %d\n%d %d\n"</span>,<span class="number">1</span>,i<span class="number">-1</span>,n-cur2+<span class="number">1</span>,n,i,n-cur2),<span class="keyword">void</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> pre[N] , suf[N] , S[N] , tp , lim; <span class="comment">// longest pal prefix , longest pal suffix</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) ST[( i &lt;&lt; <span class="number">1</span> ) - <span class="number">1</span>] = ::S[n - i + <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= n ; ++i ) ST[i &lt;&lt; <span class="number">1</span>] = T[i];</span><br><span class="line">  pal.init( ST , lim = ( n &lt;&lt; <span class="number">1</span> ) );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= lim ; ++i ) pre[i] = suf[i] = i;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt;= lim ; ++i ) &#123;</span><br><span class="line">    pre[i - pal.f[i] + <span class="number">1</span>] = max( pre[i - pal.f[i] + <span class="number">1</span>] , i + pal.f[i] );</span><br><span class="line">    suf[i + pal.f[i]] = min( suf[i + pal.f[i]] , i - pal.f[i] + <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  tp = <span class="number">0</span>; <span class="keyword">for</span>( <span class="keyword">int</span> i = lim ; i ; --i ) <span class="keyword">if</span>( i + pal.f[i] == lim ) S[++tp] = i - pal.f[i] + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> ; i &lt;= lim ; ++i ) pre[i] = max( pre[i] , pre[i - <span class="number">1</span>] - <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = lim - <span class="number">1</span> ; i ; --i ) suf[i] = min( suf[i] , suf[i + <span class="number">1</span>] + <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">auto</span> judge = []( <span class="keyword">const</span> <span class="keyword">int</span> &amp; l , <span class="keyword">const</span> <span class="keyword">int</span> &amp; r ) -&gt; <span class="keyword">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( l &gt; r ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int</span> len = ( r - l + <span class="number">1</span> ); <span class="keyword">if</span>( len &amp; <span class="number">1</span> ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    len &gt;&gt;= <span class="number">1</span>; <span class="keyword">int</span> mid = ( l + len - <span class="number">1</span> );</span><br><span class="line">    <span class="keyword">if</span>( pal.f[mid] &gt;= len ) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">2</span> , r , l ; i &lt;= lim ; i += <span class="number">2</span> ) </span><br><span class="line">    <span class="keyword">if</span>( suf[i] == <span class="number">1</span> ) &#123;</span><br><span class="line">      l = i + <span class="number">1</span> , r = pre[i + <span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span>( judge( r + <span class="number">1</span> , lim ) ) <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"YES\n%d %d\n%d %d\n%d %d\n"</span>,(r+<span class="number">2</span>)/<span class="number">2</span>,lim/<span class="number">2</span>,(l+<span class="number">1</span>)/<span class="number">2</span>,r/<span class="number">2</span>,<span class="number">1</span>,i/<span class="number">2</span>),<span class="keyword">void</span>();</span><br><span class="line">      <span class="keyword">while</span>( tp &amp;&amp; S[tp] &lt;= i ) --tp;</span><br><span class="line">      <span class="keyword">if</span>( tp ) &#123;</span><br><span class="line">        l = S[tp] , r = lim;</span><br><span class="line">        <span class="keyword">if</span>( judge( i + <span class="number">1</span> , l - <span class="number">1</span> ) ) <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"YES\n%d %d\n%d %d\n%d %d\n"</span>,(l+<span class="number">1</span>)/<span class="number">2</span>,r/<span class="number">2</span>,i/<span class="number">2</span>+<span class="number">1</span>,l/<span class="number">2</span>,<span class="number">1</span>,i/<span class="number">2</span>),<span class="keyword">void</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"NO"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">  Pow[<span class="number">0</span>] = <span class="number">1</span>; <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; N ; ++i ) Pow[i] = <span class="number">1L</span>L * Pow[i - <span class="number">1</span>] * base % mod;</span><br><span class="line">  <span class="keyword">int</span> T; read( T );</span><br><span class="line">  <span class="keyword">while</span>( T-- ) solve();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/11/Solutions/%E6%9D%82%E9%A2%98./" rel="prev" title="杂题">
      <i class="fa fa-chevron-left"></i> 杂题
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/12/Solutions/ZJOI2018-%E7%AE%80%E8%A6%81%E9%A2%98%E8%A7%A3/" rel="next" title="[ZJOI2018] 简要题解">
      [ZJOI2018] 简要题解 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-数字表格"><span class="nav-number">1.</span> <span class="nav-text">[SDOI2017] 数字表格</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-树点涂色"><span class="nav-number">2.</span> <span class="nav-text">[SDOI2017] 树点涂色</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-序列计数"><span class="nav-number">3.</span> <span class="nav-text">[SDOI2017] 序列计数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-新生舞会"><span class="nav-number">4.</span> <span class="nav-text">[SDOI2017] 新生舞会</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-硬币游戏"><span class="nav-number">5.</span> <span class="nav-text">[SDOI2017] 硬币游戏</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-相关分析"><span class="nav-number">6.</span> <span class="nav-text">[SDOI2017] 相关分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-龙与地下城"><span class="nav-number">7.</span> <span class="nav-text">[SDOI2017] 龙与地下城</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-苹果树"><span class="nav-number">8.</span> <span class="nav-text">[SDOI2017] 苹果树</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-切树游戏"><span class="nav-number">9.</span> <span class="nav-text">[SDOI2017] 切树游戏</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-天才黑客"><span class="nav-number">10.</span> <span class="nav-text">[SDOI2017] 天才黑客</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-遗忘的集合"><span class="nav-number">11.</span> <span class="nav-text">[SDOI2017] 遗忘的集合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sdoi2017-文本校正"><span class="nav-number">12.</span> <span class="nav-text">[SDOI2017] 文本校正</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Guyan</p>
  <div class="site-description" itemprop="description">水平低啊</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">113</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guyan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
